<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Texas Hold'em Online</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
:root{--gold:#c9a84c;--gold-light:#f0d080;--gold-dark:#8a6820;--felt:#1a4a2e;--felt-dark:#0d2e1c;--felt-light:#235c39;--red:#c0392b;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:radial-gradient(ellipse at 50% 50%,#1e5535 0%,#0a2010 100%);min-height:100vh;font-family:'Crimson Text',serif;color:#fff;overflow-x:hidden;}

.screen{display:none;min-height:100vh;flex-direction:column;align-items:center;padding:20px 16px 40px;overflow-y:auto;}
.screen.active{display:flex;}

.logo{font-family:'Cinzel',serif;font-size:clamp(20px,6vw,44px);font-weight:900;background:linear-gradient(135deg,#8a6820,#f0d080,#c9a84c,#f0d080,#8a6820);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:3px;text-align:center;margin:16px 0 4px;}
.logo-sub{font-family:'Cinzel',serif;font-size:11px;color:var(--gold);letter-spacing:6px;text-align:center;margin-bottom:16px;opacity:.7;}

.panel{background:linear-gradient(145deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(201,168,76,.3);border-radius:16px;padding:20px;width:100%;max-width:480px;margin-bottom:14px;}
.panel-title{font-family:'Cinzel',serif;font-size:11px;color:var(--gold);letter-spacing:3px;margin-bottom:16px;text-align:center;}
.field-label{font-size:11px;color:rgba(201,168,76,.7);letter-spacing:2px;font-family:'Cinzel',serif;margin-bottom:5px;display:block;}
.inp{width:100%;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:10px 14px;color:#fff;font-family:'Crimson Text',serif;font-size:15px;outline:none;margin-bottom:10px;}
.inp:focus{border-color:var(--gold);}
.inp::placeholder{color:rgba(255,255,255,.2);}
.num-inp{width:90px;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:8px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:13px;outline:none;text-align:center;}
.row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.gap-row{display:flex;gap:8px;align-items:center;}
.btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--gold-dark),var(--gold),var(--gold-dark));border:none;border-radius:10px;color:#1a0a00;font-family:'Cinzel',serif;font-size:13px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-top:8px;}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn:active:not(:disabled){transform:scale(.98);}
.btn-sm{padding:9px 14px;background:rgba(201,168,76,.2);border:1px solid var(--gold);border-radius:8px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:11px;cursor:pointer;white-space:nowrap;flex-shrink:0;}
.btn-sm:active{transform:scale(.97);}
.msg{font-size:12px;text-align:center;padding:7px;border-radius:8px;margin-top:6px;min-height:16px;}
.ok{color:#0f0;}.err{color:#f88;}.info{color:#4af;}

/* æ¥ç¶šæ‰‹é †UI */
.step-box{background:rgba(0,0,0,.4);border:1px solid rgba(201,168,76,.2);border-radius:10px;padding:14px;margin-bottom:10px;}
.step-num{font-family:'Cinzel',serif;font-size:10px;color:var(--gold);letter-spacing:2px;margin-bottom:8px;}
.code-area{width:100%;background:rgba(0,0,0,.6);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:10px;color:#aef;font-family:monospace;font-size:11px;resize:none;outline:none;word-break:break-all;}
.copy-btn{width:100%;padding:8px;background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.4);border-radius:6px;color:var(--gold);font-family:'Cinzel',serif;font-size:10px;cursor:pointer;margin-top:6px;letter-spacing:1px;}
.paste-area{width:100%;background:rgba(0,0,0,.6);border:1px solid rgba(255,165,0,.3);border-radius:8px;padding:10px;color:#fff;font-family:monospace;font-size:11px;resize:none;outline:none;min-height:60px;}
.paste-area:focus{border-color:#fa0;}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;}
.badge-connected{background:rgba(0,200,0,.15);border:1px solid rgba(0,200,0,.3);color:#0f0;}
.badge-waiting{background:rgba(255,165,0,.15);border:1px solid rgba(255,165,0,.3);color:#fa0;}

/* ã‚²ãƒ¼ãƒ ç”»é¢ */
#screen-game{padding:10px;}
.table-felt{width:100%;max-width:700px;background:radial-gradient(ellipse at center,var(--felt-light) 0%,var(--felt) 60%,var(--felt-dark) 100%);border-radius:100px;border:5px solid var(--gold-dark);box-shadow:0 0 0 2px var(--gold),0 8px 40px rgba(0,0,0,.7),inset 0 0 40px rgba(0,0,0,.3);padding:20px 24px;display:flex;flex-direction:column;align-items:center;gap:8px;min-height:180px;margin:0 auto 10px;}
#community-cards{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
#pot-display{font-family:'Cinzel',serif;font-size:12px;color:var(--gold-light);background:rgba(0,0,0,.4);padding:4px 16px;border-radius:20px;border:1px solid rgba(201,168,76,.3);}
#phase-label{font-family:'Cinzel',serif;font-size:10px;letter-spacing:4px;color:rgba(255,255,255,.35);}
#players-area{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:6px;width:100%;max-width:700px;margin:0 auto 10px;}
.pseat{background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.2);border-radius:12px;padding:8px;text-align:center;position:relative;}
.pseat.myturn{border-color:var(--gold);background:rgba(201,168,76,.12);box-shadow:0 0 18px rgba(201,168,76,.3);}
.pseat.waiting{border-color:#fa0;animation:wp .9s infinite alternate;}
@keyframes wp{from{box-shadow:0 0 6px rgba(255,165,0,.2);}to{box-shadow:0 0 20px rgba(255,165,0,.5);}}
.pseat.folded{opacity:.4;}
.pseat.dealer::before{content:'D';position:absolute;top:-8px;left:-8px;width:19px;height:19px;background:var(--gold);color:#000;border-radius:50%;font-family:'Cinzel',serif;font-size:9px;font-weight:700;line-height:19px;text-align:center;}
.seat-name{font-family:'Cinzel',serif;font-size:10px;color:var(--gold-light);margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.seat-chips{font-size:11px;color:rgba(255,255,255,.65);}
.seat-bet{font-size:10px;color:#f0d080;min-height:14px;}
.seat-cards{display:flex;gap:3px;justify-content:center;margin-top:4px;}
.seat-st{font-size:9px;color:rgba(255,255,255,.35);min-height:12px;}
.card{width:36px;height:52px;background:#faf8f0;border-radius:4px;border:1px solid #ccc;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#1a1a1a;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,.4);}
.card.red{color:var(--red);}.card.back{background:linear-gradient(135deg,#1a3a6a,#0d1f40);border-color:var(--gold-dark);}
.card-r{font-size:12px;font-family:'Cinzel',serif;line-height:1;}.card-s{font-size:13px;line-height:1;}
.card.sm{width:28px;height:40px;}.card.sm .card-r{font-size:9px;}.card.sm .card-s{font-size:10px;}
#action-panel{width:100%;max-width:700px;margin:0 auto;background:rgba(0,0,0,.6);border:1px solid rgba(201,168,76,.25);border-radius:14px;padding:12px;}
#action-header{display:flex;justify-content:space-between;margin-bottom:10px;}
#action-who{font-family:'Cinzel',serif;font-size:12px;color:var(--gold-light);}
#action-info{font-size:11px;color:rgba(255,255,255,.45);}
#hand-display{display:flex;gap:8px;justify-content:center;margin-bottom:10px;}
.preset-row{display:flex;gap:4px;margin-bottom:6px;flex-wrap:wrap;}
.preset-btn{flex:1;min-width:44px;padding:4px 2px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25);border-radius:5px;color:var(--gold);font-family:'Cinzel',serif;font-size:8px;cursor:pointer;text-align:center;}
#raise-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
#raise-row label{font-size:10px;color:var(--gold);white-space:nowrap;font-family:'Cinzel',serif;}
#raise-input{flex:1;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.4);border-radius:7px;padding:7px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:14px;outline:none;text-align:center;}
#raise-slider{width:100%;margin-bottom:8px;accent-color:var(--gold);}
.btn-row{display:flex;gap:6px;flex-wrap:wrap;}
.abtn{flex:1;min-width:65px;padding:10px 4px;border:none;border-radius:8px;font-family:'Cinzel',serif;font-size:10px;cursor:pointer;font-weight:700;}
.abtn:active{transform:scale(.97);}
.a-fold{background:rgba(150,40,40,.8);color:#ffaaaa;border:1px solid rgba(200,60,60,.5);}
.a-check{background:rgba(40,100,180,.8);color:#aaddff;border:1px solid rgba(60,130,210,.5);}
.a-call{background:rgba(30,130,100,.8);color:#aaffdd;border:1px solid rgba(50,160,120,.5);}
.a-raise{background:rgba(180,120,20,.85);color:#fff5cc;border:1px solid rgba(201,168,76,.6);}
.a-allin{background:linear-gradient(135deg,#7a0000,#c00);color:#fff;border:1px solid #f00;}
#info-bar{width:100%;max-width:700px;margin:0 auto 6px;background:rgba(0,0,0,.5);border:1px solid rgba(255,165,0,.3);border-radius:10px;padding:8px;text-align:center;display:none;}
#info-bar.show{display:block;}
#info-bar-text{font-family:'Cinzel',serif;font-size:11px;color:#fa0;}
#msg-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;align-items:center;justify-content:center;padding:20px;}
#msg-overlay.show{display:flex;}
.msg-card{background:linear-gradient(145deg,#1a2a10,#0d1a08);border:2px solid var(--gold);border-radius:20px;padding:24px;text-align:center;max-width:440px;width:100%;}
.msg-title{font-family:'Cinzel',serif;font-size:18px;color:var(--gold-light);margin-bottom:10px;}
.msg-body{font-size:13px;color:rgba(255,255,255,.8);line-height:1.8;margin-bottom:14px;}
.msg-body .wn{color:var(--gold-light);font-size:15px;font-weight:600;}.msg-body .hn{color:#aaffaa;font-size:11px;}
.msg-cards{display:flex;gap:6px;justify-content:center;margin:8px 0;flex-wrap:wrap;}
.btn-next{padding:12px 28px;background:linear-gradient(135deg,var(--gold-dark),var(--gold));border:none;border-radius:10px;color:#1a0a00;font-family:'Cinzel',serif;font-size:12px;font-weight:700;cursor:pointer;}
</style>
</head>
<body>

<!-- ãƒ­ãƒ¼ãƒ«é¸æŠ -->
<div id="screen-role" class="screen active">
  <div class="logo">TEXAS HOLD'EM</div>
  <div class="logo-sub">ONLINE POKER Â· P2P</div>

  <div class="panel">
    <div class="panel-title">ã‚ãªãŸã®æƒ…å ±</div>
    <label class="field-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
    <input class="inp" id="my-name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1">
    <div class="row">
      <span style="font-size:12px;color:rgba(255,255,255,.5);">é–‹å§‹ãƒãƒƒãƒ—</span>
      <input class="num-inp" id="my-chips" value="1000">
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">ã‚²ãƒ¼ãƒ ã®é–‹å§‹æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="row">
      <span style="font-size:12px;color:rgba(255,255,255,.5);">SB</span>
      <input class="num-inp" id="room-sb" value="10">
    </div>
    <div class="row">
      <span style="font-size:12px;color:rgba(255,255,255,.5);">BB</span>
      <input class="num-inp" id="room-bb" value="20">
    </div>
    <button class="btn" id="btn-host" style="background:linear-gradient(135deg,#8a6820,#c9a84c);">ğŸ  ãƒ›ã‚¹ãƒˆã«ãªã‚‹ï¼ˆãƒ«ãƒ¼ãƒ ã‚’ä½œæˆï¼‰</button>
    <button class="btn" id="btn-guest" style="margin-top:8px;background:linear-gradient(135deg,#1a4a6a,#2a7aaa);">ğŸšª ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ </button>
  </div>
</div>

<!-- ãƒ›ã‚¹ãƒˆ: ã‚ªãƒ•ã‚¡ãƒ¼å…±æœ‰ -->
<div id="screen-host" class="screen">
  <div class="logo">TEXAS HOLD'EM</div>
  <div class="logo-sub">ãƒ›ã‚¹ãƒˆè¨­å®š</div>

  <div class="panel">
    <div class="step-box">
      <div class="step-num">STEP 1 â€” æ¥ç¶šã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</div>
      <textarea class="code-area" id="host-offer" rows="4" readonly placeholder="æ¥ç¶šã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆä¸­..."></textarea>
      <button class="copy-btn" id="copy-offer">ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
    <div class="step-box">
      <div class="step-num">STEP 2 â€” ã‚²ã‚¹ãƒˆã®è¿”ç­”ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘</div>
      <textarea class="paste-area" id="paste-answer" rows="3" placeholder="ã‚²ã‚¹ãƒˆã‹ã‚‰å—ã‘å–ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘..."></textarea>
      <button class="btn" id="btn-connect-answer" style="margin-top:8px;">æ¥ç¶šã™ã‚‹</button>
    </div>
    <div id="host-status" class="msg info">ã‚²ã‚¹ãƒˆã«æ¥ç¶šã‚³ãƒ¼ãƒ‰ã‚’é€ã£ã¦ãã ã•ã„</div>
  </div>
</div>

<!-- ã‚²ã‚¹ãƒˆ: ã‚¢ãƒ³ã‚µãƒ¼ -->
<div id="screen-guest" class="screen">
  <div class="logo">TEXAS HOLD'EM</div>
  <div class="logo-sub">ã‚²ã‚¹ãƒˆæ¥ç¶š</div>

  <div class="panel">
    <div class="step-box">
      <div class="step-num">STEP 1 â€” ãƒ›ã‚¹ãƒˆã®æ¥ç¶šã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘</div>
      <textarea class="paste-area" id="paste-offer" rows="3" placeholder="ãƒ›ã‚¹ãƒˆã‹ã‚‰å—ã‘å–ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘..."></textarea>
      <button class="btn" id="btn-process-offer" style="margin-top:8px;">æ¥ç¶šã‚³ãƒ¼ãƒ‰ã‚’å‡¦ç†</button>
    </div>
    <div id="guest-answer-box" style="display:none;">
      <div class="step-box">
        <div class="step-num">STEP 2 â€” è¿”ç­”ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ›ã‚¹ãƒˆã«é€ã‚‹</div>
        <textarea class="code-area" id="guest-answer" rows="4" readonly></textarea>
        <button class="copy-btn" id="copy-answer">ğŸ“‹ è¿”ç­”ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
    <div id="guest-status" class="msg info">ãƒ›ã‚¹ãƒˆã‹ã‚‰æ¥ç¶šã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã£ã¦ãã ã•ã„</div>
  </div>
</div>

<!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="screen-game" class="screen" style="padding:10px;align-items:stretch;">
  <div id="players-area"></div>
  <div class="table-felt">
    <div id="phase-label">WAITING</div>
    <div id="community-cards"></div>
    <div id="pot-display">POT: 0</div>
  </div>
  <div id="info-bar"><div id="info-bar-text"></div></div>
  <div id="action-panel" style="display:none;">
    <div id="action-header"><div id="action-who"></div><div id="action-info"></div></div>
    <div id="hand-display"></div>
    <div class="preset-row" id="preset-row"></div>
    <div id="raise-row"><label>BET/RAISE:</label><input type="number" id="raise-input"></div>
    <input type="range" id="raise-slider">
    <div class="btn-row" id="btn-row"></div>
  </div>
</div>

<div id="msg-overlay">
  <div class="msg-card">
    <div class="msg-title" id="msg-title"></div>
    <div class="msg-cards" id="msg-cards"></div>
    <div class="msg-body" id="msg-body"></div>
    <button class="btn-next" id="msg-btn">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰</button>
  </div>
</div>

<script>
(function(){
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WebRTC P2P æ¥ç¶šï¼ˆã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ãªã—ãƒ»æ‰‹å‹•ã‚³ãƒ¼ãƒ‰äº¤æ›ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var pc, dc;
var isHost = false;
var myName = '', myChips = 1000, SB = 10, BB = 20;
var onMsgCb = null;
var ICE_TIMEOUT = 4000; // ms

var ICE_SERVERS = [
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'}
];

function createPC(){
  pc = new RTCPeerConnection({iceServers: ICE_SERVERS});
  pc.oniceconnectionstatechange = function(){
    var s = pc.iceConnectionState;
    if(s === 'connected' || s === 'completed') onConnected();
    if(s === 'failed' || s === 'disconnected') onDisconnected();
  };
}

// ãƒ›ã‚¹ãƒˆ: ã‚ªãƒ•ã‚¡ãƒ¼ç”Ÿæˆ
function hostCreateOffer(cb){
  createPC();
  dc = pc.createDataChannel('game');
  setupDC(dc);
  pc.createOffer().then(function(offer){
    return pc.setLocalDescription(offer);
  }).then(function(){
    // ICEå€™è£œãŒé›†ã¾ã‚‹ã¾ã§å¾…ã¤
    return new Promise(function(resolve){
      var done = false;
      pc.onicecandidate = function(e){
        if(!e.candidate && !done){ done=true; resolve(); }
      };
      setTimeout(function(){ if(!done){done=true;resolve();} }, ICE_TIMEOUT);
    });
  }).then(function(){
    cb(btoa(JSON.stringify(pc.localDescription)));
  });
}

// ã‚²ã‚¹ãƒˆ: ã‚ªãƒ•ã‚¡ãƒ¼å—ä¿¡â†’ã‚¢ãƒ³ã‚µãƒ¼ç”Ÿæˆ
function guestProcessOffer(offerB64, cb){
  createPC();
  pc.ondatachannel = function(e){
    dc = e.channel;
    setupDC(dc);
  };
  var offer = JSON.parse(atob(offerB64));
  pc.setRemoteDescription(offer).then(function(){
    return pc.createAnswer();
  }).then(function(answer){
    return pc.setLocalDescription(answer);
  }).then(function(){
    return new Promise(function(resolve){
      var done = false;
      pc.onicecandidate = function(e){
        if(!e.candidate && !done){ done=true; resolve(); }
      };
      setTimeout(function(){ if(!done){done=true;resolve();} }, ICE_TIMEOUT);
    });
  }).then(function(){
    cb(btoa(JSON.stringify(pc.localDescription)));
  });
}

// ãƒ›ã‚¹ãƒˆ: ã‚¢ãƒ³ã‚µãƒ¼å—ä¿¡
function hostProcessAnswer(answerB64){
  var answer = JSON.parse(atob(answerB64));
  pc.setRemoteDescription(answer).catch(function(e){
    document.getElementById('host-status').textContent = 'ã‚¨ãƒ©ãƒ¼: '+e.message;
    document.getElementById('host-status').className = 'msg err';
  });
}

function setupDC(channel){
  channel.onopen = function(){ onConnected(); };
  channel.onmessage = function(e){
    try{
      var d = JSON.parse(e.data);
      if(onMsgCb) onMsgCb(d);
    }catch(ex){}
  };
  channel.onerror = function(e){ console.error('DC error', e); };
}

function sendMsg(obj){
  if(dc && dc.readyState === 'open'){
    dc.send(JSON.stringify(obj));
  }
}

function onConnected(){
  showScreen('screen-game');
  if(isHost) startRound();
  else showInfo('ãƒ›ã‚¹ãƒˆã®ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...');
}
function onDisconnected(){
  showInfo('âš  æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI: ãƒ­ãƒ¼ãƒ«é¸æŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btn-host').addEventListener('click', function(){
  myName = document.getElementById('my-name').value.trim() || 'ãƒ›ã‚¹ãƒˆ';
  myChips = +document.getElementById('my-chips').value || 1000;
  SB = +document.getElementById('room-sb').value || 10;
  BB = +document.getElementById('room-bb').value || 20;
  isHost = true;
  setupGame([
    {name:myName, chips:myChips, pid:'host', isMe:true},
    {name:'ã‚²ã‚¹ãƒˆ', chips:1000, pid:'guest', isMe:false}
  ]);
  showScreen('screen-host');
  document.getElementById('host-offer').value = 'ç”Ÿæˆä¸­...';
  hostCreateOffer(function(offerB64){
    document.getElementById('host-offer').value = offerB64;
    document.getElementById('host-status').textContent = 'ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚²ã‚¹ãƒˆã«é€ã£ã¦ãã ã•ã„';
  });
});

document.getElementById('btn-guest').addEventListener('click', function(){
  myName = document.getElementById('my-name').value.trim() || 'ã‚²ã‚¹ãƒˆ';
  myChips = +document.getElementById('my-chips').value || 1000;
  isHost = false;
  showScreen('screen-guest');
});

document.getElementById('copy-offer').addEventListener('click', function(){
  var t = document.getElementById('host-offer').value;
  try{navigator.clipboard.writeText(t);}catch(e){}
  this.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
  setTimeout(function(){document.getElementById('copy-offer').textContent='ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼';},2000);
});

document.getElementById('btn-connect-answer').addEventListener('click', function(){
  var raw = document.getElementById('paste-answer').value.trim();
  if(!raw){document.getElementById('host-status').textContent='ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„';return;}
  try{
    hostProcessAnswer(raw);
    document.getElementById('host-status').textContent = 'æ¥ç¶šä¸­...';
    document.getElementById('host-status').className = 'msg info';
  }catch(e){
    document.getElementById('host-status').textContent = 'ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰ã§ã™';
    document.getElementById('host-status').className = 'msg err';
  }
});

document.getElementById('btn-process-offer').addEventListener('click', function(){
  var raw = document.getElementById('paste-offer').value.trim();
  if(!raw){document.getElementById('guest-status').textContent='ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„';return;}
  document.getElementById('guest-status').textContent = 'å‡¦ç†ä¸­...';
  try{
    guestProcessOffer(raw, function(answerB64){
      document.getElementById('guest-answer').value = answerB64;
      document.getElementById('guest-answer-box').style.display = 'block';
      document.getElementById('guest-status').textContent = 'è¿”ç­”ã‚³ãƒ¼ãƒ‰ã‚’ãƒ›ã‚¹ãƒˆã«é€ã£ã¦ãã ã•ã„';
      document.getElementById('guest-status').className = 'msg ok';
    });
  }catch(e){
    document.getElementById('guest-status').textContent = 'ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰ã§ã™: '+e.message;
    document.getElementById('guest-status').className = 'msg err';
  }
});

document.getElementById('copy-answer').addEventListener('click', function(){
  var t = document.getElementById('guest-answer').value;
  try{navigator.clipboard.writeText(t);}catch(e){}
  this.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
  setTimeout(function(){document.getElementById('copy-answer').textContent='ğŸ“‹ è¿”ç­”ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼';},2000);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚«ãƒ¼ãƒ‰ãƒ»ãƒãƒ³ãƒ‰è©•ä¾¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SUITS=['â™ ','â™¥','â™¦','â™£'],RANKS=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
var RV={};RANKS.forEach(function(r,i){RV[r]=i+2;});
var HN=['ãƒã‚¤ã‚«ãƒ¼ãƒ‰','ãƒ¯ãƒ³ãƒšã‚¢','ãƒ„ãƒ¼ãƒšã‚¢','ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰','ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ','ãƒ•ãƒ©ãƒƒã‚·ãƒ¥','ãƒ•ãƒ«ãƒã‚¦ã‚¹','ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰','ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥'];
function makeDeck(){var d=[];SUITS.forEach(function(s){RANKS.forEach(function(r){d.push({r:r,s:s});});});return d;}
function shuffle(a){for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=a[i];a[i]=a[j];a[j]=t;}return a;}
function isRed(s){return s==='â™¥'||s==='â™¦';}
function cH(c,sm){
  if(!c)return'<div class="card'+(sm?' sm':'')+' back"></div>';
  return'<div class="card'+(sm?' sm':'')+(isRed(c.s)?' red':'')+'"><div class="card-r">'+c.r+'</div><div class="card-s">'+c.s+'</div></div>';
}
function combs(a,k){if(!k)return[[]];if(!a.length)return[];return combs(a.slice(1),k-1).map(function(c){return[a[0]].concat(c);}).concat(combs(a.slice(1),k));}
function sc5(cards){
  var v=cards.map(function(c){return RV[c.r];}).sort(function(a,b){return b-a;});
  var s=cards.map(function(c){return c.s;});
  var fl=s.every(function(x){return x===s[0];});
  var st=false,sh=0;
  if(v[0]-v[4]===4&&(new Set(v)).size===5){st=true;sh=v[0];}
  if(JSON.stringify(v)==='[14,5,4,3,2]'){st=true;sh=5;v=[5,4,3,2,1];}
  var cnt={};v.forEach(function(x){cnt[x]=(cnt[x]||0)+1;});
  var g=Object.keys(cnt).map(function(x){return{v:+x,c:cnt[x]};}).sort(function(a,b){return b.c-a.c||b.v-a.v;});
  var rank,hi;
  if(fl&&st){rank=8;hi=[sh];}else if(g[0].c===4){rank=7;hi=[g[0].v,g[1].v];}
  else if(g[0].c===3&&g[1].c===2){rank=6;hi=[g[0].v,g[1].v];}else if(fl){rank=5;hi=v;}
  else if(st){rank=4;hi=[sh];}else if(g[0].c===3){rank=3;hi=[g[0].v,g[1].v,g[2].v];}
  else if(g[0].c===2&&g[1].c===2){rank=2;hi=[g[0].v,g[1].v,g[2].v];}
  else if(g[0].c===2){rank=1;hi=[g[0].v,g[1].v,g[2].v,g[3].v];}else{rank=0;hi=v;}
  return{rank:rank,hi:hi};
}
function cmpSc(a,b){if(a.rank!==b.rank)return a.rank-b.rank;for(var i=0;i<Math.max(a.hi.length,b.hi.length);i++){var d=(a.hi[i]||0)-(b.hi[i]||0);if(d)return d;}return 0;}
function evalHand(cards){var best=null;combs(cards,5).forEach(function(c){var sc=sc5(c);if(!best||cmpSc(sc,best.score)>0)best={score:sc,cards:c};});return best;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var players=[], myIdx=-1;
var deck=[], community=[], pot=0, phase=0;
var currentBet=0, lastRaiseSize=20, actsThisStreet=[];
var dealerIdx=0, currentIdx=0, myHole=[];
var PNAMES=['PRE-FLOP','FLOP','TURN','RIVER','SHOWDOWN'];

function setupGame(playerDefs){
  players = playerDefs.map(function(p,i){
    if(p.isMe) myIdx=i;
    return{name:p.name,chips:p.chips,pid:p.pid,isMe:p.isMe,idx:i,
           hole:[],bet:0,totalBet:0,folded:false,allIn:false,active:true};
  });
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©è¨­å®š
  onMsgCb = handleNetMsg;
}

function handleNetMsg(d){
  if(d.type==='state') applyState(d.state);
  else if(d.type==='hole') { myHole=d.hole; if(players[myIdx])players[myIdx].hole=d.hole; renderAll(); }
  else if(d.type==='action' && isHost) { applyAction(d); renderAll(); advanceGame(); }
}

// ãƒ›ã‚¹ãƒˆãŒã‚²ã‚¹ãƒˆæƒ…å ±ã‚’å—ã‘å–ã‚‹ï¼ˆå°†æ¥æ‹¡å¼µç”¨ã€ä»Šã¯å›ºå®š2åï¼‰
function startRound(){
  deck=shuffle(makeDeck());community=[];pot=0;phase=0;currentBet=0;lastRaiseSize=BB;actsThisStreet=[];
  players.forEach(function(p){if(p.chips<=0)p.active=false;p.hole=[];p.bet=0;p.totalBet=0;p.folded=false;p.allIn=false;});
  var active=players.filter(function(p){return p.active;});
  if(active.length<2){var w=active[0];broadcastState({roundResult:{title:'ã‚²ãƒ¼ãƒ çµ‚äº†',body:'<span class="wn">'+(w?w.name:'?')+'</span>ã®å„ªå‹ï¼',cardsHTML:''}});return;}
  dealerIdx=(dealerIdx+1)%players.length;
  while(!players[dealerIdx].active)dealerIdx=(dealerIdx+1)%players.length;
  // æ‰‹æœ­é…å¸ƒ
  active.forEach(function(p){
    var h=[deck.pop(),deck.pop()];
    p.hole=h;
    if(p.isMe){myHole=h;}
    else{sendMsg({type:'hole',hole:h});} // ã‚²ã‚¹ãƒˆã«é€ä¿¡
  });
  var sb=nxt(dealerIdx),bb=nxt(sb);
  blind(players[sb],SB);blind(players[bb],BB);
  currentBet=BB;lastRaiseSize=BB;currentIdx=nxt(bb);actsThisStreet=[players[sb].idx];
  broadcastState({waitingFor:players[currentIdx].pid});
}

function blind(p,a){var x=Math.min(a,p.chips);p.chips-=x;p.bet+=x;p.totalBet+=x;pot+=x;if(!p.chips)p.allIn=true;}
function nxt(from){var i=(from+1)%players.length,t=0;while((!players[i].active||players[i].folded||players[i].allIn)&&t<players.length){i=(i+1)%players.length;t++;}return i;}

function applyAction(d){
  var p=players[d.playerIdx];if(!p)return;
  if(d.action==='fold'){p.folded=true;}
  else if(d.action==='call'){var tc=Math.min(currentBet-p.bet,p.chips);p.chips-=tc;p.bet+=tc;p.totalBet+=tc;pot+=tc;if(!p.chips)p.allIn=true;}
  else if(d.action==='raise'){var nb=Math.min(Math.max(d.amount,currentBet+1),p.chips+p.bet);lastRaiseSize=Math.max(nb-currentBet,lastRaiseSize);currentBet=nb;var cost=nb-p.bet;p.chips-=cost;p.bet=nb;p.totalBet+=cost;pot+=cost;if(!p.chips)p.allIn=true;actsThisStreet=[d.playerIdx];}
  else if(d.action==='allin'){var nb2=p.chips+p.bet;if(nb2>currentBet){lastRaiseSize=Math.max(nb2-currentBet,lastRaiseSize);currentBet=nb2;actsThisStreet=[d.playerIdx];}pot+=p.chips;p.bet=nb2;p.totalBet+=p.chips;p.chips=0;p.allIn=true;}
  if(actsThisStreet.indexOf(d.playerIdx)<0)actsThisStreet.push(d.playerIdx);
}

function advanceGame(){
  var nf=players.filter(function(p){return p.active&&!p.folded;});
  if(nf.length===1){nf[0].chips+=pot;broadcastState({roundResult:{title:'ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†',body:'<span class="wn">'+nf[0].name+'</span>ã®å‹åˆ©ï¼ï¼ˆå…¨å“¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ï¼‰',cardsHTML:''},waitingFor:null});return;}
  var ca=players.filter(function(p){return p.active&&!p.folded&&!p.allIn;});
  var aa=ca.every(function(p){return actsThisStreet.indexOf(p.idx)>=0;});
  var be=ca.every(function(p){return p.bet===currentBet;});
  if(ca.length<=1||(aa&&be)){nextPhase();return;}
  currentIdx=nxt(currentIdx);
  broadcastState({waitingFor:players[currentIdx].pid});
}

function nextPhase(){
  players.forEach(function(p){p.bet=0;});currentBet=0;lastRaiseSize=BB;actsThisStreet=[];phase++;
  if(phase===1)community.push(deck.pop(),deck.pop(),deck.pop());
  else if(phase===2)community.push(deck.pop());
  else if(phase===3)community.push(deck.pop());
  else if(phase>=4){doShowdown();return;}
  currentIdx=nxt(dealerIdx);
  broadcastState({waitingFor:players[currentIdx].pid});
}

function doShowdown(){
  var cont=players.filter(function(p){return p.active&&!p.folded;});
  cont.forEach(function(p){p.bestHand=evalHand(p.hole.concat(community));});
  cont.sort(function(a,b){return cmpSc(b.bestHand.score,a.bestHand.score);});
  var top=cont[0].bestHand.score;
  var wins=cont.filter(function(p){return cmpSc(p.bestHand.score,top)===0;});
  var share=Math.floor(pot/wins.length);wins.forEach(function(w){w.chips+=share;});
  var body='<span class="wn">'+wins.map(function(w){return w.name;}).join(' & ')+'</span>ã®å‹åˆ©ï¼<br><span class="hn">'+HN[wins[0].bestHand.score.rank]+'</span><br>ãƒãƒƒãƒˆ: '+pot;
  if(wins.length>1)body+='<br>ï¼ˆ'+share+'ãšã¤å±±åˆ†ã‘ï¼‰';
  body+='<br><br>';
  var reveal={};
  cont.forEach(function(p){body+='<b style="color:#aaa">'+p.name+'</b>: '+HN[p.bestHand.score.rank]+'<br>';reveal[p.idx]=p.hole;});
  var ch='';wins[0].hole.forEach(function(c){ch+=cH(c);});
  broadcastState({showdown:{body:body,cardsHTML:ch},revealHoles:reveal,waitingFor:null});
}

function buildState(extra){
  var st={
    players:players.map(function(p){return{chips:p.chips,bet:p.bet,totalBet:p.totalBet,folded:p.folded,allIn:p.allIn,active:p.active};}),
    community:community,pot:pot,phase:phase,currentIdx:currentIdx,currentBet:currentBet,
    dealerIdx:dealerIdx,lastRaiseSize:lastRaiseSize,actsThisStreet:actsThisStreet,
    showdown:null,roundResult:null,revealHoles:null,waitingFor:null
  };
  if(extra)Object.keys(extra).forEach(function(k){st[k]=extra[k];});
  return st;
}

function broadcastState(extra){
  var st=buildState(extra);
  applyState(st); // è‡ªåˆ†ã«é©ç”¨
  sendMsg({type:'state',state:st}); // ç›¸æ‰‹ã«é€ä¿¡
}

function applyState(st){
  community=st.community||[];pot=st.pot||0;phase=st.phase||0;
  currentIdx=st.currentIdx||0;currentBet=st.currentBet||0;
  dealerIdx=st.dealerIdx||0;lastRaiseSize=st.lastRaiseSize||BB;
  actsThisStreet=st.actsThisStreet||[];
  if(st.players)st.players.forEach(function(sp,i){
    if(!players[i])return;
    players[i].chips=sp.chips;players[i].bet=sp.bet;players[i].totalBet=sp.totalBet;
    players[i].folded=sp.folded;players[i].allIn=sp.allIn;players[i].active=sp.active;
  });
  if(myHole.length===2&&players[myIdx])players[myIdx].hole=myHole;
  if(st.revealHoles)Object.keys(st.revealHoles).forEach(function(i){if(players[i])players[i].hole=st.revealHoles[i];});
  renderAll();
  if(st.showdown){handleShowdown(st.showdown);return;}
  if(st.roundResult){handleRoundResult(st.roundResult);return;}
  if(st.waitingFor===players[myIdx].pid){
    hideInfo();document.getElementById('action-panel').style.display='block';renderAction();
  }else{
    showInfo((players[currentIdx]?players[currentIdx].name:'?')+'ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    document.getElementById('action-panel').style.display='none';
  }
}

function handleShowdown(sd){if(!sd)return;renderAll();showMsg('ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³',sd.body,'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){if(isHost)startRound();else showInfo('æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾…ã£ã¦ã„ã¾ã™...');},sd.cardsHTML||'');}
function handleRoundResult(rr){if(!rr||!rr.title)return;renderAll();showMsg(rr.title,rr.body,'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){if(isHost)startRound();else showInfo('æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾…ã£ã¦ã„ã¾ã™...');},rr.cardsHTML||'');}

// â”€â”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ â”€â”€
function renderAction(){
  var p=players[myIdx];if(!p)return;
  document.getElementById('action-who').textContent=p.name+' ã®ã‚¿ãƒ¼ãƒ³ï¼ˆã‚ãªãŸï¼‰';
  var toC=currentBet-p.bet;
  document.getElementById('action-info').textContent='ãƒãƒƒãƒ—: '+p.chips+'  ã‚³ãƒ¼ãƒ«: '+Math.min(toC,p.chips);
  var h=myHole.length?myHole:p.hole;
  document.getElementById('hand-display').innerHTML=cH(h[0])+cH(h[1]);
  var minR=Math.min(currentBet+lastRaiseSize,p.chips+p.bet),maxR=p.chips+p.bet;
  var sl=document.getElementById('raise-slider');
  sl.min=minR;sl.max=maxR;sl.value=minR;
  document.getElementById('raise-input').value=minR;
  sl.oninput=function(){document.getElementById('raise-input').value=this.value;};
  document.getElementById('raise-input').oninput=function(){sl.value=Math.min(Math.max(+this.value||0,minR),maxR);};
  var pr=document.getElementById('preset-row');pr.innerHTML='';
  [['1/3P',Math.round(pot/3)],['1/2P',Math.round(pot/2)],['POT',pot],['2Ã—BB',BB*2]].forEach(function(x){
    var b=document.createElement('button');b.className='preset-btn';
    var v=Math.min(Math.max(x[1],minR),maxR);
    b.textContent=x[0]+'('+v+')';b.onclick=function(){sl.value=v;document.getElementById('raise-input').value=v;};
    pr.appendChild(b);
  });
  var br=document.getElementById('btn-row');br.innerHTML='';
  function ab(lbl,cls,fn){var b=document.createElement('button');b.className='abtn '+cls;b.textContent=lbl;b.onclick=fn;br.appendChild(b);}
  ab('ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','a-fold',function(){send('fold',0);});
  if(toC<=0)ab('ãƒã‚§ãƒƒã‚¯','a-check',function(){send('check',0);});
  else ab('ã‚³ãƒ¼ãƒ«('+Math.min(toC,p.chips)+')','a-call',function(){send('call',0);});
  if(p.chips>toC)ab('ãƒ¬ã‚¤ã‚º','a-raise',function(){send('raise',+document.getElementById('raise-input').value||0);});
  ab('ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³','a-allin',function(){send('allin',0);});
}

function send(action,amount){
  document.getElementById('action-panel').style.display='none';
  showInfo('é€ä¿¡ä¸­...');
  var d={type:'action',playerIdx:myIdx,action:action,amount:amount};
  if(isHost){applyAction(d);renderAll();advanceGame();}
  else sendMsg(d);
}

// â”€â”€ æç”» â”€â”€
function renderAll(){
  var area=document.getElementById('players-area');area.innerHTML='';
  players.forEach(function(p,i){
    if(!p.active)return;
    var s=document.createElement('div');s.className='pseat';
    if(i===currentIdx)s.classList.add(p.isMe?'myturn':'waiting');
    if(p.folded)s.classList.add('folded');
    if(i===dealerIdx)s.classList.add('dealer');
    var h=p.isMe?(myHole.length?myHole:p.hole):p.hole;
    var show=(phase>=4&&!p.folded&&h&&h.length===2)||p.isMe;
    var ch=show&&h&&h.length===2?(cH(h[0],true)+cH(h[1],true)):'<div class="card sm back"></div><div class="card sm back"></div>';
    var st=p.folded?'FOLD':p.allIn?'ALL IN':i===currentIdx?(p.isMe?'â–¶ ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³':'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸­...'):'';
    s.innerHTML='<div class="seat-name">'+p.name+(p.isMe?' â­':'')+'</div>'+
      '<div class="seat-chips">'+p.chips+' ğŸª™</div>'+
      '<div class="seat-bet">'+(p.bet?'BET: '+p.bet:'')+'</div>'+
      '<div class="seat-cards">'+ch+'</div>'+
      '<div class="seat-st">'+st+'</div>';
    area.appendChild(s);
  });
  var cc=document.getElementById('community-cards');cc.innerHTML='';
  for(var i=0;i<5;i++)cc.innerHTML+=i<community.length?cH(community[i]):'<div class="card back"></div>';
  document.getElementById('pot-display').textContent='POT: '+pot;
  document.getElementById('phase-label').textContent=PNAMES[Math.min(phase,4)]||'SHOWDOWN';
}
function showInfo(m){document.getElementById('info-bar').classList.add('show');document.getElementById('info-bar-text').textContent=m;}
function hideInfo(){document.getElementById('info-bar').classList.remove('show');}
function showMsg(title,body,lbl,fn,ch){
  document.getElementById('msg-overlay').classList.add('show');
  document.getElementById('msg-title').textContent=title;
  document.getElementById('msg-body').innerHTML=body;
  document.getElementById('msg-cards').innerHTML=ch||'';
  var btn=document.getElementById('msg-btn');btn.textContent=lbl;
  btn.onclick=function(){document.getElementById('msg-overlay').classList.remove('show');fn();};
}
function showScreen(id){
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById(id).classList.add('active');
}

})();
</script>
</body>
</html>
