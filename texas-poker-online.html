<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Texas Hold'em Online</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
:root{--gold:#c9a84c;--gold-light:#f0d080;--gold-dark:#8a6820;--felt:#1a4a2e;--felt-dark:#0d2e1c;--felt-light:#235c39;--red:#c0392b;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:radial-gradient(ellipse at 50%,#1e5535 0%,#0a2010 100%);min-height:100vh;font-family:'Crimson Text',serif;color:#fff;overflow-x:hidden;}
.screen{display:none;min-height:100vh;flex-direction:column;align-items:center;padding:20px 16px 40px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.screen.active{display:flex;}
.logo{font-family:'Cinzel',serif;font-size:clamp(20px,6vw,44px);font-weight:900;background:linear-gradient(135deg,#8a6820,#f0d080,#c9a84c,#f0d080,#8a6820);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:3px;text-align:center;margin:16px 0 4px;}
.logo-sub{font-family:'Cinzel',serif;font-size:11px;color:var(--gold);letter-spacing:6px;text-align:center;margin-bottom:12px;opacity:.7;}
.badge{font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;padding:4px 14px;border-radius:20px;margin-bottom:14px;text-align:center;}
.b-ok{color:#0f0;background:rgba(0,200,0,.12);border:1px solid rgba(0,200,0,.3);}
.b-info{color:#4af;background:rgba(0,150,255,.12);border:1px solid rgba(0,150,255,.3);}
.b-err{color:#f88;background:rgba(255,60,60,.12);border:1px solid rgba(255,60,60,.3);}
.panel{background:linear-gradient(145deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(201,168,76,.3);border-radius:16px;padding:20px;width:100%;max-width:480px;margin-bottom:14px;}
.ptitle{font-family:'Cinzel',serif;font-size:11px;color:var(--gold);letter-spacing:3px;margin-bottom:14px;text-align:center;}
.flabel{font-size:11px;color:rgba(201,168,76,.7);letter-spacing:2px;font-family:'Cinzel',serif;margin-bottom:5px;display:block;}
.inp{width:100%;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:10px 14px;color:#fff;font-family:'Crimson Text',serif;font-size:15px;outline:none;margin-bottom:10px;}
.inp:focus{border-color:var(--gold);}
.inp::placeholder{color:rgba(255,255,255,.2);}
.num-inp{width:90px;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:8px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:13px;outline:none;text-align:center;}
.row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.gap{display:flex;gap:8px;align-items:center;}
.btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--gold-dark),var(--gold),var(--gold-dark));border:none;border-radius:10px;color:#1a0a00;font-family:'Cinzel',serif;font-size:13px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-top:8px;}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn:active:not(:disabled){transform:scale(.98);}
.btn-sm{padding:9px 14px;background:rgba(201,168,76,.2);border:1px solid var(--gold);border-radius:8px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:11px;cursor:pointer;white-space:nowrap;}
.slabel{font-family:'Cinzel',serif;font-size:10px;color:rgba(201,168,76,.6);letter-spacing:2px;margin:10px 0 7px;text-transform:uppercase;}
.code-big{font-family:'Cinzel',serif;font-size:36px;letter-spacing:10px;color:var(--gold-light);text-align:center;padding:12px 0;background:rgba(0,0,0,.4);border-radius:10px;margin:8px 0;cursor:pointer;}
.code-hint{font-size:11px;color:rgba(255,255,255,.3);text-align:center;margin-bottom:6px;}
.plist{display:flex;flex-direction:column;gap:5px;margin:8px 0;}
.pitem{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(0,0,0,.3);border-radius:8px;font-size:13px;}
.dot{width:8px;height:8px;border-radius:50%;background:#0f0;flex-shrink:0;}
.htag{font-family:'Cinzel',serif;font-size:9px;color:#fd0;background:rgba(255,200,0,.15);border:1px solid rgba(255,200,0,.3);border-radius:4px;padding:1px 6px;margin-left:auto;}
.smsg{font-size:12px;text-align:center;padding:7px;border-radius:8px;margin-top:6px;}
.s-ok{color:#0f0;}.s-err{color:#f88;}.s-info{color:#4af;}
/* game */
#screen-game{padding:10px;align-items:stretch;}
.felt{width:100%;max-width:700px;background:radial-gradient(ellipse at center,var(--felt-light),var(--felt) 60%,var(--felt-dark));border-radius:100px;border:5px solid var(--gold-dark);box-shadow:0 0 0 2px var(--gold),0 8px 40px rgba(0,0,0,.7),inset 0 0 40px rgba(0,0,0,.3);padding:20px 24px;display:flex;flex-direction:column;align-items:center;gap:8px;min-height:180px;margin:0 auto 10px;}
#comm-cards{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
#pot{font-family:'Cinzel',serif;font-size:12px;color:var(--gold-light);background:rgba(0,0,0,.4);padding:4px 16px;border-radius:20px;border:1px solid rgba(201,168,76,.3);}
#phase{font-family:'Cinzel',serif;font-size:10px;letter-spacing:4px;color:rgba(255,255,255,.35);}
#seats{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:6px;width:100%;max-width:700px;margin:0 auto 8px;}
.seat{background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.2);border-radius:12px;padding:8px;text-align:center;position:relative;}
.seat.myturn{border-color:var(--gold);background:rgba(201,168,76,.12);box-shadow:0 0 18px rgba(201,168,76,.3);}
.seat.waiting{border-color:#fa0;animation:wp .9s infinite alternate;}
@keyframes wp{from{box-shadow:0 0 6px rgba(255,165,0,.2);}to{box-shadow:0 0 20px rgba(255,165,0,.5);}}
.seat.folded{opacity:.4;}
.seat.dealer::before{content:'D';position:absolute;top:-8px;left:-8px;width:19px;height:19px;background:var(--gold);color:#000;border-radius:50%;font-family:'Cinzel',serif;font-size:9px;font-weight:700;line-height:19px;text-align:center;}
.sname{font-family:'Cinzel',serif;font-size:10px;color:var(--gold-light);margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.schips{font-size:11px;color:rgba(255,255,255,.65);}
.sbet{font-size:10px;color:#f0d080;min-height:14px;}
.scards{display:flex;gap:3px;justify-content:center;margin-top:4px;}
.sst{font-size:9px;color:rgba(255,255,255,.35);min-height:12px;}
.card{width:36px;height:52px;background:#faf8f0;border-radius:4px;border:1px solid #ccc;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#1a1a1a;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,.4);}
.card.red{color:var(--red);}.card.back{background:linear-gradient(135deg,#1a3a6a,#0d1f40);border-color:var(--gold-dark);}
.cr{font-size:12px;font-family:'Cinzel',serif;line-height:1;}.cs{font-size:13px;line-height:1;}
.card.sm{width:28px;height:40px;}.card.sm .cr{font-size:9px;}.card.sm .cs{font-size:10px;}
#ap{width:100%;max-width:700px;margin:0 auto;background:rgba(0,0,0,.6);border:1px solid rgba(201,168,76,.25);border-radius:14px;padding:12px;}
#ap-hd{display:flex;justify-content:space-between;margin-bottom:10px;}
#ap-who{font-family:'Cinzel',serif;font-size:12px;color:var(--gold-light);}
#ap-info{font-size:11px;color:rgba(255,255,255,.45);}
#hdisp{display:flex;gap:8px;justify-content:center;margin-bottom:10px;}
.prow{display:flex;gap:4px;margin-bottom:6px;flex-wrap:wrap;}
.pbtn{flex:1;min-width:44px;padding:4px 2px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25);border-radius:5px;color:var(--gold);font-family:'Cinzel',serif;font-size:8px;cursor:pointer;text-align:center;}
#rrow{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
#rrow label{font-size:10px;color:var(--gold);white-space:nowrap;font-family:'Cinzel',serif;}
#rinp{flex:1;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.4);border-radius:7px;padding:7px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:14px;outline:none;text-align:center;}
#rslider{width:100%;margin-bottom:8px;accent-color:var(--gold);}
.brow{display:flex;gap:6px;flex-wrap:wrap;}
.ab{flex:1;min-width:65px;padding:10px 4px;border:none;border-radius:8px;font-family:'Cinzel',serif;font-size:10px;cursor:pointer;font-weight:700;}
.ab:active{transform:scale(.97);}
.ab-fold{background:rgba(150,40,40,.8);color:#ffaaaa;border:1px solid rgba(200,60,60,.5);}
.ab-check{background:rgba(40,100,180,.8);color:#aaddff;border:1px solid rgba(60,130,210,.5);}
.ab-call{background:rgba(30,130,100,.8);color:#aaffdd;border:1px solid rgba(50,160,120,.5);}
.ab-raise{background:rgba(180,120,20,.85);color:#fff5cc;border:1px solid rgba(201,168,76,.6);}
.ab-allin{background:linear-gradient(135deg,#7a0000,#c00);color:#fff;border:1px solid #f00;}
#ibar{width:100%;max-width:700px;margin:0 auto 6px;background:rgba(0,0,0,.5);border:1px solid rgba(255,165,0,.3);border-radius:10px;padding:8px;text-align:center;display:none;}
#ibar.show{display:block;}
#ibar-t{font-family:'Cinzel',serif;font-size:11px;color:#fa0;}
#mover{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;align-items:center;justify-content:center;padding:20px;}
#mover.show{display:flex;}
.mcard{background:linear-gradient(145deg,#1a2a10,#0d1a08);border:2px solid var(--gold);border-radius:20px;padding:24px;text-align:center;max-width:440px;width:100%;}
.mtitle{font-family:'Cinzel',serif;font-size:18px;color:var(--gold-light);margin-bottom:10px;}
.mbody{font-size:13px;color:rgba(255,255,255,.8);line-height:1.8;margin-bottom:14px;}
.mbody .wn{color:var(--gold-light);font-size:15px;font-weight:600;}.mbody .hn{color:#aaffaa;font-size:11px;}
.mcards{display:flex;gap:6px;justify-content:center;margin:8px 0;flex-wrap:wrap;}
.mnext{padding:12px 28px;background:linear-gradient(135deg,var(--gold-dark),var(--gold));border:none;border-radius:10px;color:#1a0a00;font-family:'Cinzel',serif;font-size:12px;font-weight:700;cursor:pointer;}
</style>
</head>
<body>

<!-- ãƒ­ãƒ“ãƒ¼ -->

<div id="screen-lobby" class="screen active">
  <div class="logo">TEXAS HOLD'EM</div>
  <div class="logo-sub">ONLINE POKER</div>
  <div id="conn-badge" class="badge b-info">æ¥ç¶šç¢ºèªä¸­...</div>

  <div class="panel">
    <div class="ptitle">ã‚ãªãŸã®æƒ…å ±</div>
    <label class="flabel">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
    <input class="inp" id="my-name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1">
    <div class="row">
      <span style="font-size:12px;color:rgba(255,255,255,.5);">é–‹å§‹ãƒãƒƒãƒ—</span>
      <input class="num-inp" id="my-chips" value="1000">
    </div>
  </div>

  <div class="panel">
    <div class="ptitle">ğŸ  ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">SB</span><input class="num-inp" id="room-sb" value="10"></div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">BB</span><input class="num-inp" id="room-bb" value="20"></div>
    <button class="btn" id="btn-create">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
    <div id="room-created" style="display:none;margin-top:14px;">
      <div class="slabel">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼ï¼‰</div>
      <div class="code-big" id="code-disp">------</div>
      <div class="code-hint">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å¯¾æˆ¦ç›¸æ‰‹ã«ã‚·ã‚§ã‚¢</div>
      <div class="slabel">å‚åŠ è€…</div>
      <div class="plist" id="plist"></div>
      <div id="room-msg" class="smsg s-info">å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
      <button class="btn" id="btn-start" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    </div>
  </div>

  <div class="panel">
    <div class="ptitle">ğŸšª ãƒ«ãƒ¼ãƒ ã«å‚åŠ </div>
    <div class="gap">
      <input class="inp" id="join-code" placeholder="XXXXXX" maxlength="6" style="margin-bottom:0;font-family:'Cinzel',serif;font-size:20px;letter-spacing:6px;text-align:center;text-transform:uppercase;color:var(--gold-light);">
      <button class="btn-sm" id="btn-join">å‚åŠ </button>
    </div>
    <div id="join-msg" class="smsg"></div>
  </div>
</div>

<!-- ã‚²ãƒ¼ãƒ  -->

<div id="screen-game" class="screen">
  <div id="seats"></div>
  <div class="felt">
    <div id="phase">WAITING</div>
    <div id="comm-cards"></div>
    <div id="pot">POT: 0</div>
  </div>
  <div id="ibar"><div id="ibar-t"></div></div>
  <div id="ap" style="display:none;">
    <div id="ap-hd"><div id="ap-who"></div><div id="ap-info"></div></div>
    <div id="hdisp"></div>
    <div class="prow" id="prow"></div>
    <div id="rrow"><label>BET/RAISE:</label><input type="number" id="rinp"></div>
    <input type="range" id="rslider">
    <div class="brow" id="brow"></div>
  </div>
</div>

<div id="mover">
  <div class="mcard">
    <div class="mtitle" id="mtitle"></div>
    <div class="mcards" id="mcards"></div>
    <div class="mbody" id="mbody"></div>
    <button class="mnext" id="mnext">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰</button>
  </div>
</div>

<script>
(function(){
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase REST API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var DB = 'https://poker-cc448-default-rtdb.asia-southeast1.firebasedatabase.app';
var _polls = {};

function fbUrl(path){ return DB + '/' + path + '.json'; }

function fbGet(path, cb){
  fetch(fbUrl(path))
    .then(function(r){ return r.json(); })
    .then(function(d){ cb(d); })
    .catch(function(){ cb(null); });
}
function fbSet(path, val, cb){
  fetch(fbUrl(path), {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(val)})
    .then(function(){ if(cb) cb(); })
    .catch(function(e){ console.error('fbSet', e); if(cb) cb(); });
}
function fbPatch(path, val, cb){
  fetch(fbUrl(path), {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(val)})
    .then(function(){ if(cb) cb(); })
    .catch(function(e){ console.error('fbPatch', e); if(cb) cb(); });
}
function fbListen(path, cb){
  if(!_polls[path]) _polls[path] = {last:null, cbs:[], timer:null};
  _polls[path].cbs.push(cb);
  fbGet(path, function(d){
    _polls[path].last = JSON.stringify(d);
    cb(d);
  });
  if(!_polls[path].timer){
    _polls[path].timer = setInterval(function(){
      fbGet(path, function(d){
        var j = JSON.stringify(d);
        if(j !== _polls[path].last){
          _polls[path].last = j;
          _polls[path].cbs.forEach(function(fn){ fn(d); });
        }
      });
    }, 1500);
  }
}
function fbOff(path){
  if(_polls[path]){ clearInterval(_polls[path].timer); delete _polls[path]; }
}

// èµ·å‹•æ™‚æ¥ç¶šç¢ºèª
(function(){
  var el = document.getElementById('conn-badge');
  fetch(fbUrl('ping'), {method:'PUT', headers:{'Content-Type':'application/json'}, body:'"ok"'})
    .then(function(r){
      if(r.ok){ el.textContent='âœ“ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'; el.className='badge b-ok'; }
      else{ el.textContent='âš  æ¥ç¶šã‚¨ãƒ©ãƒ¼ '+r.status; el.className='badge b-err'; }
    })
    .catch(function(e){ el.textContent='âš  '+e.message; el.className='badge b-err'; });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚«ãƒ¼ãƒ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SUITS=['â™ ','â™¥','â™¦','â™£'], RANKS=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
var RV={}; RANKS.forEach(function(r,i){RV[r]=i+2;});
var HN=['ãƒã‚¤ã‚«ãƒ¼ãƒ‰','ãƒ¯ãƒ³ãƒšã‚¢','ãƒ„ãƒ¼ãƒšã‚¢','ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰','ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ','ãƒ•ãƒ©ãƒƒã‚·ãƒ¥','ãƒ•ãƒ«ãƒã‚¦ã‚¹','ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰','ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥'];
function makeDeck(){var d=[];SUITS.forEach(function(s){RANKS.forEach(function(r){d.push({r:r,s:s});});});return d;}
function shuffle(a){for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=a[i];a[i]=a[j];a[j]=t;}return a;}
function isRed(s){return s==='â™¥'||s==='â™¦';}
function cH(c,sm){
  if(!c) return '<div class="card'+(sm?' sm':'')+' back"></div>';
  return '<div class="card'+(sm?' sm':'')+(isRed(c.s)?' red':'')+'"><div class="cr">'+c.r+'</div><div class="cs">'+c.s+'</div></div>';
}
function combs(a,k){if(!k)return[[]];if(!a.length)return[];return combs(a.slice(1),k-1).map(function(c){return[a[0]].concat(c);}).concat(combs(a.slice(1),k));}
function sc5(cards){
  var v=cards.map(function(c){return RV[c.r];}).sort(function(a,b){return b-a;});
  var s=cards.map(function(c){return c.s;});
  var fl=s.every(function(x){return x===s[0];});
  var st=false,sh=0;
  if(v[0]-v[4]===4&&(new Set(v)).size===5){st=true;sh=v[0];}
  if(JSON.stringify(v)==='[14,5,4,3,2]'){st=true;sh=5;v=[5,4,3,2,1];}
  var cnt={};v.forEach(function(x){cnt[x]=(cnt[x]||0)+1;});
  var g=Object.keys(cnt).map(function(x){return{v:+x,c:cnt[x]};}).sort(function(a,b){return b.c-a.c||b.v-a.v;});
  var rank,hi;
  if(fl&&st){rank=8;hi=[sh];}else if(g[0].c===4){rank=7;hi=[g[0].v,g[1].v];}
  else if(g[0].c===3&&g[1].c===2){rank=6;hi=[g[0].v,g[1].v];}else if(fl){rank=5;hi=v;}
  else if(st){rank=4;hi=[sh];}else if(g[0].c===3){rank=3;hi=[g[0].v,g[1].v,g[2].v];}
  else if(g[0].c===2&&g[1].c===2){rank=2;hi=[g[0].v,g[1].v,g[2].v];}
  else if(g[0].c===2){rank=1;hi=[g[0].v,g[1].v,g[2].v,g[3].v];}else{rank=0;hi=v;}
  return{rank:rank,hi:hi};
}
function cmpSc(a,b){if(a.rank!==b.rank)return a.rank-b.rank;for(var i=0;i<Math.max(a.hi.length,b.hi.length);i++){var d=(a.hi[i]||0)-(b.hi[i]||0);if(d)return d;}return 0;}
function evalHand(cards){var best=null;combs(cards,5).forEach(function(c){var sc=sc5(c);if(!best||cmpSc(sc,best.score)>0)best={score:sc,cards:c};});return best;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ­ãƒ“ãƒ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var myId = Math.random().toString(36).substr(2,10);
var myName='', myChips=1000, SB=10, BB=20;
var roomPath='', isHost=false, myIdx=-1;

function genCode(){var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789',s='';for(var i=0;i<6;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}

document.getElementById('btn-create').addEventListener('click', function(){
  myName = document.getElementById('my-name').value.trim()||'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
  myChips = +document.getElementById('my-chips').value||1000;
  SB = +document.getElementById('room-sb').value||10;
  BB = +document.getElementById('room-bb').value||20;
  var code = genCode();
  roomPath = 'rooms/'+code;
  isHost = true;
  var data = {code:code,SB:SB,BB:BB,status:'waiting',hostId:myId,createdAt:Date.now(),players:{}};
  data.players[myId] = {id:myId,name:myName,chips:myChips,seat:0};
  fbSet(roomPath, data, function(){
    document.getElementById('room-created').style.display='block';
    document.getElementById('code-disp').textContent = code;
    watchLobby();
  });
});

document.getElementById('code-disp').addEventListener('click', function(){
  try{navigator.clipboard.writeText(this.textContent);}catch(e){}
  var el=this; el.style.color='#0f0'; setTimeout(function(){el.style.color='';},800);
});

function watchLobby(){
  fbListen(roomPath, function(room){
    if(!room) return;
    var ps = room.players||{};
    renderPlist(ps);
    var n = Object.keys(ps).length;
    var btn = document.getElementById('btn-start');
    btn.disabled = n<2;
    btn.textContent = n>=2 ? 'ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆ'+n+'äººï¼‰' : 'å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...';
    document.getElementById('room-msg').textContent = n+'äººãŒå‚åŠ ä¸­';
    if(room.status==='started' && !isHost) launchGame(room);
  });
}

function renderPlist(ps){
  var el=document.getElementById('plist'); el.innerHTML='';
  Object.values(ps).sort(function(a,b){return a.seat-b.seat;}).forEach(function(p){
    el.innerHTML+='<div class="pitem"><div class="dot"></div><span>'+p.name+(p.id===myId?' (ã‚ãªãŸ)':'')+'</span>'+(p.seat===0?'<div class="htag">HOST</div>':'')+'</div>';
  });
}

document.getElementById('btn-start').addEventListener('click', function(){
  if(!isHost) return;
  fbGet(roomPath+'/players', function(ps){
    var arr = Object.values(ps||{}).sort(function(a,b){return a.seat-b.seat;});
    var seats={};arr.forEach(function(p,i){seats[p.id]=i;});
    fbPatch(roomPath, {status:'started', seats:seats}, function(){ launchGame(null); });
  });
});

document.getElementById('btn-join').addEventListener('click', doJoin);
document.getElementById('join-code').addEventListener('keydown', function(e){if(e.key==='Enter')doJoin();});
function setJM(msg,type){var el=document.getElementById('join-msg');el.textContent=msg;el.className='smsg s-'+type;}

function doJoin(){
  var code = document.getElementById('join-code').value.trim().toUpperCase();
  if(code.length<4){setJM('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
  myName = document.getElementById('my-name').value.trim()||'ã‚²ã‚¹ãƒˆ';
  myChips = +document.getElementById('my-chips').value||1000;
  setJM('æ¥ç¶šä¸­...','info');
  fbGet('rooms/'+code, function(room){
    if(!room){setJM('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“','err');return;}
    if(room.status==='started'){setJM('ã‚²ãƒ¼ãƒ ã¯ã™ã§ã«é–‹å§‹ã—ã¦ã„ã¾ã™','err');return;}
    isHost=false; roomPath='rooms/'+code; SB=room.SB; BB=room.BB;
    var seat = Object.keys(room.players||{}).length;
    var patch={}; patch[myId]={id:myId,name:myName,chips:myChips,seat:seat};
    fbPatch(roomPath+'/players', patch, function(){
      setJM('âœ“ å‚åŠ ã—ã¾ã—ãŸï¼ãƒ›ã‚¹ãƒˆã®é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™','ok');
      watchLobby();
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚²ãƒ¼ãƒ 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var players=[], deck=[], comm=[], pot=0, phase=0;
var curBet=0, lastRaise=20, acts=[];
var dealerIdx=0, curIdx=0, myHole=[], lastActTs=0;
var gamePath='', holePfx='';
var PNAMES=['PRE-FLOP','FLOP','TURN','RIVER','SHOWDOWN'];

function launchGame(room){
  fbOff(roomPath);
  if(isHost){
    fbGet(roomPath, function(r){ _launch(r); });
  } else {
    _launch(room);
  }
}

function _launch(room){
  if(!room) return;
  SB=room.SB; BB=room.BB;
  var seats=room.seats||{};
  var arr=Object.values(room.players||{}).sort(function(a,b){return(seats[a.id]||0)-(seats[b.id]||0);});
  players=arr.map(function(p,i){
    if(p.id===myId) myIdx=i;
    return{name:p.name,chips:p.chips,pid:p.id,isMe:p.id===myId,idx:i,
           hole:[],bet:0,totalBet:0,folded:false,allIn:false,active:true};
  });
  gamePath = roomPath+'/game';
  holePfx  = roomPath+'/holes/';
  showScreen('screen-game');
  fbListen(gamePath+'/state', onState);
  fbListen(holePfx+myId, function(h){
    if(h&&h.length===2){myHole=h;if(players[myIdx])players[myIdx].hole=h;renderAll();}
  });
  if(isHost){ watchAction(); startRound(); }
  else showInfo('ãƒ›ã‚¹ãƒˆã®ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...');
}

function onState(st){
  if(!st) return;
  comm=st.comm||[]; pot=st.pot||0; phase=st.phase||0;
  curIdx=st.curIdx||0; curBet=st.curBet||0;
  dealerIdx=st.dealerIdx||0; lastRaise=st.lastRaise||BB;
  acts=st.acts||[];
  if(st.players) st.players.forEach(function(sp,i){
    if(!players[i])return;
    players[i].chips=sp.chips;players[i].bet=sp.bet;players[i].totalBet=sp.totalBet;
    players[i].folded=sp.folded;players[i].allIn=sp.allIn;players[i].active=sp.active;
  });
  if(myHole.length===2&&players[myIdx]) players[myIdx].hole=myHole;
  if(st.reveal) Object.keys(st.reveal).forEach(function(i){if(players[i])players[i].hole=st.reveal[i];});
  renderAll();
  if(st.showdown){handleSD(st.showdown);return;}
  if(st.result){handleResult(st.result);return;}
  if(st.waitFor===myId){
    hideInfo(); document.getElementById('ap').style.display='block'; renderAction();
  } else {
    showInfo((players[curIdx]?players[curIdx].name:'?')+'ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    document.getElementById('ap').style.display='none';
  }
}

function watchAction(){
  fbListen(gamePath+'/action', function(d){
    if(!d||d.ts===lastActTs) return;
    lastActTs=d.ts; curIdx=d.playerIdx;
    applyAction(d); renderAll(); advance();
  });
}

function pushState(extra){
  var st={
    players:players.map(function(p){return{chips:p.chips,bet:p.bet,totalBet:p.totalBet,folded:p.folded,allIn:p.allIn,active:p.active};}),
    comm:comm,pot:pot,phase:phase,curIdx:curIdx,curBet:curBet,
    dealerIdx:dealerIdx,lastRaise:lastRaise,acts:acts,
    showdown:null,result:null,reveal:null,waitFor:null
  };
  if(extra) Object.keys(extra).forEach(function(k){st[k]=extra[k];});
  fbSet(gamePath+'/state', st);
}

function startRound(){
  deck=shuffle(makeDeck());comm=[];pot=0;phase=0;curBet=0;lastRaise=BB;acts=[];
  players.forEach(function(p){if(p.chips<=0)p.active=false;p.hole=[];p.bet=0;p.totalBet=0;p.folded=false;p.allIn=false;});
  var active=players.filter(function(p){return p.active;});
  if(active.length<2){var w=active[0];pushState({result:{title:'ã‚²ãƒ¼ãƒ çµ‚äº†',body:'<span class="wn">'+(w?w.name:'?')+'</span>ã®å„ªå‹ï¼',ch:''}});return;}
  dealerIdx=(dealerIdx+1)%players.length;
  while(!players[dealerIdx].active) dealerIdx=(dealerIdx+1)%players.length;
  active.forEach(function(p){
    var h=[deck.pop(),deck.pop()]; p.hole=h;
    fbSet(holePfx+p.pid, h);
    if(p.isMe) myHole=h;
  });
  var sb=nxt(dealerIdx), bb=nxt(sb);
  blind(players[sb],SB); blind(players[bb],BB);
  curBet=BB; lastRaise=BB; curIdx=nxt(bb); acts=[players[sb].idx];
  pushState({waitFor:players[curIdx].pid});
}

function blind(p,a){var x=Math.min(a,p.chips);p.chips-=x;p.bet+=x;p.totalBet+=x;pot+=x;if(!p.chips)p.allIn=true;}
function nxt(from){var i=(from+1)%players.length,t=0;while((!players[i].active||players[i].folded||players[i].allIn)&&t<players.length){i=(i+1)%players.length;t++;}return i;}

function applyAction(d){
  var p=players[d.playerIdx];if(!p)return;
  if(d.action==='fold'){p.folded=true;}
  else if(d.action==='call'){var tc=Math.min(curBet-p.bet,p.chips);p.chips-=tc;p.bet+=tc;p.totalBet+=tc;pot+=tc;if(!p.chips)p.allIn=true;}
  else if(d.action==='raise'){var nb=Math.min(Math.max(d.amount,curBet+1),p.chips+p.bet);lastRaise=Math.max(nb-curBet,lastRaise);curBet=nb;var cost=nb-p.bet;p.chips-=cost;p.bet=nb;p.totalBet+=cost;pot+=cost;if(!p.chips)p.allIn=true;acts=[d.playerIdx];}
  else if(d.action==='allin'){var nb2=p.chips+p.bet;if(nb2>curBet){lastRaise=Math.max(nb2-curBet,lastRaise);curBet=nb2;acts=[d.playerIdx];}pot+=p.chips;p.bet=nb2;p.totalBet+=p.chips;p.chips=0;p.allIn=true;}
  if(acts.indexOf(d.playerIdx)<0) acts.push(d.playerIdx);
}

function advance(){
  var nf=players.filter(function(p){return p.active&&!p.folded;});
  if(nf.length===1){nf[0].chips+=pot;pushState({result:{title:'ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†',body:'<span class="wn">'+nf[0].name+'</span>ã®å‹åˆ©ï¼ï¼ˆå…¨å“¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ï¼‰',ch:''},waitFor:null});return;}
  var ca=players.filter(function(p){return p.active&&!p.folded&&!p.allIn;});
  if(ca.length<=1||(ca.every(function(p){return acts.indexOf(p.idx)>=0;})&&ca.every(function(p){return p.bet===curBet;}))){nextPhase();return;}
  curIdx=nxt(curIdx);
  pushState({waitFor:players[curIdx].pid});
}

function nextPhase(){
  players.forEach(function(p){p.bet=0;}); curBet=0; lastRaise=BB; acts=[]; phase++;
  if(phase===1) comm.push(deck.pop(),deck.pop(),deck.pop());
  else if(phase===2) comm.push(deck.pop());
  else if(phase===3) comm.push(deck.pop());
  else if(phase>=4){ doShowdown(); return; }
  curIdx=nxt(dealerIdx);
  pushState({waitFor:players[curIdx].pid});
}

function doShowdown(){
  var cont=players.filter(function(p){return p.active&&!p.folded;});
  var pending=cont.length, holes={};
  cont.forEach(function(p){
    fbGet(holePfx+p.pid, function(h){
      if(h) holes[p.idx]=h;
      if(--pending===0) finishSD(cont,holes);
    });
  });
}
function finishSD(cont,holes){
  cont.forEach(function(p){if(holes[p.idx])p.hole=holes[p.idx];p.best=evalHand(p.hole.concat(comm));});
  cont.sort(function(a,b){return cmpSc(b.best.score,a.best.score);});
  var top=cont[0].best.score;
  var wins=cont.filter(function(p){return cmpSc(p.best.score,top)===0;});
  var share=Math.floor(pot/wins.length); wins.forEach(function(w){w.chips+=share;});
  var body='<span class="wn">'+wins.map(function(w){return w.name;}).join(' & ')+'</span>ã®å‹åˆ©ï¼<br><span class="hn">'+HN[wins[0].best.score.rank]+'</span><br>ãƒãƒƒãƒˆ: '+pot;
  if(wins.length>1) body+='<br>ï¼ˆ'+share+'ãšã¤å±±åˆ†ã‘ï¼‰';
  body+='<br><br>'; cont.forEach(function(p){body+='<b style="color:#aaa">'+p.name+'</b>: '+HN[p.best.score.rank]+'<br>';});
  var ch=''; wins[0].hole.forEach(function(c){ch+=cH(c);});
  pushState({showdown:{body:body,ch:ch},reveal:holes,waitFor:null});
}

function handleSD(sd){if(!sd)return;renderAll();showMsg('ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³',sd.body,'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){if(isHost)startRound();else showInfo('æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾…ã£ã¦ã„ã¾ã™...');},sd.ch||'');}
function handleResult(rr){if(!rr||!rr.title)return;renderAll();showMsg(rr.title,rr.body,'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){if(isHost)startRound();else showInfo('æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾…ã£ã¦ã„ã¾ã™...');},rr.ch||'');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAction(){
  var p=players[myIdx];if(!p)return;
  document.getElementById('ap-who').textContent=p.name+' ã®ã‚¿ãƒ¼ãƒ³ï¼ˆã‚ãªãŸï¼‰';
  var toC=curBet-p.bet;
  document.getElementById('ap-info').textContent='ãƒãƒƒãƒ—: '+p.chips+'  ã‚³ãƒ¼ãƒ«: '+Math.min(toC,p.chips);
  var h=myHole.length?myHole:p.hole;
  document.getElementById('hdisp').innerHTML=cH(h[0])+cH(h[1]);
  var minR=Math.min(curBet+lastRaise,p.chips+p.bet), maxR=p.chips+p.bet;
  var sl=document.getElementById('rslider');
  sl.min=minR;sl.max=maxR;sl.value=minR;
  document.getElementById('rinp').value=minR;
  sl.oninput=function(){document.getElementById('rinp').value=this.value;};
  document.getElementById('rinp').oninput=function(){sl.value=Math.min(Math.max(+this.value||0,minR),maxR);};
  var pr=document.getElementById('prow');pr.innerHTML='';
  [['1/3P',Math.round(pot/3)],['1/2P',Math.round(pot/2)],['POT',pot],['2Ã—BB',BB*2]].forEach(function(x){
    var b=document.createElement('button');b.className='pbtn';
    var v=Math.min(Math.max(x[1],minR),maxR);
    b.textContent=x[0]+'('+v+')';b.onclick=function(){sl.value=v;document.getElementById('rinp').value=v;};
    pr.appendChild(b);
  });
  var br=document.getElementById('brow');br.innerHTML='';
  function ab(lbl,cls,fn){var b=document.createElement('button');b.className='ab '+cls;b.textContent=lbl;b.onclick=fn;br.appendChild(b);}
  ab('ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','ab-fold',function(){send('fold',0);});
  if(toC<=0) ab('ãƒã‚§ãƒƒã‚¯','ab-check',function(){send('check',0);});
  else ab('ã‚³ãƒ¼ãƒ«('+Math.min(toC,p.chips)+')','ab-call',function(){send('call',0);});
  if(p.chips>toC) ab('ãƒ¬ã‚¤ã‚º','ab-raise',function(){send('raise',+document.getElementById('rinp').value||0);});
  ab('ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³','ab-allin',function(){send('allin',0);});
}

function send(action,amount){
  document.getElementById('ap').style.display='none';
  showInfo('é€ä¿¡ä¸­...');
  var d={playerIdx:myIdx,action:action,amount:amount,ts:Date.now()};
  if(isHost){lastActTs=d.ts;applyAction(d);renderAll();advance();}
  else fbSet(gamePath+'/action',d);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æç”»
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  var area=document.getElementById('seats');area.innerHTML='';
  players.forEach(function(p,i){
    if(!p.active)return;
    var s=document.createElement('div');s.className='seat';
    if(i===curIdx) s.classList.add(p.isMe?'myturn':'waiting');
    if(p.folded) s.classList.add('folded');
    if(i===dealerIdx) s.classList.add('dealer');
    var h=p.isMe?(myHole.length?myHole:p.hole):p.hole;
    var show=(phase>=4&&!p.folded&&h&&h.length===2)||p.isMe;
    var ch=show&&h&&h.length===2?(cH(h[0],true)+cH(h[1],true)):'<div class="card sm back"></div><div class="card sm back"></div>';
    var st=p.folded?'FOLD':p.allIn?'ALL IN':i===curIdx?(p.isMe?'â–¶ ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³':'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸­...'):'';
    s.innerHTML='<div class="sname">'+p.name+(p.isMe?' â­':'')+'</div>'+
      '<div class="schips">'+p.chips+' ğŸª™</div>'+
      '<div class="sbet">'+(p.bet?'BET: '+p.bet:'')+'</div>'+
      '<div class="scards">'+ch+'</div>'+
      '<div class="sst">'+st+'</div>';
    area.appendChild(s);
  });
  var cc=document.getElementById('comm-cards');cc.innerHTML='';
  for(var i=0;i<5;i++) cc.innerHTML+=i<comm.length?cH(comm[i]):'<div class="card back"></div>';
  document.getElementById('pot').textContent='POT: '+pot;
  document.getElementById('phase').textContent=PNAMES[Math.min(phase,4)]||'SHOWDOWN';
}
function showInfo(m){document.getElementById('ibar').classList.add('show');document.getElementById('ibar-t').textContent=m;}
function hideInfo(){document.getElementById('ibar').classList.remove('show');}
function showMsg(title,body,lbl,fn,ch){
  document.getElementById('mover').classList.add('show');
  document.getElementById('mtitle').textContent=title;
  document.getElementById('mbody').innerHTML=body;
  document.getElementById('mcards').innerHTML=ch||'';
  var btn=document.getElementById('mnext');btn.textContent=lbl;
  btn.onclick=function(){document.getElementById('mover').classList.remove('show');fn();};
}
function showScreen(id){
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById(id).classList.add('active');
}

})();
</script>

</body>
</html>
