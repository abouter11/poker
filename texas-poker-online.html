<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Texas Hold'em Online</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
:root{--gold:#c9a84c;--gold-light:#f0d080;--gold-dark:#8a6820;--felt:#1a4a2e;--felt-dark:#0d2e1c;--felt-light:#235c39;--red:#c0392b;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:radial-gradient(ellipse at 50%,#1e5535 0%,#0a2010 100%);min-height:100vh;font-family:'Crimson Text',serif;color:#fff;overflow-x:hidden;}
.screen{display:none;min-height:100vh;flex-direction:column;align-items:center;padding:20px 16px 40px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.screen.active{display:flex;}
.logo{font-family:'Cinzel',serif;font-size:clamp(20px,6vw,44px);font-weight:900;background:linear-gradient(135deg,#8a6820,#f0d080,#c9a84c,#f0d080,#8a6820);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:3px;text-align:center;margin:16px 0 4px;}
.logo-sub{font-family:'Cinzel',serif;font-size:11px;color:var(--gold);letter-spacing:6px;text-align:center;margin-bottom:12px;opacity:.7;}
.badge{font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;padding:4px 14px;border-radius:20px;margin-bottom:14px;text-align:center;}
.b-ok{color:#0f0;background:rgba(0,200,0,.12);border:1px solid rgba(0,200,0,.3);}
.b-info{color:#4af;background:rgba(0,150,255,.12);border:1px solid rgba(0,150,255,.3);}
.b-err{color:#f88;background:rgba(255,60,60,.12);border:1px solid rgba(255,60,60,.3);}
.panel{background:linear-gradient(145deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(201,168,76,.3);border-radius:16px;padding:20px;width:100%;max-width:480px;margin-bottom:14px;}
.ptitle{font-family:'Cinzel',serif;font-size:11px;color:var(--gold);letter-spacing:3px;margin-bottom:14px;text-align:center;}
.flabel{font-size:11px;color:rgba(201,168,76,.7);letter-spacing:2px;font-family:'Cinzel',serif;margin-bottom:5px;display:block;}
.inp{width:100%;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:10px 14px;color:#fff;font-family:'Crimson Text',serif;font-size:15px;outline:none;margin-bottom:10px;}
.inp:focus{border-color:var(--gold);}
.inp::placeholder{color:rgba(255,255,255,.2);}
.num-inp{width:90px;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:8px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:13px;outline:none;text-align:center;}
.row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.gap{display:flex;gap:8px;align-items:center;}
.btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--gold-dark),var(--gold),var(--gold-dark));border:none;border-radius:10px;color:#1a0a00;font-family:'Cinzel',serif;font-size:13px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-top:8px;}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn:active:not(:disabled){transform:scale(.98);}
.btn-sm{padding:9px 14px;background:rgba(201,168,76,.2);border:1px solid var(--gold);border-radius:8px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:11px;cursor:pointer;white-space:nowrap;}
.slabel{font-family:'Cinzel',serif;font-size:10px;color:rgba(201,168,76,.6);letter-spacing:2px;margin:10px 0 7px;text-transform:uppercase;}
.code-big{font-family:'Cinzel',serif;font-size:36px;letter-spacing:10px;color:var(--gold-light);text-align:center;padding:12px 0;background:rgba(0,0,0,.4);border-radius:10px;margin:8px 0;cursor:pointer;}
.code-hint{font-size:11px;color:rgba(255,255,255,.3);text-align:center;margin-bottom:6px;}
.plist{display:flex;flex-direction:column;gap:5px;margin:8px 0;}
.pitem{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(0,0,0,.3);border-radius:8px;font-size:13px;}
.dot{width:8px;height:8px;border-radius:50%;background:#0f0;flex-shrink:0;}
.htag{font-family:'Cinzel',serif;font-size:9px;color:#fd0;background:rgba(255,200,0,.15);border:1px solid rgba(255,200,0,.3);border-radius:4px;padding:1px 6px;margin-left:auto;}
.smsg{font-size:12px;text-align:center;padding:7px;border-radius:8px;margin-top:6px;}
.s-ok{color:#0f0;}.s-err{color:#f88;}.s-info{color:#4af;}
/* game */
#screen-game{padding:10px;align-items:stretch;}
.felt{width:100%;max-width:700px;background:radial-gradient(ellipse at center,var(--felt-light),var(--felt) 60%,var(--felt-dark));border-radius:100px;border:5px solid var(--gold-dark);box-shadow:0 0 0 2px var(--gold),0 8px 40px rgba(0,0,0,.7),inset 0 0 40px rgba(0,0,0,.3);padding:20px 24px;display:flex;flex-direction:column;align-items:center;gap:8px;min-height:180px;margin:0 auto 10px;}
#comm-cards{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
#pot{font-family:'Cinzel',serif;font-size:12px;color:var(--gold-light);background:rgba(0,0,0,.4);padding:4px 16px;border-radius:20px;border:1px solid rgba(201,168,76,.3);}
#phase{font-family:'Cinzel',serif;font-size:10px;letter-spacing:4px;color:rgba(255,255,255,.35);}
#seats{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:6px;width:100%;max-width:700px;margin:0 auto 8px;}
.seat{background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.2);border-radius:12px;padding:8px;text-align:center;position:relative;}
.seat.myturn{border-color:var(--gold);background:rgba(201,168,76,.12);box-shadow:0 0 18px rgba(201,168,76,.3);}
.seat.waiting{border-color:#fa0;animation:wp .9s infinite alternate;}
@keyframes wp{from{box-shadow:0 0 6px rgba(255,165,0,.2);}to{box-shadow:0 0 20px rgba(255,165,0,.5);}}
.seat.folded{opacity:.4;}
.seat.dealer::before{content:'D';position:absolute;top:-8px;left:-8px;width:19px;height:19px;background:var(--gold);color:#000;border-radius:50%;font-family:'Cinzel',serif;font-size:9px;font-weight:700;line-height:19px;text-align:center;}
.sname{font-family:'Cinzel',serif;font-size:10px;color:var(--gold-light);margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.schips{font-size:11px;color:rgba(255,255,255,.65);}
.sbet{font-size:10px;color:#f0d080;min-height:14px;}
.scards{display:flex;gap:3px;justify-content:center;margin-top:4px;}
.sst{font-size:9px;color:rgba(255,255,255,.35);min-height:12px;}
.card{width:36px;height:52px;background:#faf8f0;border-radius:4px;border:1px solid #ccc;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#1a1a1a;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,.4);}
.card.red{color:var(--red);}.card.back{background:linear-gradient(135deg,#1a3a6a,#0d1f40);border-color:var(--gold-dark);}
.cr{font-size:12px;font-family:'Cinzel',serif;line-height:1;}.cs{font-size:13px;line-height:1;}
.card.sm{width:28px;height:40px;}.card.sm .cr{font-size:9px;}.card.sm .cs{font-size:10px;}
#ap{width:100%;max-width:700px;margin:0 auto;background:rgba(0,0,0,.6);border:1px solid rgba(201,168,76,.25);border-radius:14px;padding:12px;}
#ap-hd{display:flex;justify-content:space-between;margin-bottom:10px;}
#ap-who{font-family:'Cinzel',serif;font-size:12px;color:var(--gold-light);}
#ap-info{font-size:11px;color:rgba(255,255,255,.45);}
#hdisp{display:flex;gap:8px;justify-content:center;margin-bottom:10px;}
.prow{display:flex;gap:4px;margin-bottom:6px;flex-wrap:wrap;}
.pbtn{flex:1;min-width:44px;padding:4px 2px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25);border-radius:5px;color:var(--gold);font-family:'Cinzel',serif;font-size:8px;cursor:pointer;text-align:center;}
#rrow{display:none;}
#rrow label{font-size:10px;color:var(--gold);white-space:nowrap;font-family:'Cinzel',serif;}
#rinp{flex:1;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.4);border-radius:7px;padding:7px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:14px;outline:none;text-align:center;}
#rslider{width:100%;margin-bottom:8px;accent-color:var(--gold);}
.brow{display:flex;gap:6px;flex-wrap:wrap;}
.ab{flex:1;min-width:65px;padding:10px 4px;border:none;border-radius:8px;font-family:'Cinzel',serif;font-size:10px;cursor:pointer;font-weight:700;}
.ab:active{transform:scale(.97);}
.ab-fold{background:rgba(150,40,40,.8);color:#ffaaaa;border:1px solid rgba(200,60,60,.5);}
.ab-check{background:rgba(40,100,180,.8);color:#aaddff;border:1px solid rgba(60,130,210,.5);}
.ab-call{background:rgba(30,130,100,.8);color:#aaffdd;border:1px solid rgba(50,160,120,.5);}
.ab-raise{background:rgba(180,120,20,.85);color:#fff5cc;border:1px solid rgba(201,168,76,.6);}
.ab-allin{background:linear-gradient(135deg,#7a0000,#c00);color:#fff;border:1px solid #f00;}
#ibar{width:100%;max-width:700px;margin:0 auto 6px;background:rgba(0,0,0,.5);border:1px solid rgba(255,165,0,.3);border-radius:10px;padding:8px;text-align:center;display:none;}
#ibar.show{display:block;}
#ibar-t{font-family:'Cinzel',serif;font-size:11px;color:#fa0;}
#mover{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;align-items:center;justify-content:center;padding:20px;}
#mover.show{display:flex;}
.mcard{background:linear-gradient(145deg,#1a2a10,#0d1a08);border:2px solid var(--gold);border-radius:20px;padding:24px;text-align:center;max-width:440px;width:100%;}
.mtitle{font-family:'Cinzel',serif;font-size:18px;color:var(--gold-light);margin-bottom:10px;}
.mbody{font-size:13px;color:rgba(255,255,255,.8);line-height:1.8;margin-bottom:14px;}
.mbody .wn{color:var(--gold-light);font-size:15px;font-weight:600;}.mbody .hn{color:#aaffaa;font-size:11px;}
.mcards{display:flex;gap:6px;justify-content:center;margin:8px 0;flex-wrap:wrap;width:100%;}
.mnext{padding:12px 28px;background:linear-gradient(135deg,var(--gold-dark),var(--gold));border:none;border-radius:10px;color:#1a0a00;font-family:'Cinzel',serif;font-size:12px;font-weight:700;cursor:pointer;}

/* ãƒãƒƒãƒ—è¡¨ç¤º */
.chips-stack{display:flex;flex-wrap:wrap;gap:2px;justify-content:center;align-items:center;}
.chip{width:26px;height:26px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-family:â€˜Cinzelâ€™,serif;font-size:8px;font-weight:700;border:2px dashed rgba(255,255,255,.5);box-shadow:0 2px 6px rgba(0,0,0,.6),inset 0 1px 3px rgba(255,255,255,.35);position:relative;flex-shrink:0;letter-spacing:-0.5px;}
.chip-500{background:radial-gradient(circle at 35% 35%,#b06fe0,#7d3fb5);color:#fff;}
.chip-100{background:radial-gradient(circle at 35% 35%,#4a6080,#2c3e50);color:#fff;}
.chip-25{background:radial-gradient(circle at 35% 35%,#27ae60,#1e8449);color:#fff;}
.chip-10{background:radial-gradient(circle at 35% 35%,#2980b9,#1a5276);color:#fff;}
.chip-5{background:radial-gradient(circle at 35% 35%,#e74c3c,#c0392b);color:#fff;}
.chip-1{background:radial-gradient(circle at 35% 35%,#ecf0f1,#bdc3c7);color:#333;}
/* ãƒãƒƒãƒ—é¸æŠUI */
.chip-selector{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:10px;}
.chip-sel-btn{width:46px;height:46px;border-radius:50%;border:3px solid rgba(255,255,255,.25);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:â€˜Cinzelâ€™,serif;font-weight:700;box-shadow:0 3px 8px rgba(0,0,0,.5),inset 0 1px 3px rgba(255,255,255,.25);transition:all .15s;position:relative;flex-shrink:0;}
.chip-sel-btn:active{transform:scale(.92);}
.chip-sel-btn.sel{border-color:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.5),0 3px 8px rgba(0,0,0,.5);}
.chip-sel-btn .cl{font-size:9px;line-height:1;}
.chip-sel-btn .cv{font-size:11px;line-height:1;}
.chip-sel-500{background:radial-gradient(circle at 35% 35%,#9b59b6,#6c3483);color:#fff;}
.chip-sel-100{background:radial-gradient(circle at 35% 35%,#2c3e50,#1a252f);color:#fff;}
.chip-sel-25{background:radial-gradient(circle at 35% 35%,#27ae60,#1e8449);color:#fff;}
.chip-sel-10{background:radial-gradient(circle at 35% 35%,#2980b9,#1a5276);color:#fff;}
.chip-sel-5{background:radial-gradient(circle at 35% 35%,#e74c3c,#c0392b);color:#fff;}
.bet-display{font-family:â€˜Cinzelâ€™,serif;font-size:22px;color:var(â€“gold-light);text-align:center;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.4);border-radius:10px;padding:8px 16px;margin-bottom:8px;letter-spacing:2px;}
.bet-sub{font-size:11px;color:rgba(255,255,255,.4);text-align:center;margin-bottom:8px;}
.chip-count{position:absolute;top:-4px;right:-4px;background:#000;color:#fd0;border-radius:6px;font-size:6px;padding:0 2px;font-family:â€˜Cinzelâ€™,serif;font-weight:700;line-height:10px;min-width:10px;text-align:center;}
.chips-total{font-family:â€˜Cinzelâ€™,serif;font-size:10px;color:var(â€“gold-light);margin-top:2px;}
@keyframes cpuprog{from{width:0}to{width:100%}}

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒãƒ–ãƒ« */
.action-bubble{position:absolute;top:-28px;left:50%;transform:translateX(-50%);
background:rgba(0,0,0,.85);border:1px solid var(â€“gold);border-radius:10px;
padding:3px 10px;font-family:â€˜Cinzelâ€™,serif;font-size:10px;white-space:nowrap;
z-index:10;pointer-events:none;animation:bubblePop .25s ease;}
.action-bubble.ab-fold{border-color:#e74c3c;color:#f88;}
.action-bubble.ab-check{border-color:#3498db;color:#adf;}
.action-bubble.ab-call{border-color:#27ae60;color:#afd;}
.action-bubble.ab-raise{border-color:var(â€“gold);color:var(â€“gold-light);}
.action-bubble.ab-allin{border-color:#e74c3c;color:#f00;font-weight:700;}
@keyframes bubblePop{from{opacity:0;transform:translateX(-50%) scale(.7);}to{opacity:1;transform:translateX(-50%) scale(1);}}
/* ãƒ•ã‚§ãƒ¼ã‚ºç§»è¡Œã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#phase-overlay{display:none;position:fixed;inset:0;z-index:50;align-items:center;justify-content:center;pointer-events:none;}
#phase-overlay.show{display:flex;}
#phase-card{background:linear-gradient(135deg,rgba(10,30,15,.95),rgba(5,15,8,.98));
border:2px solid var(â€“gold);border-radius:18px;padding:20px 36px;text-align:center;
animation:phaseIn .4s ease forwards;}
@keyframes phaseIn{from{opacity:0;transform:scale(.6);}to{opacity:1;transform:scale(1);}}
#phase-name{font-family:â€˜Cinzelâ€™,serif;font-size:26px;font-weight:900;
background:linear-gradient(135deg,#8a6820,#f0d080,#c9a84c);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
letter-spacing:6px;margin-bottom:6px;}
#phase-cards-row{display:flex;gap:8px;justify-content:center;margin-top:8px;}
</style>

</head>
<body>

<!-- ãƒ­ãƒ“ãƒ¼ -->

<div id="screen-lobby" class="screen active">
  <div class="logo">TEXAS HOLD'EM</div>
  <div class="logo-sub">ONLINE POKER</div>
  <div id="conn-badge" class="badge b-info">æ¥ç¶šç¢ºèªä¸­...</div>

  <div class="panel" style="text-align:center;padding:14px 20px;">
    <div class="ptitle">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</div>
    <div style="display:flex;gap:8px;">
      <button id="btn-mode-online" style="flex:1;padding:12px 4px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:10px;color:rgba(255,255,255,.6);font-family:'Cinzel',serif;font-size:11px;letter-spacing:1px;cursor:pointer;opacity:0.4;">ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³<br><span style="font-size:9px;opacity:.7;">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰å¯¾æˆ¦</span></button>
      <button id="btn-mode-offline" style="flex:1;padding:12px 4px;background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:10px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:11px;letter-spacing:1px;cursor:pointer;">ğŸ¤– ã‚ªãƒ•ãƒ©ã‚¤ãƒ³<br><span style="font-size:9px;opacity:.7;">CPUå¯¾æˆ¦</span></button>
    </div>
  </div>

  <!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¨­å®šãƒ‘ãƒãƒ« -->

  <div id="panel-offline" class="panel" style="display:none;">
    <div class="ptitle">ğŸ¤– CPUå¯¾æˆ¦è¨­å®š</div>
    <label class="flabel">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
    <input class="inp" id="off-name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1">
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">é–‹å§‹ãƒãƒƒãƒ—</span><input class="num-inp" id="off-chips" value="500"></div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">CPUäººæ•°</span>
      <div style="display:flex;gap:6px;">
        <button class="cpu-cnt-btn" data-n="1" style="padding:6px 12px;background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:6px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:12px;cursor:pointer;">1</button>
        <button class="cpu-cnt-btn" data-n="2" style="padding:6px 12px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:'Cinzel',serif;font-size:12px;cursor:pointer;">2</button>
        <button class="cpu-cnt-btn" data-n="3" style="padding:6px 12px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:'Cinzel',serif;font-size:12px;cursor:pointer;">3</button>
        <button class="cpu-cnt-btn" data-n="4" style="padding:6px 12px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:'Cinzel',serif;font-size:12px;cursor:pointer;">4</button>
        <button class="cpu-cnt-btn" data-n="5" style="padding:6px 12px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:'Cinzel',serif;font-size:12px;cursor:pointer;">5</button>
      </div>
    </div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">é›£æ˜“åº¦</span>
      <div style="display:flex;gap:6px;">
        <button class="diff-btn" data-d="easy" style="padding:6px 10px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:'Cinzel',serif;font-size:10px;cursor:pointer;">EASY</button>
        <button class="diff-btn" data-d="normal" style="padding:6px 10px;background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:6px;color:var(--gold-light);font-family:'Cinzel',serif;font-size:10px;cursor:pointer;">NORMAL</button>
        <button class="diff-btn" data-d="hard" style="padding:6px 10px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:'Cinzel',serif;font-size:10px;cursor:pointer;">HARD</button>
      </div>
    </div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">SB</span><input class="num-inp" id="off-sb" value="5"></div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">BB</span><input class="num-inp" id="off-bb" value="10"></div>
    <button class="btn" id="btn-start-offline">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
  </div>

  <div id="panel-online">
  <div class="panel">
    <div class="ptitle">ã‚ãªãŸã®æƒ…å ±</div>
    <label class="flabel">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
    <input class="inp" id="my-name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1">
    <div class="row">
      <span style="font-size:12px;color:rgba(255,255,255,.5);">é–‹å§‹ãƒãƒƒãƒ—</span>
      <input class="num-inp" id="my-chips" value="500">
    </div>
  </div>

  <div class="panel">
    <div class="ptitle">ğŸ  ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">SB</span><input class="num-inp" id="room-sb" value="5"></div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">BB</span><input class="num-inp" id="room-bb" value="10"></div>
    <button class="btn" id="btn-create">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
    <div id="room-created" style="display:none;margin-top:14px;">
      <div class="slabel">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼ï¼‰</div>
      <div class="code-big" id="code-disp">------</div>
      <div class="code-hint">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å¯¾æˆ¦ç›¸æ‰‹ã«ã‚·ã‚§ã‚¢</div>
      <div class="slabel">å‚åŠ è€…</div>
      <div class="plist" id="plist"></div>
      <div id="room-msg" class="smsg s-info">å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
      <button class="btn" id="btn-start" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    </div>
  </div>

  <div class="panel">
    <div class="ptitle">ğŸšª ãƒ«ãƒ¼ãƒ ã«å‚åŠ </div>
    <div class="gap">
      <input class="inp" id="join-code" placeholder="XXXXXX" maxlength="6" style="margin-bottom:0;font-family:'Cinzel',serif;font-size:20px;letter-spacing:6px;text-align:center;text-transform:uppercase;color:var(--gold-light);">
      <button class="btn-sm" id="btn-join">å‚åŠ </button>
    </div>
    <div id="join-msg" class="smsg"></div>
  </div>
  </div> <!-- /panel-online -->
</div>

<!-- ã‚²ãƒ¼ãƒ  -->

<div id="screen-game" class="screen">
  <div id="seats"></div>
  <div class="felt">
    <div id="phase">WAITING</div>
    <div id="comm-cards"></div>
    <div id="pot">POT: 0</div>
  </div>
  <div id="cpu-bar" style="display:none;width:100%;max-width:700px;margin:0 auto 6px;background:rgba(0,0,0,.5);border:1px solid rgba(0,150,255,.3);border-radius:10px;padding:8px 16px;text-align:center;">
    <div id="cpu-bar-text" style="font-family:'Cinzel',serif;font-size:11px;color:#4af;letter-spacing:2px;">CPUæ€è€ƒä¸­...</div>
    <div style="height:3px;background:rgba(0,150,255,.2);border-radius:2px;margin-top:5px;overflow:hidden;"><div id="cpu-prog" style="height:100%;background:#4af;border-radius:2px;animation:cpuprog 1s linear forwards;"></div></div>
  </div>
  <div id="ibar"><div id="ibar-t"></div></div>
  <div id="ap" style="display:none;">
    <div id="ap-hd"><div id="ap-who"></div><div id="ap-info"></div></div>
    <div id="hdisp"></div>
    <div class="prow" id="prow"></div>
    <div class="bet-display" id="bet-display">0</div>
    <div class="bet-sub" id="bet-sub">BET / RAISE</div>
    <div class="chip-selector" id="chip-selector">
      <button class="chip-sel-btn chip-sel-500" data-v="500" title="500"><div class="cv">500</div></button>
      <button class="chip-sel-btn chip-sel-100" data-v="100" title="100"><div class="cv">100</div></button>
      <button class="chip-sel-btn chip-sel-25"  data-v="25"  title="25"><div class="cv">25</div></button>
      <button class="chip-sel-btn chip-sel-10"  data-v="10"  title="10"><div class="cv">10</div></button>
      <button class="chip-sel-btn chip-sel-5"   data-v="5"   title="5"><div class="cv">5</div></button>
      <button class="chip-sel-btn" data-v="clear" title="ã‚¯ãƒªã‚¢" style="background:rgba(100,0,0,.6);border-color:rgba(255,80,80,.4);color:#f88;font-size:14px;"><div class="cv">âœ•</div></button>
    </div>
    <input type="hidden" id="rinp" value="0">
    <input type="range" id="rslider" style="display:none;">
    <div class="brow" id="brow"></div>
  </div>
</div>

<div id="phase-overlay">
  <div id="phase-card">
    <div id="phase-name">FLOP</div>
    <div id="phase-cards-row"></div>
  </div>
</div>
<div id="mover">
  <div class="mcard">
    <div class="mtitle" id="mtitle"></div>
    <div class="mcards" id="mcards"></div>
    <div class="mbody" id="mbody"></div>
    <button class="mnext" id="mnext">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰</button>
  </div>
</div>

<script>
(function(){
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase REST API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var DB = 'https://poker-cc448-default-rtdb.asia-southeast1.firebasedatabase.app';
var _polls = {};

function fbUrl(path){ return DB + '/' + path + '.json'; }

function fbGet(path, cb){
  fetch(fbUrl(path))
    .then(function(r){ return r.json(); })
    .then(function(d){ cb(d); })
    .catch(function(){ cb(null); });
}
function fbSet(path, val, cb){
  fetch(fbUrl(path), {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(val)})
    .then(function(){ if(cb) cb(); })
    .catch(function(e){ console.error('fbSet', e); if(cb) cb(); });
}
function fbPatch(path, val, cb){
  fetch(fbUrl(path), {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(val)})
    .then(function(){ if(cb) cb(); })
    .catch(function(e){ console.error('fbPatch', e); if(cb) cb(); });
}
function fbListen(path, cb){
  if(!_polls[path]) _polls[path] = {last:null, cbs:[], timer:null};
  _polls[path].cbs.push(cb);
  fbGet(path, function(d){
    _polls[path].last = JSON.stringify(d);
    cb(d);
  });
  if(!_polls[path].timer){
    _polls[path].timer = setInterval(function(){
      fbGet(path, function(d){
        var j = JSON.stringify(d);
        if(j !== _polls[path].last){
          _polls[path].last = j;
          _polls[path].cbs.forEach(function(fn){ fn(d); });
        }
      });
    }, 1500);
  }
}
function fbOff(path){
  if(_polls[path]){ clearInterval(_polls[path].timer); delete _polls[path]; }
}

// æ¥ç¶šç¢ºèªã¯ä¸‹éƒ¨ã®setModeå®šç¾©å¾Œã«å®Ÿè¡Œ


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒãƒƒãƒ—è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CHIP_DENOMS = [500,100,25,10,5];

function snap5(n){ return Math.round(n/5)*5; } // 5å˜ä½ã«ä¸¸ã‚

// â”€â”€ ãƒãƒƒãƒ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼UI â”€â”€
var _chipMinR=0, _chipMaxR=0, _chipInited=false;

function setupChipSelector(minR, maxR){
  _chipMinR=minR; _chipMaxR=maxR;
  document.getElementById('rinp').value=minR;
  // ã‚¤ãƒ™ãƒ³ãƒˆã¯æœ€åˆã®1å›ã ã‘ç™»éŒ²
  if(!_chipInited){
    _chipInited=true;
    document.querySelectorAll('.chip-sel-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        var v=this.dataset.v;
        if(v==='clear'){
          document.getElementById('rinp').value=_chipMinR;
        } else {
          var cur=snap5(+document.getElementById('rinp').value||0);
          var add=snap5(+v);
          var next=Math.min(cur+add, _chipMaxR);
          if(next<_chipMinR) next=_chipMinR;
          document.getElementById('rinp').value=next;
        }
        updateBetDisplay();
      });
    });
  }
  updateBetDisplay();
}

function setChipBet(v, minR, maxR){
  document.getElementById('rinp').value=Math.min(Math.max(snap5(v),minR),maxR);
  updateBetDisplay();
}

function updateBetDisplay(){
  var v=snap5(+document.getElementById('rinp').value||0);
  document.getElementById('rinp').value=v;
  document.getElementById('bet-display').textContent=v;
  document.getElementById('bet-sub').textContent=
    v>=_chipMinR&&v>0 ? 'ãƒ¬ã‚¤ã‚ºé¡ï¼ˆæœ€å° '+_chipMinR+'ï¼‰' : 'BET / RAISE';
  // ãƒãƒƒãƒ—ãƒœã‚¿ãƒ³ï¼šè¿½åŠ ã™ã‚‹ã¨maxRã‚’è¶…ãˆã‚‹ãªã‚‰ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
  document.querySelectorAll('.chip-sel-btn').forEach(function(btn){
    if(btn.dataset.v==='clear'){ btn.style.opacity='1'; return; }
    var add=snap5(+btn.dataset.v);
    btn.style.opacity=(v+add>_chipMaxR) ? '0.3' : '1';
    btn.style.cursor=(v+add>_chipMaxR) ? 'not-allowed' : 'pointer';
  });
}

function chipsHTML(amount){
  if(!amount || amount<=0) return '<span style="color:rgba(255,255,255,.3);font-size:10px;">-</span>';
  var remain = Math.abs(Math.round(amount));
  var stacks = [];
  CHIP_DENOMS.forEach(function(d){
    var cnt = Math.floor(remain/d);
    if(cnt>0){ stacks.push({d:d,cnt:cnt}); remain-=d*cnt; }
  });
  if(remain>0) stacks.push({d:1,cnt:remain});
  var html = '<div class="chips-stack">';
  stacks.forEach(function(s){
    var cls = 'chip chip-'+s.d;
    var label = s.d===500?'500':s.d===100?'100':(s.d+'');
    html += '<div class="'+cls+'">'+label+(s.cnt>1?'<span class="chip-count">Ã—'+s.cnt+'</span>':'')+'</div>';
  });
  html += '</div><div class="chips-total">'+amount+'</div>';
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚«ãƒ¼ãƒ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SUITS=['â™ ','â™¥','â™¦','â™£'], RANKS=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
var RV={}; RANKS.forEach(function(r,i){RV[r]=i+2;});
var HN=['ãƒã‚¤ã‚«ãƒ¼ãƒ‰','ãƒ¯ãƒ³ãƒšã‚¢','ãƒ„ãƒ¼ãƒšã‚¢','ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰','ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ','ãƒ•ãƒ©ãƒƒã‚·ãƒ¥','ãƒ•ãƒ«ãƒã‚¦ã‚¹','ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰','ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥'];
function makeDeck(){var d=[];SUITS.forEach(function(s){RANKS.forEach(function(r){d.push({r:r,s:s});});});return d;}
function shuffle(a){for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=a[i];a[i]=a[j];a[j]=t;}return a;}
function isRed(s){return s==='â™¥'||s==='â™¦';}
function cH(c,sm){
  if(!c) return '<div class="card'+(sm?' sm':'')+' back"></div>';
  return '<div class="card'+(sm?' sm':'')+(isRed(c.s)?' red':'')+'"><div class="cr">'+c.r+'</div><div class="cs">'+c.s+'</div></div>';
}
function combs(a,k){if(!k)return[[]];if(!a.length)return[];return combs(a.slice(1),k-1).map(function(c){return[a[0]].concat(c);}).concat(combs(a.slice(1),k));}
function sc5(cards){
  var v=cards.map(function(c){return RV[c.r];}).sort(function(a,b){return b-a;});
  var s=cards.map(function(c){return c.s;});
  var fl=s.every(function(x){return x===s[0];});
  var st=false,sh=0;
  if(v[0]-v[4]===4&&(new Set(v)).size===5){st=true;sh=v[0];}
  if(JSON.stringify(v)==='[14,5,4,3,2]'){st=true;sh=5;v=[5,4,3,2,1];}
  var cnt={};v.forEach(function(x){cnt[x]=(cnt[x]||0)+1;});
  var g=Object.keys(cnt).map(function(x){return{v:+x,c:cnt[x]};}).sort(function(a,b){return b.c-a.c||b.v-a.v;});
  var rank,hi;
  if(fl&&st){rank=8;hi=[sh];}else if(g[0].c===4){rank=7;hi=[g[0].v,g[1].v];}
  else if(g[0].c===3&&g[1].c===2){rank=6;hi=[g[0].v,g[1].v];}else if(fl){rank=5;hi=v;}
  else if(st){rank=4;hi=[sh];}else if(g[0].c===3){rank=3;hi=[g[0].v,g[1].v,g[2].v];}
  else if(g[0].c===2&&g[1].c===2){rank=2;hi=[g[0].v,g[1].v,g[2].v];}
  else if(g[0].c===2){rank=1;hi=[g[0].v,g[1].v,g[2].v,g[3].v];}else{rank=0;hi=v;}
  return{rank:rank,hi:hi};
}
function cmpSc(a,b){if(a.rank!==b.rank)return a.rank-b.rank;for(var i=0;i<Math.max(a.hi.length,b.hi.length);i++){var d=(a.hi[i]||0)-(b.hi[i]||0);if(d)return d;}return 0;}
function evalHand(cards){var best=null;combs(cards,5).forEach(function(c){var sc=sc5(c);if(!best||cmpSc(sc,best.score)>0)best={score:sc,cards:c};});return best;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ­ãƒ“ãƒ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ¢ãƒ¼ãƒ‰ãƒ»CPUè¨­å®š
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CPU_NAMES=['ã‚¢ãƒ¬ãƒƒã‚¯ã‚¹','ã‚½ãƒ•ã‚£ã‚¢','ãƒªã‚ªãƒ³','ã‚¨ãƒ','ãƒ«ãƒ¼ã‚«ã‚¹','ãƒŸã‚¢'];
var cpuDifficulty='normal', cpuCount=1, offlineMode=false;

function setMode(mode){
  var onBtn=document.getElementById('btn-mode-online');
  var offBtn=document.getElementById('btn-mode-offline');
  var onPanel=document.getElementById('panel-online');
  var offPanel=document.getElementById('panel-offline');
  if(mode==='online'){
    onBtn.style.background='rgba(201,168,76,.15)';onBtn.style.borderColor='var(--gold)';onBtn.style.color='var(--gold-light)';
    offBtn.style.background='rgba(0,0,0,.3)';offBtn.style.borderColor='rgba(255,255,255,.2)';offBtn.style.color='rgba(255,255,255,.6)';
    onPanel.style.display='block'; offPanel.style.display='none';
  } else {
    offBtn.style.background='rgba(201,168,76,.15)';offBtn.style.borderColor='var(--gold)';offBtn.style.color='var(--gold-light)';
    onBtn.style.background='rgba(0,0,0,.3)';onBtn.style.borderColor='rgba(255,255,255,.2)';onBtn.style.color='rgba(255,255,255,.6)';
    offPanel.style.display='block'; onPanel.style.display='none';
  }
}

// èµ·å‹•æ™‚æ¥ç¶šç¢ºèª â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã€æ¥ç¶šã§ãã‚Œã°ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«åˆ‡æ›¿
(function(){
  // å³åº§ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§èµ·å‹•ï¼ˆfetchãŒå¤±æ•—ã—ã¦ã‚‚ã‚²ãƒ¼ãƒ ãŒéŠã¹ã‚‹ï¼‰
  setMode('offline');
  var el = document.getElementById('conn-badge');
  el.textContent='æ¥ç¶šç¢ºèªä¸­...'; el.className='badge b-info';

  function goOffline(){
    el.textContent='âš  ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆCPUå¯¾æˆ¦ã®ã¿åˆ©ç”¨å¯ï¼‰';
    el.className='badge b-err';
    document.getElementById('btn-mode-online').style.opacity='0.4';
    document.getElementById('btn-mode-online').onclick=function(){
      alert('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¥ç¶šã§ãã¾ã›ã‚“ã€‚WiFiã¾ãŸã¯ãƒ¢ãƒã‚¤ãƒ«é€šä¿¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    };
  }

  var timer = setTimeout(goOffline, 5000);

  try {
    fetch(fbUrl('ping'), {method:'PUT', headers:{'Content-Type':'application/json'}, body:'"ok"'})
      .then(function(r){
        clearTimeout(timer);
        if(r.ok){
          el.textContent='âœ“ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¥ç¶šä¸­'; el.className='badge b-ok';
          document.getElementById('btn-mode-online').style.opacity='1';
          document.getElementById('btn-mode-online').onclick=function(){ setMode('online'); };
          setMode('online');
        } else {
          goOffline();
        }
      })
      .catch(function(){ clearTimeout(timer); goOffline(); });
  } catch(e) {
    clearTimeout(timer);
    goOffline();
  }
})();

// ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®onclickï¼ˆJSå®šç¾©å¾Œã«è¨­å®šï¼‰
document.getElementById('btn-mode-offline').onclick = function(){ setMode('offline'); };
// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã¯goOffline/goOnlineã§è¨­å®šæ¸ˆã¿

// CPUäººæ•°ãƒœã‚¿ãƒ³
document.querySelectorAll('.cpu-cnt-btn').forEach(function(b){
  b.addEventListener('click',function(){
    cpuCount=+this.dataset.n;
    document.querySelectorAll('.cpu-cnt-btn').forEach(function(x){
      x.style.background='rgba(0,0,0,.4)';x.style.borderColor='rgba(255,255,255,.2)';x.style.color='rgba(255,255,255,.5)';
    });
    this.style.background='rgba(201,168,76,.15)';this.style.borderColor='var(--gold)';this.style.color='var(--gold-light)';
  });
});

// é›£æ˜“åº¦ãƒœã‚¿ãƒ³
document.querySelectorAll('.diff-btn').forEach(function(b){
  b.addEventListener('click',function(){
    cpuDifficulty=this.dataset.d;
    document.querySelectorAll('.diff-btn').forEach(function(x){
      x.style.background='rgba(0,0,0,.4)';x.style.borderColor='rgba(255,255,255,.2)';x.style.color='rgba(255,255,255,.5)';
    });
    this.style.background='rgba(201,168,76,.15)';this.style.borderColor='var(--gold)';this.style.color='var(--gold-light)';
  });
});

// ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ é–‹å§‹
document.getElementById('btn-start-offline').addEventListener('click',function(){
  var name=document.getElementById('off-name').value.trim()||'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
  var chips=+document.getElementById('off-chips').value||500;
  SB=+document.getElementById('off-sb').value||5;
  BB=+document.getElementById('off-bb').value||10;
  offlineMode=true;
  var ps=[{name:name,chips:chips,pid:'human',isMe:true,idx:0,isCpu:false,
           hole:[],bet:0,totalBet:0,folded:false,allIn:false,active:true}];
  for(var i=0;i<cpuCount;i++){
    ps.push({name:CPU_NAMES[i],chips:chips,pid:'cpu'+i,isMe:false,idx:i+1,isCpu:true,
             hole:[],bet:0,totalBet:0,folded:false,allIn:false,active:true});
  }
  launchOffline(ps);
});

function launchOffline(ps){
  players=ps;
  ps.forEach(function(p,i){if(p.isMe)myIdx=i;});
  gamePath=''; holePfx='';
  showScreen('screen-game');
  startRoundOffline();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CPU AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function preflopStrength(hole){
  var RV2={'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};
  var r1=RV2[hole[0].r],r2=RV2[hole[1].r];
  var suited=hole[0].s===hole[1].s,hi=Math.max(r1,r2),lo=Math.min(r1,r2);
  var s=hi/14*0.6;
  if(r1===r2)s+=0.3;if(suited)s+=0.05;if(hi-lo<=3)s+=0.05;if(lo>=10)s+=0.1;
  return Math.min(s,1);
}
function handStrengthCpu(hole,community){
  if(!community.length) return preflopStrength(hole);
  var r=evalHand(hole.concat(community));
  return Math.min(r.score.rank/8+(r.score.hi[0]||0)/14*0.05,1);
}
function cpuDecide(p,state){
  var diff=state.difficulty,str=handStrengthCpu(p.hole,state.community);
  var potVal=state.pot,toCall=state.curBet-p.bet,canCheck=toCall<=0;
  var potOdds=potVal>0?toCall/(potVal+toCall):0;
  var noise=diff==='easy'?(Math.random()-.5)*.35:diff==='normal'?(Math.random()-.5)*.18:(Math.random()-.5)*.08;
  var eff=Math.min(1,Math.max(0,str+noise+(state.phase>=2?.05:0)));
  var bluff=Math.random()<(diff==='easy'?.04:diff==='normal'?.10:.18)&&p.chips>toCall*2;
  var BB2=state.BB;
  if(bluff&&!canCheck){var ra=Math.min(p.chips+p.bet,state.curBet+Math.max(BB2,Math.floor(potVal*.5)));return{action:'raise',amount:ra,label:'RAISE'};}
  if(canCheck){
    if(eff>.72){var bet=Math.min(p.chips+p.bet,state.curBet+Math.floor(potVal*(.5+eff*.5)));return{action:'raise',amount:bet,label:'BET'};}
    return{action:'check',label:'CHECK'};
  }
  if(eff>.82){var ra2=Math.min(p.chips+p.bet,state.curBet+Math.floor(potVal*(.6+eff*.4)));if(ra2<=state.curBet)return{action:'call',label:'CALL'};return{action:'raise',amount:ra2,label:'RAISE'};}
  if(eff>potOdds+.1) return{action:'call',label:'CALL'};
  if(diff==='easy'&&eff>.2) return{action:'call',label:'CALL'};
  return{action:'fold',label:'FOLD'};
}

function showCpuThinking(p,cb){
  var bar=document.getElementById('cpu-bar');bar.style.display='block';
  document.getElementById('cpu-bar-text').textContent=p.name+' ãŒè€ƒãˆã¦ã„ã¾ã™...';
  var prog=document.getElementById('cpu-prog');
  prog.style.animation='none';prog.offsetHeight;prog.style.animation='cpuprog 1s linear forwards';
  setTimeout(cb,600+Math.random()*900);
}
function hideCpuBar(){document.getElementById('cpu-bar').style.display='none';}

// â”€â”€ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ— â”€â”€
function startRoundOffline(){
  deck=shuffle(makeDeck());comm=[];pot=0;phase=0;curBet=0;lastRaise=BB;acts=[];
  players.forEach(function(p){if(p.chips<=0)p.active=false;p.hole=[];p.bet=0;p.totalBet=0;p.folded=false;p.allIn=false;});
  var active=players.filter(function(p){return p.active;});
  if(active.length<2){
    var w=active[0]||players[0];
    showMsg('ã‚²ãƒ¼ãƒ çµ‚äº†','<span class="wn">'+w.name+'</span>ã®å„ªå‹ï¼','ã‚‚ã†ä¸€åº¦',function(){showScreen('screen-lobby');offlineMode=false;});
    return;
  }
  dealerIdx=(dealerIdx+1)%players.length;
  while(!players[dealerIdx].active)dealerIdx=(dealerIdx+1)%players.length;
  active.forEach(function(p){p.hole=[deck.pop(),deck.pop()];if(p.isMe)myHole=p.hole;});
  var sb=nxt(dealerIdx),bb=nxt(sb);
  blind(players[sb],SB);blind(players[bb],BB);
  curBet=BB;lastRaise=BB;curIdx=nxt(bb);acts=[players[sb].idx];
  renderAll();
  scheduleOfflineAction();
}

function scheduleOfflineAction(){
  var p=players[curIdx];
  if(!p||!p.active||p.folded||p.allIn){advanceOffline();return;}
  if(p.isCpu){
    hideCpuBar();
    showCpuThinking(p,function(){
      var dec=cpuDecide(p,{difficulty:cpuDifficulty,community:comm,pot:pot,curBet:curBet,phase:phase,BB:BB});
      applyCpuAction(p,dec);
      renderAll();
      showActionBubble(curIdx, dec.action, dec.amount||0);
      setTimeout(function(){ advanceOffline(); }, 600);
    });
  } else {
    hideCpuBar();
    hideInfo();
    document.getElementById('ap').style.display='block';
    renderActionOffline();
  }
}

function applyCpuAction(p,dec){
  if(dec.action==='fold'){p.folded=true;}
  else if(dec.action==='check'){}
  else if(dec.action==='call'){var tc=Math.min(curBet-p.bet,p.chips);p.chips-=tc;p.bet+=tc;p.totalBet+=tc;pot+=tc;if(!p.chips)p.allIn=true;}
  else if(dec.action==='raise'){var nb=Math.min(Math.max(dec.amount,curBet+1),p.chips+p.bet);lastRaise=Math.max(nb-curBet,lastRaise);curBet=nb;var cost=nb-p.bet;p.chips-=cost;p.bet=nb;p.totalBet+=cost;pot+=cost;if(!p.chips)p.allIn=true;acts=[curIdx];}
  if(acts.indexOf(curIdx)<0)acts.push(curIdx);
}

function advanceOffline(){
  var nf=players.filter(function(p){return p.active&&!p.folded;});
  if(nf.length===1){nf[0].chips+=pot;renderAll();showMsg('ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†','<span class="wn">'+nf[0].name+'</span>ã®å‹åˆ©ï¼ï¼ˆå…¨å“¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ï¼‰','æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){startRoundOffline();});return;}
  var ca=players.filter(function(p){return p.active&&!p.folded&&!p.allIn;});
  if(ca.length<=1||(ca.every(function(p){return acts.indexOf(p.idx)>=0;})&&ca.every(function(p){return p.bet===curBet;}))){nextPhaseOffline();return;}
  curIdx=nxt(curIdx);renderAll();scheduleOfflineAction();
}

function nextPhaseOffline(){
  players.forEach(function(p){p.bet=0;});curBet=0;lastRaise=BB;acts=[];phase++;
  var newCards=[];
  if(phase===1){var c1=deck.pop(),c2=deck.pop(),c3=deck.pop();comm.push(c1,c2,c3);newCards=[c1,c2,c3];}
  else if(phase===2){var c=deck.pop();comm.push(c);newCards=[c];}
  else if(phase===3){var c=deck.pop();comm.push(c);newCards=[c];}
  else if(phase>=4){doShowdownOffline();return;}
  curIdx=nxt(dealerIdx);
  renderAll();
  showPhaseOverlay(PNAMES[phase]||'', newCards, function(){scheduleOfflineAction();});
}

function doShowdownOffline(){
  var cont=players.filter(function(p){return p.active&&!p.folded;});
  cont.forEach(function(p){p.best=evalHand(p.hole.concat(comm));});
  cont.sort(function(a,b){return cmpSc(b.best.score,a.best.score);});
  var top=cont[0].best.score;
  var wins=cont.filter(function(p){return cmpSc(p.best.score,top)===0;});
  var share=snap5(Math.floor(pot/wins.length));wins.forEach(function(w){w.chips+=share;});
  var body='<span class="wn">'+wins.map(function(w){return w.name;}).join(' & ')+'</span>ã®å‹åˆ©ï¼<br><span class="hn">'+HN[wins[0].best.score.rank]+'</span><br>ãƒãƒƒãƒˆ: '+pot;
  if(wins.length>1)body+='<br>ï¼ˆ'+share+'ãšã¤å±±åˆ†ã‘ï¼‰';
  body+='<br><br>';cont.forEach(function(p){body+='<b style="color:#aaa">'+p.name+'</b>: '+HN[p.best.score.rank]+'<br>';});
  var ch='<div style="width:100%;text-align:left;">';
  cont.forEach(function(p){
    var isW=wins.indexOf(p)>=0;
    ch+='<div style="margin-bottom:8px;padding:6px 8px;border-radius:8px;background:'+(isW?'rgba(201,168,76,.15)':'rgba(0,0,0,.3)')+';border:1px solid '+(isW?'rgba(201,168,76,.5)':'rgba(255,255,255,.1)')+';">';
    ch+='<div style="font-family:\'Cinzel\',serif;font-size:10px;color:'+(isW?'var(--gold-light)':'rgba(255,255,255,.6)')+';margin-bottom:4px;">'+(isW?'ğŸ† ':'')+p.name+' â€” '+HN[p.best.score.rank]+'</div>';
    ch+='<div style="display:flex;gap:4px;">';
    p.hole.forEach(function(c){ch+=cH(c);});
    ch+='</div></div>';
  });
  ch+='</div>';
  renderAll();showMsg('ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³',body,'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){startRoundOffline();},ch);
}

function renderActionOffline(){
  var p=players[myIdx];if(!p)return;
  document.getElementById('ap-who').textContent=p.name+' ã®ã‚¿ãƒ¼ãƒ³ï¼ˆã‚ãªãŸï¼‰';
  var toC=curBet-p.bet;
  document.getElementById('ap-info').innerHTML='<span style="opacity:.6">æ‰‹æŒã¡</span> '+p.chips+' &nbsp;<span style="opacity:.6">ã‚³ãƒ¼ãƒ«</span> '+Math.min(toC,p.chips);
  var h=myHole.length?myHole:p.hole;
  document.getElementById('hdisp').innerHTML=cH(h[0])+cH(h[1]);
  var minR=snap5(Math.min(curBet+lastRaise,p.chips+p.bet)),maxR=p.chips+p.bet;
  setupChipSelector(minR, maxR);
  var pr=document.getElementById('prow');pr.innerHTML='';
  [['1/3P',snap5(Math.round(pot/3))],['1/2P',snap5(Math.round(pot/2))],['POT',snap5(pot)],['2Ã—BB',snap5(BB*2)]].forEach(function(x){
    var b=document.createElement('button');b.className='pbtn';
    var v=Math.min(Math.max(x[1],minR),maxR);
    b.textContent=x[0]+'('+v+')';b.onclick=function(){setChipBet(v,minR,maxR);};
    pr.appendChild(b);
  });
  var br=document.getElementById('brow');br.innerHTML='';
  function ab(lbl,cls,fn){var b=document.createElement('button');b.className='ab '+cls;b.textContent=lbl;b.onclick=fn;br.appendChild(b);}
  ab('ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','ab-fold',function(){sendOffline('fold',0);});
  if(toC<=0)ab('ãƒã‚§ãƒƒã‚¯','ab-check',function(){sendOffline('check',0);});
  else ab('ã‚³ãƒ¼ãƒ«('+Math.min(toC,p.chips)+')','ab-call',function(){sendOffline('call',0);});
  if(p.chips>toC)ab('ãƒ¬ã‚¤ã‚º','ab-raise',function(){sendOffline('raise',snap5(+document.getElementById('rinp').value||0));});
  ab('ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³','ab-allin',function(){sendOffline('allin',0);});
}

function sendOffline(action,amount){
  document.getElementById('ap').style.display='none';
  var p=players[myIdx];
  if(action==='fold'){p.folded=true;}
  else if(action==='check'){}
  else if(action==='call'){var tc=Math.min(curBet-p.bet,p.chips);p.chips-=tc;p.bet+=tc;p.totalBet+=tc;pot+=tc;if(!p.chips)p.allIn=true;}
  else if(action==='raise'){var nb=Math.min(Math.max(amount,curBet+1),p.chips+p.bet);lastRaise=Math.max(nb-curBet,lastRaise);curBet=nb;var cost=nb-p.bet;p.chips-=cost;p.bet=nb;p.totalBet+=cost;pot+=cost;if(!p.chips)p.allIn=true;acts=[myIdx];}
  else if(action==='allin'){var nb2=p.chips+p.bet;if(nb2>curBet){lastRaise=Math.max(nb2-curBet,lastRaise);curBet=nb2;acts=[myIdx];}pot+=p.chips;p.bet=nb2;p.totalBet+=p.chips;p.chips=0;p.allIn=true;}
  if(acts.indexOf(myIdx)<0)acts.push(myIdx);
  renderAll();
  showActionBubble(myIdx, action, amount);
  advanceOffline();
}

var myId = Math.random().toString(36).substr(2,10);
var myName='', myChips=1000, SB=10, BB=20;
var roomPath='', isHost=false, myIdx=-1;

function genCode(){var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789',s='';for(var i=0;i<6;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}

document.getElementById('btn-create').addEventListener('click', function(){
  if(document.getElementById('conn-badge').className.includes('b-err')){
    alert('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');return;
  }
  myName = document.getElementById('my-name').value.trim()||'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
  myChips = +document.getElementById('my-chips').value||1000;
  SB = +document.getElementById('room-sb').value||10;
  BB = +document.getElementById('room-bb').value||20;
  var code = genCode();
  roomPath = 'rooms/'+code;
  isHost = true;
  var data = {code:code,SB:SB,BB:BB,status:'waiting',hostId:myId,createdAt:Date.now(),players:{}};
  data.players[myId] = {id:myId,name:myName,chips:myChips,seat:0};
  fbSet(roomPath, data, function(){
    document.getElementById('room-created').style.display='block';
    document.getElementById('code-disp').textContent = code;
    watchLobby();
  });
});

document.getElementById('code-disp').addEventListener('click', function(){
  try{navigator.clipboard.writeText(this.textContent);}catch(e){}
  var el=this; el.style.color='#0f0'; setTimeout(function(){el.style.color='';},800);
});

function watchLobby(){
  fbListen(roomPath, function(room){
    if(!room) return;
    var ps = room.players||{};
    renderPlist(ps);
    var n = Object.keys(ps).length;
    var btn = document.getElementById('btn-start');
    btn.disabled = n<2;
    btn.textContent = n>=2 ? 'ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆ'+n+'äººï¼‰' : 'å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...';
    document.getElementById('room-msg').textContent = n+'äººãŒå‚åŠ ä¸­';
    if(room.status==='started' && !isHost) launchGame(room);
  });
}

function renderPlist(ps){
  var el=document.getElementById('plist'); el.innerHTML='';
  Object.values(ps).sort(function(a,b){return a.seat-b.seat;}).forEach(function(p){
    el.innerHTML+='<div class="pitem"><div class="dot"></div><span>'+p.name+(p.id===myId?' (ã‚ãªãŸ)':'')+'</span>'+(p.seat===0?'<div class="htag">HOST</div>':'')+'</div>';
  });
}

document.getElementById('btn-start').addEventListener('click', function(){
  if(!isHost) return;
  fbGet(roomPath+'/players', function(ps){
    var arr = Object.values(ps||{}).sort(function(a,b){return a.seat-b.seat;});
    var seats={};arr.forEach(function(p,i){seats[p.id]=i;});
    fbPatch(roomPath, {status:'started', seats:seats}, function(){ launchGame(null); });
  });
});

document.getElementById('btn-join').addEventListener('click', doJoin);
document.getElementById('join-code').addEventListener('keydown', function(e){if(e.key==='Enter')doJoin();});
function setJM(msg,type){var el=document.getElementById('join-msg');el.textContent=msg;el.className='smsg s-'+type;}

function doJoin(){
  if(document.getElementById('conn-badge').className.includes('b-err')){
    setJM('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚','err');return;
  }
  var code = document.getElementById('join-code').value.trim().toUpperCase();
  if(code.length<4){setJM('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
  myName = document.getElementById('my-name').value.trim()||'ã‚²ã‚¹ãƒˆ';
  myChips = +document.getElementById('my-chips').value||1000;
  setJM('æ¥ç¶šä¸­...','info');
  fbGet('rooms/'+code, function(room){
    if(!room){setJM('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“','err');return;}
    if(room.status==='started'){setJM('ã‚²ãƒ¼ãƒ ã¯ã™ã§ã«é–‹å§‹ã—ã¦ã„ã¾ã™','err');return;}
    isHost=false; roomPath='rooms/'+code; SB=room.SB; BB=room.BB;
    var seat = Object.keys(room.players||{}).length;
    var patch={}; patch[myId]={id:myId,name:myName,chips:myChips,seat:seat};
    fbPatch(roomPath+'/players', patch, function(){
      setJM('âœ“ å‚åŠ ã—ã¾ã—ãŸï¼ãƒ›ã‚¹ãƒˆã®é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™','ok');
      watchLobby();
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚²ãƒ¼ãƒ 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var players=[], deck=[], comm=[], pot=0, phase=0;
var curBet=0, lastRaise=20, acts=[];
var dealerIdx=0, curIdx=0, myHole=[], lastActTs=0;
var gamePath='', holePfx='';
var PNAMES=['PRE-FLOP','FLOP','TURN','RIVER','SHOWDOWN'];

function launchGame(room){
  fbOff(roomPath);
  if(isHost){
    fbGet(roomPath, function(r){ _launch(r); });
  } else {
    _launch(room);
  }
}

function _launch(room){
  if(!room) return;
  SB=room.SB; BB=room.BB;
  var seats=room.seats||{};
  var arr=Object.values(room.players||{}).sort(function(a,b){return(seats[a.id]||0)-(seats[b.id]||0);});
  players=arr.map(function(p,i){
    if(p.id===myId) myIdx=i;
    return{name:p.name,chips:p.chips,pid:p.id,isMe:p.id===myId,idx:i,
           hole:[],bet:0,totalBet:0,folded:false,allIn:false,active:true};
  });
  gamePath = roomPath+'/game';
  holePfx  = roomPath+'/holes/';
  showScreen('screen-game');
  fbListen(gamePath+'/state', onState);
  fbListen(holePfx+myId, function(h){
    if(h&&h.length===2){myHole=h;if(players[myIdx])players[myIdx].hole=h;renderAll();}
  });
  if(isHost){ watchAction(); startRound(); }
  else showInfo('ãƒ›ã‚¹ãƒˆã®ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...');
}

function onState(st){
  if(!st) return;
  comm=st.comm||[]; pot=st.pot||0; phase=st.phase||0;
  curIdx=st.curIdx||0; curBet=st.curBet||0;
  dealerIdx=st.dealerIdx||0; lastRaise=st.lastRaise||BB;
  acts=st.acts||[];
  if(st.players) st.players.forEach(function(sp,i){
    if(!players[i])return;
    players[i].chips=sp.chips;players[i].bet=sp.bet;players[i].totalBet=sp.totalBet;
    players[i].folded=sp.folded;players[i].allIn=sp.allIn;players[i].active=sp.active;
  });
  if(myHole.length===2&&players[myIdx]) players[myIdx].hole=myHole;
  if(st.reveal) Object.keys(st.reveal).forEach(function(i){if(players[i])players[i].hole=st.reveal[i];});
  renderAll();
  if(st.showdown){handleSD(st.showdown);return;}
  if(st.result){handleResult(st.result);return;}
  if(st.waitFor===myId){
    hideInfo(); document.getElementById('ap').style.display='block'; renderAction();
  } else {
    showInfo((players[curIdx]?players[curIdx].name:'?')+'ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    document.getElementById('ap').style.display='none';
  }
}

function watchAction(){
  fbListen(gamePath+'/action', function(d){
    if(!d||d.ts===lastActTs) return;
    lastActTs=d.ts; curIdx=d.playerIdx;
    applyAction(d); renderAll(); advance();
  });
}

function pushState(extra){
  var st={
    players:players.map(function(p){return{chips:p.chips,bet:p.bet,totalBet:p.totalBet,folded:p.folded,allIn:p.allIn,active:p.active};}),
    comm:comm,pot:pot,phase:phase,curIdx:curIdx,curBet:curBet,
    dealerIdx:dealerIdx,lastRaise:lastRaise,acts:acts,
    showdown:null,result:null,reveal:null,waitFor:null
  };
  if(extra) Object.keys(extra).forEach(function(k){st[k]=extra[k];});
  fbSet(gamePath+'/state', st);
}

function startRound(){
  deck=shuffle(makeDeck());comm=[];pot=0;phase=0;curBet=0;lastRaise=BB;acts=[];
  players.forEach(function(p){if(p.chips<=0)p.active=false;p.hole=[];p.bet=0;p.totalBet=0;p.folded=false;p.allIn=false;});
  var active=players.filter(function(p){return p.active;});
  if(active.length<2){var w=active[0];pushState({result:{title:'ã‚²ãƒ¼ãƒ çµ‚äº†',body:'<span class="wn">'+(w?w.name:'?')+'</span>ã®å„ªå‹ï¼',ch:''}});return;}
  dealerIdx=(dealerIdx+1)%players.length;
  while(!players[dealerIdx].active) dealerIdx=(dealerIdx+1)%players.length;
  active.forEach(function(p){
    var h=[deck.pop(),deck.pop()]; p.hole=h;
    fbSet(holePfx+p.pid, h);
    if(p.isMe) myHole=h;
  });
  var sb=nxt(dealerIdx), bb=nxt(sb);
  blind(players[sb],SB); blind(players[bb],BB);
  curBet=BB; lastRaise=BB; curIdx=nxt(bb); acts=[players[sb].idx];
  pushState({waitFor:players[curIdx].pid});
}

function blind(p,a){var x=Math.min(a,p.chips);p.chips-=x;p.bet+=x;p.totalBet+=x;pot+=x;if(!p.chips)p.allIn=true;}
function nxt(from){var i=(from+1)%players.length,t=0;while((!players[i].active||players[i].folded||players[i].allIn)&&t<players.length){i=(i+1)%players.length;t++;}return i;}

function applyAction(d){
  var p=players[d.playerIdx];if(!p)return;
  if(d.action==='fold'){p.folded=true;}
  else if(d.action==='call'){var tc=Math.min(curBet-p.bet,p.chips);p.chips-=tc;p.bet+=tc;p.totalBet+=tc;pot+=tc;if(!p.chips)p.allIn=true;}
  else if(d.action==='raise'){var nb=Math.min(Math.max(d.amount,curBet+1),p.chips+p.bet);lastRaise=Math.max(nb-curBet,lastRaise);curBet=nb;var cost=nb-p.bet;p.chips-=cost;p.bet=nb;p.totalBet+=cost;pot+=cost;if(!p.chips)p.allIn=true;acts=[d.playerIdx];}
  else if(d.action==='allin'){var nb2=p.chips+p.bet;if(nb2>curBet){lastRaise=Math.max(nb2-curBet,lastRaise);curBet=nb2;acts=[d.playerIdx];}pot+=p.chips;p.bet=nb2;p.totalBet+=p.chips;p.chips=0;p.allIn=true;}
  if(acts.indexOf(d.playerIdx)<0) acts.push(d.playerIdx);
  renderAll();
  showActionBubble(d.playerIdx, d.action, d.amount);
}

function advance(){
  var nf=players.filter(function(p){return p.active&&!p.folded;});
  if(nf.length===1){nf[0].chips+=pot;pushState({result:{title:'ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†',body:'<span class="wn">'+nf[0].name+'</span>ã®å‹åˆ©ï¼ï¼ˆå…¨å“¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ï¼‰',ch:''},waitFor:null});return;}
  var ca=players.filter(function(p){return p.active&&!p.folded&&!p.allIn;});
  if(ca.length<=1||(ca.every(function(p){return acts.indexOf(p.idx)>=0;})&&ca.every(function(p){return p.bet===curBet;}))){nextPhase();return;}
  curIdx=nxt(curIdx);
  pushState({waitFor:players[curIdx].pid});
}

function nextPhase(){
  players.forEach(function(p){p.bet=0;}); curBet=0; lastRaise=BB; acts=[]; phase++;
  var newCards=[];
  if(phase===1){var c1=deck.pop(),c2=deck.pop(),c3=deck.pop();comm.push(c1,c2,c3);newCards=[c1,c2,c3];}
  else if(phase===2){var c=deck.pop();comm.push(c);newCards=[c];}
  else if(phase===3){var c=deck.pop();comm.push(c);newCards=[c];}
  else if(phase>=4){ doShowdown(); return; }
  curIdx=nxt(dealerIdx);
  renderAll();
  showPhaseOverlay(PNAMES[phase]||'', newCards, function(){
    pushState({waitFor:players[curIdx].pid});
  });
}

function doShowdown(){
  var cont=players.filter(function(p){return p.active&&!p.folded;});
  var pending=cont.length, holes={};
  cont.forEach(function(p){
    fbGet(holePfx+p.pid, function(h){
      if(h) holes[p.idx]=h;
      if(--pending===0) finishSD(cont,holes);
    });
  });
}
function finishSD(cont,holes){
  cont.forEach(function(p){if(holes[p.idx])p.hole=holes[p.idx];p.best=evalHand(p.hole.concat(comm));});
  cont.sort(function(a,b){return cmpSc(b.best.score,a.best.score);});
  var top=cont[0].best.score;
  var wins=cont.filter(function(p){return cmpSc(p.best.score,top)===0;});
  var share=snap5(Math.floor(pot/wins.length)); wins.forEach(function(w){w.chips+=share;});
  var body='<span class="wn">'+wins.map(function(w){return w.name;}).join(' & ')+'</span>ã®å‹åˆ©ï¼<br><span class="hn">'+HN[wins[0].best.score.rank]+'</span><br>ãƒãƒƒãƒˆ: '+pot;
  if(wins.length>1) body+='<br>ï¼ˆ'+share+'ãšã¤å±±åˆ†ã‘ï¼‰';
  // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚«ãƒ¼ãƒ‰ï¼‹ãƒãƒ³ãƒ‰åã‚’chã«å«ã‚ã‚‹
  var ch='<div style="width:100%;text-align:left;">';
  cont.forEach(function(p){
    var isW=wins.indexOf(p)>=0;
    ch+='<div style="margin-bottom:8px;padding:6px 8px;border-radius:8px;background:'+(isW?'rgba(201,168,76,.15)':'rgba(0,0,0,.3)')+';border:1px solid '+(isW?'rgba(201,168,76,.5)':'rgba(255,255,255,.1)')+';">';
    ch+='<div style="font-family:'Cinzel',serif;font-size:10px;color:'+(isW?'var(--gold-light)':'rgba(255,255,255,.6)')+';margin-bottom:4px;">'+(isW?'ğŸ† ':'')+p.name+' â€” '+HN[p.best.score.rank]+'</div>';
    ch+='<div style="display:flex;gap:4px;">';
    p.hole.forEach(function(c){ch+=cH(c);});
    ch+='</div></div>';
  });
  ch+='</div>';
  pushState({showdown:{body:body,ch:ch},reveal:holes,waitFor:null});
}

function handleSD(sd){if(!sd)return;renderAll();showMsg('ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³',sd.body,'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){if(isHost)startRound();else showInfo('æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾…ã£ã¦ã„ã¾ã™...');},sd.ch||'');}
function handleResult(rr){if(!rr||!rr.title)return;renderAll();showMsg(rr.title,rr.body,'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){if(isHost)startRound();else showInfo('æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾…ã£ã¦ã„ã¾ã™...');},rr.ch||'');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAction(){
  var p=players[myIdx];if(!p)return;
  document.getElementById('ap-who').textContent=p.name+' ã®ã‚¿ãƒ¼ãƒ³ï¼ˆã‚ãªãŸï¼‰';
  var toC=curBet-p.bet;
  document.getElementById('ap-info').innerHTML='<span style="opacity:.6">æ‰‹æŒã¡</span> '+p.chips+' &nbsp;<span style="opacity:.6">ã‚³ãƒ¼ãƒ«</span> '+Math.min(toC,p.chips);
  var h=myHole.length?myHole:p.hole;
  document.getElementById('hdisp').innerHTML=cH(h[0])+cH(h[1]);
  var minR=snap5(Math.min(curBet+lastRaise,p.chips+p.bet)), maxR=p.chips+p.bet;
  setupChipSelector(minR, maxR);
  var pr=document.getElementById('prow');pr.innerHTML='';
  [['1/3P',snap5(Math.round(pot/3))],['1/2P',snap5(Math.round(pot/2))],['POT',snap5(pot)],['2Ã—BB',snap5(BB*2)]].forEach(function(x){
    var b=document.createElement('button');b.className='pbtn';
    var v=Math.min(Math.max(x[1],minR),maxR);
    b.textContent=x[0]+'('+v+')';b.onclick=function(){setChipBet(v,minR,maxR);};
    pr.appendChild(b);
  });
  var br=document.getElementById('brow');br.innerHTML='';
  function ab(lbl,cls,fn){var b=document.createElement('button');b.className='ab '+cls;b.textContent=lbl;b.onclick=fn;br.appendChild(b);}
  ab('ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','ab-fold',function(){send('fold',0);});
  if(toC<=0) ab('ãƒã‚§ãƒƒã‚¯','ab-check',function(){send('check',0);});
  else ab('ã‚³ãƒ¼ãƒ«('+Math.min(toC,p.chips)+')','ab-call',function(){send('call',0);});
  if(p.chips>toC) ab('ãƒ¬ã‚¤ã‚º','ab-raise',function(){send('raise',snap5(+document.getElementById('rinp').value||0));});
  ab('ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³','ab-allin',function(){send('allin',0);});
}

function send(action,amount){
  if(offlineMode){sendOffline(action,amount);return;}
  document.getElementById('ap').style.display='none';
  showInfo('é€ä¿¡ä¸­...');
  var d={playerIdx:myIdx,action:action,amount:amount,ts:Date.now()};
  if(isHost){lastActTs=d.ts;applyAction(d);renderAll();advance();}
  else fbSet(gamePath+'/action',d);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æç”»
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  var area=document.getElementById('seats');area.innerHTML='';
  players.forEach(function(p,i){
    if(!p.active)return;
    var s=document.createElement('div');s.className='seat';
    if(i===curIdx) s.classList.add(p.isMe?'myturn':'waiting');
    if(p.folded) s.classList.add('folded');
    if(i===dealerIdx) s.classList.add('dealer');
    var h=p.isMe?(myHole.length?myHole:p.hole):((phase>=4&&!p.folded)?p.hole:[]);
    var show=(phase>=4&&!p.folded&&h&&h.length===2)||p.isMe;
    var ch=show&&h&&h.length===2?(cH(h[0],true)+cH(h[1],true)):'<div class="card sm back"></div><div class="card sm back"></div>';
    var st=p.folded?'FOLD':p.allIn?'ALL IN':i===curIdx?(p.isMe?'â–¶ ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³':'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸­...'):'';
    s.innerHTML='<div class="sname">'+p.name+(p.isMe?' â­':'')+'</div>'+
      '<div class="schips">'+chipsHTML(p.chips)+'</div>'+
      '<div class="sbet">'+(p.bet?'<span style="font-size:9px">BET </span>'+chipsHTML(p.bet):'')+'</div>'+
      '<div class="scards">'+ch+'</div>'+
      '<div class="sst">'+st+'</div>';
    area.appendChild(s);
  });
  var cc=document.getElementById('comm-cards');cc.innerHTML='';
  for(var i=0;i<5;i++) cc.innerHTML+=i<comm.length?cH(comm[i]):'<div class="card back"></div>';
  document.getElementById('pot').innerHTML='<span style="opacity:.6;font-size:10px">POT </span>'+chipsHTML(pot);
  document.getElementById('phase').textContent=PNAMES[Math.min(phase,4)]||'SHOWDOWN';
}
function showInfo(m){document.getElementById('ibar').classList.add('show');document.getElementById('ibar-t').textContent=m;}
function hideInfo(){document.getElementById('ibar').classList.remove('show');}
function showMsg(title,body,lbl,fn,ch){
  document.getElementById('mover').classList.add('show');
  document.getElementById('mtitle').textContent=title;
  document.getElementById('mbody').innerHTML=body;
  document.getElementById('mcards').innerHTML=ch||'';
  var btn=document.getElementById('mnext');btn.textContent=lbl;
  btn.onclick=function(){document.getElementById('mover').classList.remove('show');fn();};
}

// â”€â”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ–ãƒ«è¡¨ç¤º â”€â”€
var ACTION_LABELS={fold:'FOLD',check:'CHECK',call:'CALL',raise:'RAISE',allin:'ALL IN'};
var ACTION_CLS={fold:'ab-fold',check:'ab-check',call:'ab-call',raise:'ab-raise',allin:'ab-allin'};
function showActionBubble(playerIdx, action, amount){
  // åº§å¸­DOMã‚’å–å¾—
  var seats=document.querySelectorAll('.seat');
  var active=players.filter(function(p){return p.active;});
  var si=active.findIndex(function(p){return p.idx===playerIdx;});
  if(si<0||si>=seats.length) return;
  var seat=seats[si];
  // å¤ã„ãƒãƒ–ãƒ«ã‚’é™¤å»
  var old=seat.querySelector('.action-bubble'); if(old) old.remove();
  var lbl=ACTION_LABELS[action]||action.toUpperCase();
  if(action==='raise'&&amount) lbl='RAISE '+amount;
  if(action==='call'){var p=players[playerIdx];if(p)lbl='CALL '+Math.min(curBet-p.bet+amount,p.chips||0);}
  var b=document.createElement('div');
  b.className='action-bubble '+(ACTION_CLS[action]||'');
  b.textContent=lbl;
  seat.style.position='relative';
  seat.appendChild(b);
  setTimeout(function(){if(b.parentNode)b.remove();},2200);
}

// â”€â”€ ãƒ•ã‚§ãƒ¼ã‚ºç§»è¡Œã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â”€â”€
var PHASE_LABELS=['PRE-FLOP','FLOP','TURN','RIVER','SHOWDOWN'];
function showPhaseOverlay(phaseName, newCards, cb){
  var ov=document.getElementById('phase-overlay');
  var pn=document.getElementById('phase-name');
  var cr=document.getElementById('phase-cards-row');
  pn.textContent=phaseName;
  cr.innerHTML='';
  if(newCards&&newCards.length){
    newCards.forEach(function(c){cr.innerHTML+=cH(c);});
  }
  ov.classList.add('show');
  setTimeout(function(){
    ov.classList.remove('show');
    if(cb) cb();
  }, 1400);
}

function showScreen(id){
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById(id).classList.add('active');
}

})();
</script>

</body>
</html>
