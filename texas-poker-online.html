<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Texas Hold'em Online</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
:root{--gold:#c9a84c;--gold-light:#f0d080;--gold-dark:#8a6820;--felt:#1a4a2e;--felt-dark:#0d2e1c;--felt-light:#235c39;--red:#c0392b;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:radial-gradient(ellipse at 50%,#1e5535 0%,#0a2010 100%);min-height:100vh;font-family:serif;color:#fff;overflow-x:hidden;}
.screen{display:none;min-height:100vh;flex-direction:column;align-items:center;padding:20px 16px 40px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.screen.active{display:flex;}
.logo{font-family:Cinzel,serif;font-size:clamp(20px,6vw,44px);font-weight:900;background:linear-gradient(135deg,#8a6820,#f0d080,#c9a84c,#f0d080,#8a6820);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:3px;text-align:center;margin:16px 0 4px;}
.logo-sub{font-family:Cinzel,serif;font-size:11px;color:var(--gold);letter-spacing:6px;text-align:center;margin-bottom:12px;opacity:.7;}
.badge{font-family:Cinzel,serif;font-size:10px;letter-spacing:2px;padding:4px 14px;border-radius:20px;margin-bottom:14px;text-align:center;}
.b-ok{color:#0f0;background:rgba(0,200,0,.12);border:1px solid rgba(0,200,0,.3);}
.b-info{color:#4af;background:rgba(0,150,255,.12);border:1px solid rgba(0,150,255,.3);}
.b-err{color:#f88;background:rgba(255,60,60,.12);border:1px solid rgba(255,60,60,.3);}
.panel{background:linear-gradient(145deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(201,168,76,.3);border-radius:16px;padding:20px;width:100%;max-width:480px;margin-bottom:14px;}
.ptitle{font-family:Cinzel,serif;font-size:11px;color:var(--gold);letter-spacing:3px;margin-bottom:14px;text-align:center;}
.flabel{font-size:11px;color:rgba(201,168,76,.7);letter-spacing:2px;font-family:Cinzel,serif;margin-bottom:5px;display:block;}
.inp{width:100%;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:10px 14px;color:#fff;font-family:serif;font-size:15px;outline:none;margin-bottom:10px;}
.inp:focus{border-color:var(--gold);}
.inp::placeholder{color:rgba(255,255,255,.2);}
.num-inp{width:90px;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.3);border-radius:8px;padding:8px;color:var(--gold-light);font-family:Cinzel,serif;font-size:13px;outline:none;text-align:center;}
.row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.gap{display:flex;gap:8px;align-items:center;}
.btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--gold-dark),var(--gold),var(--gold-dark));border:none;border-radius:10px;color:#1a0a00;font-family:Cinzel,serif;font-size:13px;font-weight:700;letter-spacing:2px;cursor:pointer;margin-top:8px;}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn:active:not(:disabled){transform:scale(.98);}
.btn-sm{padding:9px 14px;background:rgba(201,168,76,.2);border:1px solid var(--gold);border-radius:8px;color:var(--gold-light);font-family:Cinzel,serif;font-size:11px;cursor:pointer;white-space:nowrap;}
.slabel{font-family:Cinzel,serif;font-size:10px;color:rgba(201,168,76,.6);letter-spacing:2px;margin:10px 0 7px;text-transform:uppercase;}
.code-big{font-family:Cinzel,serif;font-size:36px;letter-spacing:10px;color:var(--gold-light);text-align:center;padding:12px 0;background:rgba(0,0,0,.4);border-radius:10px;margin:8px 0;cursor:pointer;}
.code-hint{font-size:11px;color:rgba(255,255,255,.3);text-align:center;margin-bottom:6px;}
.plist{display:flex;flex-direction:column;gap:5px;margin:8px 0;}
.pitem{display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(0,0,0,.3);border-radius:8px;font-size:13px;}
.dot{width:8px;height:8px;border-radius:50%;background:#0f0;flex-shrink:0;}
.htag{font-family:Cinzel,serif;font-size:9px;color:#fd0;background:rgba(255,200,0,.15);border:1px solid rgba(255,200,0,.3);border-radius:4px;padding:1px 6px;margin-left:auto;}
.smsg{font-size:12px;text-align:center;padding:7px;border-radius:8px;margin-top:6px;}
.s-ok{color:#0f0;}.s-err{color:#f88;}.s-info{color:#4af;}
/* game */
#screen-game{padding:10px;align-items:stretch;}
.felt{width:100%;max-width:700px;background:radial-gradient(ellipse at center,var(--felt-light),var(--felt) 60%,var(--felt-dark));border-radius:100px;border:5px solid var(--gold-dark);box-shadow:0 0 0 2px var(--gold),0 8px 40px rgba(0,0,0,.7),inset 0 0 40px rgba(0,0,0,.3);padding:20px 24px;display:flex;flex-direction:column;align-items:center;gap:8px;min-height:180px;margin:0 auto 10px;}
#comm-cards{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
#pot{font-family:Cinzel,serif;font-size:12px;color:var(--gold-light);background:rgba(0,0,0,.4);padding:4px 16px;border-radius:20px;border:1px solid rgba(201,168,76,.3);}
#phase{font-family:Cinzel,serif;font-size:10px;letter-spacing:4px;color:rgba(255,255,255,.35);}
#seats{display:flex;flex-wrap:wrap;gap:6px;width:100%;max-width:700px;margin:0 auto 8px;justify-content:center;}
.seat{background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.2);border-radius:12px;padding:8px;text-align:center;position:relative;flex:1 1 140px;max-width:200px;min-width:130px;box-sizing:border-box;}
.seat.myturn{border-color:var(--gold);background:rgba(201,168,76,.12);box-shadow:0 0 18px rgba(201,168,76,.3);}
.seat.waiting{border-color:#fa0;animation:wp .9s infinite alternate;}
@keyframes wp{from{box-shadow:0 0 6px rgba(255,165,0,.2);}to{box-shadow:0 0 20px rgba(255,165,0,.5);}}
.seat.folded{opacity:.4;}
.seat.allin{border-color:rgba(255,80,80,.7);background:rgba(180,30,30,.15);box-shadow:0 0 14px rgba(255,60,60,.25);}
.sst-allin{font-family:Cinzel,serif;font-size:10px;font-weight:700;color:#ff6060;letter-spacing:2px;text-shadow:0 0 8px rgba(255,80,80,.7);animation:wp .8s infinite alternate;}
.seat.dealer::before{content:'D';position:absolute;top:-8px;left:-8px;width:19px;height:19px;background:var(--gold);color:#000;border-radius:50%;font-family:Cinzel,serif;font-size:9px;font-weight:700;line-height:19px;text-align:center;}
.sname{font-family:Cinzel,serif;font-size:10px;color:var(--gold-light);margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;}
.schips{font-size:11px;color:rgba(255,255,255,.65);}
.sbet{font-size:10px;color:#f0d080;min-height:14px;}
.scards{display:flex;gap:3px;justify-content:center;margin-top:4px;}
.sst{font-size:9px;color:rgba(255,255,255,.35);min-height:12px;}
/* ã‚«ãƒ¼ãƒ‰ã¯ã™ã¹ã¦SVGã§æç”» - CSSã¯æœ€å°é™ */
.card-wrap{display:inline-block;flex-shrink:0;line-height:0;}
.card-wrap.sm svg{width:32px;height:46px;}
.card-wrap.lg svg{width:68px;height:100px;}
.card-wrap svg{width:44px;height:64px;border-radius:5px;box-shadow:0 3px 10px rgba(0,0,0,.55);}
#ap{width:100%;max-width:700px;margin:0 auto;background:rgba(0,0,0,.6);border:1px solid rgba(201,168,76,.25);border-radius:14px;padding:12px;}
#ap-hd{display:flex;justify-content:space-between;margin-bottom:10px;}
#ap-who{font-family:Cinzel,serif;font-size:12px;color:var(--gold-light);}
#ap-info{font-size:11px;color:rgba(255,255,255,.45);}
#hdisp{display:flex;gap:8px;justify-content:center;margin-bottom:10px;}
.prow{display:flex;gap:4px;margin-bottom:6px;flex-wrap:wrap;}
.pbtn{flex:1;min-width:44px;padding:4px 2px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.25);border-radius:5px;color:var(--gold);font-family:Cinzel,serif;font-size:7px;cursor:pointer;text-align:center;}
#rrow{display:none;}
#rrow label{font-size:10px;color:var(--gold);white-space:nowrap;font-family:Cinzel,serif;}
#rinp{flex:1;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.4);border-radius:7px;padding:7px;color:var(--gold-light);font-family:Cinzel,serif;font-size:14px;outline:none;text-align:center;}
#rslider{width:100%;margin-bottom:8px;accent-color:var(--gold);}
.brow{display:flex;gap:6px;flex-wrap:wrap;}
.ab{flex:1;min-width:65px;padding:10px 4px;border:none;border-radius:8px;font-family:Cinzel,serif;font-size:10px;cursor:pointer;font-weight:700;}
.ab:active{transform:scale(.97);}
.ab-fold{background:rgba(150,40,40,.8);color:#ffaaaa;border:1px solid rgba(200,60,60,.5);}
.ab-check{background:rgba(40,100,180,.8);color:#aaddff;border:1px solid rgba(60,130,210,.5);}
.ab-call{background:rgba(30,130,100,.8);color:#aaffdd;border:1px solid rgba(50,160,120,.5);}
.ab-raise{background:rgba(180,120,20,.85);color:#fff5cc;border:1px solid rgba(201,168,76,.6);}
.ab-allin{background:linear-gradient(135deg,#7a0000,#c00);color:#fff;border:1px solid #f00;}
#ibar{width:100%;max-width:700px;margin:0 auto 6px;background:rgba(0,0,0,.5);border:1px solid rgba(255,165,0,.3);border-radius:10px;padding:8px;text-align:center;display:none;}
#ibar.show{display:block;}
#ibar-t{font-family:Cinzel,serif;font-size:11px;color:#fa0;}
#mover{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:100;align-items:center;justify-content:center;padding:16px;}
#mover.show{display:flex;}
.mcard{background:linear-gradient(145deg,#1a2a10,#0d1a08);border:2px solid var(--gold);border-radius:20px;padding:16px;text-align:center;max-width:440px;width:100%;max-height:85vh;display:flex;flex-direction:column;}
.mtitle{font-family:Cinzel,serif;font-size:18px;color:var(--gold-light);margin-bottom:10px;}
.mbody{font-size:12px;color:rgba(255,255,255,.8);line-height:1.6;margin-bottom:10px;overflow-y:auto;flex:1;}
.mbody .wn{color:var(--gold-light);font-size:15px;font-weight:600;}.mbody .hn{color:#aaffaa;font-size:11px;}
.mcards{display:flex;gap:4px;justify-content:center;margin:6px 0;flex-wrap:wrap;width:100%;overflow-y:auto;}
.mnext{padding:12px 28px;background:linear-gradient(135deg,var(--gold-dark),var(--gold));border:none;border-radius:10px;color:#1a0a00;font-family:Cinzel,serif;font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0;margin-top:8px;}

/* ãƒãƒƒãƒ—è¡¨ç¤º */
.chips-stack{display:flex;flex-wrap:wrap;gap:2px;justify-content:center;align-items:center;}
.chip{width:26px;height:26px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-family:Cinzel,serif;font-size:7px;font-weight:700;border:2px dashed rgba(255,255,255,.5);box-shadow:0 2px 6px rgba(0,0,0,.6),inset 0 1px 3px rgba(255,255,255,.35);position:relative;flex-shrink:0;letter-spacing:-0.5px;}
.chip-500{background:radial-gradient(circle at 35% 35%,#b06fe0,#7d3fb5);color:#fff;}
.chip-100{background:radial-gradient(circle at 35% 35%,#4a6080,#2c3e50);color:#fff;}
.chip-25{background:radial-gradient(circle at 35% 35%,#27ae60,#1e8449);color:#fff;}
.chip-10{background:radial-gradient(circle at 35% 35%,#2980b9,#1a5276);color:#fff;}
.chip-5{background:radial-gradient(circle at 35% 35%,#e74c3c,#c0392b);color:#fff;}
.chip-1{background:radial-gradient(circle at 35% 35%,#ecf0f1,#bdc3c7);color:#333;}
/* ãƒãƒƒãƒ—é¸æŠUI */
.chip-selector{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:10px;}
.chip-sel-btn{width:46px;height:46px;border-radius:50%;border:3px solid rgba(255,255,255,.25);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Cinzel,serif;font-weight:700;box-shadow:0 3px 8px rgba(0,0,0,.5),inset 0 1px 3px rgba(255,255,255,.25);transition:all .15s;position:relative;flex-shrink:0;}
.chip-sel-btn:active{transform:scale(.92);}
.chip-sel-btn.sel{border-color:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.5),0 3px 8px rgba(0,0,0,.5);}
.chip-sel-btn .cl{font-size:9px;line-height:1;}
.chip-sel-btn .cv{font-size:11px;line-height:1;}
.chip-sel-500{background:radial-gradient(circle at 35% 35%,#9b59b6,#6c3483);color:#fff;}
.chip-sel-100{background:radial-gradient(circle at 35% 35%,#2c3e50,#1a252f);color:#fff;}
.chip-sel-25{background:radial-gradient(circle at 35% 35%,#27ae60,#1e8449);color:#fff;}
.chip-sel-10{background:radial-gradient(circle at 35% 35%,#2980b9,#1a5276);color:#fff;}
.chip-sel-5{background:radial-gradient(circle at 35% 35%,#e74c3c,#c0392b);color:#fff;}
.bet-display{font-family:Cinzel,serif;font-size:22px;color:var(â€“gold-light);text-align:center;background:rgba(0,0,0,.5);border:1px solid rgba(201,168,76,.4);border-radius:10px;padding:8px 16px;margin-bottom:8px;letter-spacing:2px;}
.bet-sub{font-size:11px;color:rgba(255,255,255,.4);text-align:center;margin-bottom:8px;}
.chip-count{position:absolute;top:-4px;right:-4px;background:#000;color:#fd0;border-radius:6px;font-size:6px;padding:0 2px;font-family:Cinzel,serif;font-weight:700;line-height:10px;min-width:10px;text-align:center;}
.chips-total{font-family:Cinzel,serif;font-size:10px;color:var(â€“gold-light);margin-top:2px;}
@keyframes cpuprog{from{width:0}to{width:100%}}

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒãƒ–ãƒ« */
.action-bubble{position:absolute;top:-28px;left:50%;transform:translateX(-50%);
background:rgba(0,0,0,.85);border:1px solid var(â€“gold);border-radius:10px;
padding:3px 10px;font-family:Cinzel,serif;font-size:10px;white-space:nowrap;
z-index:10;pointer-events:none;animation:bubblePop .25s ease;}
.action-bubble.ab-fold{border-color:#e74c3c;color:#f88;}
.action-bubble.ab-check{border-color:#3498db;color:#adf;}
.action-bubble.ab-call{border-color:#27ae60;color:#afd;}
.action-bubble.ab-raise{border-color:var(â€“gold);color:var(â€“gold-light);}
.action-bubble.ab-allin{border-color:#e74c3c;color:#f00;font-weight:700;}
@keyframes bubblePop{from{opacity:0;transform:translateX(-50%) scale(.7);}to{opacity:1;transform:translateX(-50%) scale(1);}}
/* ãƒ•ã‚§ãƒ¼ã‚ºç§»è¡Œã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#phase-overlay{display:none;position:fixed;inset:0;z-index:50;align-items:center;justify-content:center;pointer-events:none;}
#phase-overlay.show{display:flex;}
#phase-card{background:linear-gradient(135deg,rgba(10,30,15,.95),rgba(5,15,8,.98));
border:2px solid var(â€“gold);border-radius:18px;padding:16px 20px;text-align:center;
animation:phaseIn .4s ease forwards;max-width:92vw;box-sizing:border-box;}
@keyframes phaseIn{from{opacity:0;transform:scale(.6);}to{opacity:1;transform:scale(1);}}
#phase-name{font-family:Cinzel,serif;font-size:26px;font-weight:900;
background:linear-gradient(135deg,#8a6820,#f0d080,#c9a84c);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
letter-spacing:6px;margin-bottom:6px;}
#phase-cards-row{display:flex;gap:6px;justify-content:center;margin-top:8px;flex-wrap:wrap;max-width:100%;}

/* ãƒ‡ã‚£ãƒ¼ãƒ«æ¼”å‡º */
#deal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:60;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
#deal-overlay.show{display:flex;}
#deal-cards-row{display:flex;gap:16px;justify-content:center;}
#deal-label{font-family:Cinzel,serif;font-size:12px;color:var(â€“gold);letter-spacing:4px;opacity:.8;}
@keyframes dealIn{from{opacity:0;transform:translateY(-30px) rotate(-5deg);}to{opacity:1;transform:translateY(0) rotate(0deg);}}
.deal-card-anim{animation:dealIn .35s ease forwards;}
.deal-card-anim:nth-child(2){animation-delay:.2s;opacity:0;}

/* ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ ãƒ•ãƒªãƒƒãƒ—æ¼”å‡º */
.comm-card-wrap{perspective:800px;display:inline-block;}
.comm-card-inner{
position:relative;transform-style:preserve-3d;
transition:transform .5s ease;
transform:rotateY(-180deg);  /* åˆæœŸ: è£å‘ã */
}
.comm-card-inner.flipped{transform:rotateY(0deg);}
.comm-card-face,.comm-card-back{
position:absolute;top:0;left:0;
backface-visibility:hidden;-webkit-backface-visibility:hidden;
}
.comm-card-back{transform:rotateY(180deg);}
/* ãƒ•ãƒ­ãƒƒãƒ—: å·¦ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ */
@keyframes commSlideIn{
from{opacity:0;transform:translateX(-24px) rotateY(-180deg);}
to{opacity:1;transform:translateX(0) rotateY(0deg);}
}
.comm-anim{animation:commSlideIn .45s ease forwards;opacity:0;}

#confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:10000;align-items:center;justify-content:center;padding:20px;}
#confirm-overlay.show{display:flex;}
#confirm-box{background:linear-gradient(145deg,#1a2a10,#0d1a08);border:2px solid var(â€“gold);border-radius:16px;padding:24px;text-align:center;max-width:300px;width:100%;}
#confirm-msg{font-family:Cinzel,serif;font-size:13px;color:rgba(255,255,255,.9);margin-bottom:20px;line-height:1.6;}
#confirm-btns{display:flex;gap:10px;justify-content:center;}
#confirm-yes{padding:10px 28px;background:linear-gradient(135deg,#7a0000,#c00);border:none;border-radius:8px;color:#fff;font-family:Cinzel,serif;font-size:11px;font-weight:700;cursor:pointer;touch-action:manipulation;}
#confirm-no{padding:10px 28px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:rgba(255,255,255,.7);font-family:Cinzel,serif;font-size:11px;cursor:pointer;touch-action:manipulation;}
</style>

</head>
<body>

<!-- ãƒ­ãƒ“ãƒ¼ -->

<div id="screen-lobby" class="screen active">
  <div class="logo">TEXAS HOLD'EM</div>
  <div class="logo-sub">ONLINE POKER</div>
  <div style="font-family:Cinzel,serif;font-size:9px;color:rgba(201,168,76,.4);letter-spacing:2px;text-align:center;margin-top:-8px;margin-bottom:4px;">v2026.02.28.35</div>
  <div id="conn-badge" class="badge b-err">âš  ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰</div>
  <div class="panel" style="text-align:center;padding:14px 20px;">
    <div class="ptitle">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</div>
    <div style="display:flex;gap:8px;">
      <button id="btn-mode-online" style="flex:1;padding:12px 4px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);border-radius:10px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:11px;letter-spacing:1px;cursor:pointer;">ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³<br><span style="font-size:9px;opacity:.7;">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰å¯¾æˆ¦</span></button>
      <button id="btn-mode-offline" style="flex:1;padding:12px 4px;background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:10px;color:var(--gold-light);font-family:Cinzel,serif;font-size:11px;letter-spacing:1px;cursor:pointer;">ğŸ¤– ã‚ªãƒ•ãƒ©ã‚¤ãƒ³<br><span style="font-size:9px;opacity:.7;">CPUå¯¾æˆ¦</span></button>
    </div>
  </div>

  <!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¨­å®šãƒ‘ãƒãƒ« -->

  <div id="panel-offline" class="panel">
    <div class="ptitle">ğŸ¤– CPUå¯¾æˆ¦è¨­å®š</div>
    <label class="flabel">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
    <input class="inp" id="off-name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1">
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">é–‹å§‹ãƒãƒƒãƒ—</span><input class="num-inp" id="off-chips" value="500"></div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">CPUäººæ•°</span>
      <div style="display:flex;gap:6px;">
        <button class="cpu-cnt-btn" data-n="1" style="padding:6px 12px;background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:6px;color:var(--gold-light);font-family:Cinzel,serif;font-size:12px;cursor:pointer;">1</button>
        <button class="cpu-cnt-btn" data-n="2" style="padding:6px 12px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:12px;cursor:pointer;">2</button>
        <button class="cpu-cnt-btn" data-n="3" style="padding:6px 12px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:12px;cursor:pointer;">3</button>
        <button class="cpu-cnt-btn" data-n="4" style="padding:6px 12px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:12px;cursor:pointer;">4</button>
        <button class="cpu-cnt-btn" data-n="5" style="padding:6px 12px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:12px;cursor:pointer;">5</button>
      </div>
    </div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">é›£æ˜“åº¦</span>
      <div style="display:flex;gap:6px;">
        <button class="diff-btn" data-d="easy" style="padding:6px 10px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:10px;cursor:pointer;">EASY</button>
        <button class="diff-btn" data-d="normal" style="padding:6px 10px;background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:6px;color:var(--gold-light);font-family:Cinzel,serif;font-size:10px;cursor:pointer;">NORMAL</button>
        <button class="diff-btn" data-d="hard" style="padding:6px 10px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:10px;cursor:pointer;">HARD</button>
      </div>
    </div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">SB</span><input class="num-inp" id="off-sb" value="5"></div>
    <div class="row"><span style="font-size:12px;color:rgba(255,255,255,.5);">BB</span><input class="num-inp" id="off-bb" value="10"></div>
    <button class="btn" id="btn-start-offline">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
  </div>

  <div id="panel-online" style="display:none;">
  <div class="panel">
    <div class="ptitle">ã‚ãªãŸã®æƒ…å ±</div>
    <label class="flabel">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
    <input class="inp" id="my-name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1">
    <div class="row">
      <span style="font-size:12px;color:rgba(255,255,255,.5);">é–‹å§‹ãƒãƒƒãƒ—</span>
      <input class="num-inp" id="my-chips" value="500">
    </div>
  </div>
  <div class="panel">
    <div class="ptitle">ğŸ  ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</div>
    <button class="btn" id="btn-create">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
    <div id="room-created" style="display:none;margin-top:14px;">
      <div class="slabel">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼ï¼‰</div>
      <div class="code-big" id="code-disp">------</div>
      <div class="code-hint">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å¯¾æˆ¦ç›¸æ‰‹ã«ã‚·ã‚§ã‚¢</div>
      <div id="invite-url-wrap" style="margin:8px 0 4px;display:none;">
        <div style="font-size:10px;color:rgba(255,255,255,.4);font-family:Cinzel,serif;letter-spacing:1px;margin-bottom:4px;">ğŸ”— æ‹›å¾…ãƒªãƒ³ã‚¯ï¼ˆã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼ï¼‰</div>
        <div id="invite-url-disp" style="
          background:rgba(0,0,0,.5);
          border:1px solid rgba(201,168,76,.35);
          border-radius:8px;
          padding:8px 12px;
          font-size:11px;
          color:var(--gold-light);
          word-break:break-all;
          cursor:pointer;
          text-align:center;
          line-height:1.5;
        "></div>
        <div id="invite-copy-hint" style="font-size:10px;color:rgba(255,255,255,.3);text-align:center;margin-top:3px;">ã‚¿ãƒƒãƒ—ã§URLã‚’ã‚³ãƒ”ãƒ¼</div>
      </div>
      <div id="host-settings" style="display:none;margin-top:12px;padding:10px;background:rgba(0,0,0,.3);border-radius:8px;border:1px solid rgba(201,168,76,.2);">
        <div style="font-family:Cinzel,serif;font-size:10px;color:var(--gold-light);letter-spacing:2px;margin-bottom:8px;">HOST SETTINGS</div>
        <div class="row" style="margin-bottom:8px;">
          <span style="font-size:12px;color:rgba(255,255,255,.5);">SB</span>
          <input class="num-inp" id="room-sb" value="5" style="width:70px;">
        </div>
        <div class="row" style="margin-bottom:8px;">
          <span style="font-size:12px;color:rgba(255,255,255,.5);">BB</span>
          <input class="num-inp" id="room-bb" value="10" style="width:70px;">
        </div>
        <div class="row" style="margin-bottom:8px;">
          <span style="font-size:12px;color:rgba(255,255,255,.5);">é–‹å§‹ãƒãƒƒãƒ—</span>
          <div style="display:flex;gap:6px;align-items:center;">
            <input class="num-inp" id="host-chips" value="500" style="width:70px;">
            <button id="btn-apply-chips" style="padding:5px 10px;background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:6px;color:var(--gold-light);font-family:Cinzel,serif;font-size:10px;cursor:pointer;touch-action:manipulation;">é©ç”¨</button>
          </div>
        </div>
        <div class="row" style="margin-bottom:8px;">
          <span style="font-size:12px;color:rgba(255,255,255,.5);">CPUäººæ•°</span>
          <div style="display:flex;gap:5px;" id="host-cpu-btns">
            <button class="hcpu-btn" data-n="0" style="padding:4px 9px;background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:6px;color:var(--gold-light);font-family:Cinzel,serif;font-size:11px;cursor:pointer;">0</button>
            <button class="hcpu-btn" data-n="1" style="padding:4px 9px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:11px;cursor:pointer;">1</button>
            <button class="hcpu-btn" data-n="2" style="padding:4px 9px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:11px;cursor:pointer;">2</button>
            <button class="hcpu-btn" data-n="3" style="padding:4px 9px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:11px;cursor:pointer;">3</button>
            <button class="hcpu-btn" data-n="4" style="padding:4px 9px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:11px;cursor:pointer;">4</button>
          </div>
        </div>
        <div class="row">
          <span style="font-size:12px;color:rgba(255,255,255,.5);">é›£æ˜“åº¦</span>
          <div style="display:flex;gap:5px;" id="host-diff-btns">
            <button class="hdiff-btn" data-d="easy" style="padding:4px 8px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:10px;cursor:pointer;">EASY</button>
            <button class="hdiff-btn" data-d="normal" style="padding:4px 8px;background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:6px;color:var(--gold-light);font-family:Cinzel,serif;font-size:10px;cursor:pointer;">NORMAL</button>
            <button class="hdiff-btn" data-d="hard" style="padding:4px 8px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);border-radius:6px;color:rgba(255,255,255,.5);font-family:Cinzel,serif;font-size:10px;cursor:pointer;">HARD</button>
          </div>
        </div>
      </div>
      <div class="slabel" style="margin-top:12px;">å‚åŠ è€…</div>
      <div class="plist" id="plist"></div>
      <div id="room-msg" class="smsg s-info">å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
      <button class="btn" id="btn-start" disabled style="display:none;">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
      <button class="btn" id="btn-ready" style="display:none;background:rgba(201,168,76,.25);border-color:rgba(201,168,76,.5);">æº–å‚™å®Œäº†</button>
    </div>
  </div>
  <div class="panel">
    <div class="ptitle">ğŸšª ãƒ«ãƒ¼ãƒ ã«å‚åŠ </div>
    <div class="gap">
      <input class="inp" id="join-code" placeholder="XXXXXX" maxlength="6" style="margin-bottom:0;font-family:Cinzel,serif;font-size:20px;letter-spacing:6px;text-align:center;text-transform:uppercase;color:var(--gold-light);">
      <button class="btn-sm" id="btn-join">å‚åŠ </button>
    </div>
    <div id="join-msg" class="smsg"></div>
  </div>
  </div> <!-- /panel-online -->
</div>

<!-- ã‚²ãƒ¼ãƒ  -->

<div id="screen-game" class="screen">
  <div id="back-btn-wrap" style="display:none;width:100%;max-width:700px;margin:0 auto 6px;text-align:right;">
    <button id="btn-back-lobby" style="background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.25);border-radius:8px;padding:6px 14px;color:rgba(255,255,255,.6);font-family:Cinzel,serif;font-size:10px;letter-spacing:1px;cursor:pointer;touch-action:manipulation;" onclick="document.getElementById('confirm-overlay').classList.add('show');">âœ• ãƒ­ãƒ“ãƒ¼ã¸</button>
  </div>
  <div id="seats"></div>
  <div class="felt">
    <div id="phase">WAITING</div>
    <div id="comm-cards"></div>
    <div id="pot">POT: 0</div>
  </div>
  <div id="cpu-bar" style="display:none;width:100%;max-width:700px;margin:0 auto 6px;background:rgba(0,0,0,.5);border:1px solid rgba(0,150,255,.3);border-radius:10px;padding:8px 16px;text-align:center;">
    <div id="cpu-bar-text" style="font-family:Cinzel,serif;font-size:11px;color:#4af;letter-spacing:2px;">CPUæ€è€ƒä¸­...</div>
    <div style="height:3px;background:rgba(0,150,255,.2);border-radius:2px;margin-top:5px;overflow:hidden;"><div id="cpu-prog" style="height:100%;background:#4af;border-radius:2px;animation:cpuprog 1s linear forwards;"></div></div>
  </div>
  <div id="ibar"><div id="ibar-t"></div></div>
  <div id="ap" style="display:none;">
    <div id="ap-hd"><div id="ap-who"></div><div id="ap-info"></div></div>
    <div id="hdisp"></div>
    <div class="prow" id="prow"></div>
    <div class="bet-display" id="bet-display">0</div>
    <div class="bet-sub" id="bet-sub">BET / RAISE</div>
    <div class="chip-selector" id="chip-selector">
      <button class="chip-sel-btn chip-sel-500" data-v="500" title="500"><div class="cv">500</div></button>
      <button class="chip-sel-btn chip-sel-100" data-v="100" title="100"><div class="cv">100</div></button>
      <button class="chip-sel-btn chip-sel-25"  data-v="25"  title="25"><div class="cv">25</div></button>
      <button class="chip-sel-btn chip-sel-10"  data-v="10"  title="10"><div class="cv">10</div></button>
      <button class="chip-sel-btn chip-sel-5"   data-v="5"   title="5"><div class="cv">5</div></button>
      <button class="chip-sel-btn" data-v="clear" title="ã‚¯ãƒªã‚¢" style="background:rgba(100,0,0,.6);border-color:rgba(255,80,80,.4);color:#f88;font-size:14px;"><div class="cv">âœ•</div></button>
    </div>
    <input type="hidden" id="rinp" value="0">
    <input type="range" id="rslider" style="display:none;">
    <div class="brow" id="brow"></div>
  </div>
</div>

<div id="deal-overlay">
  <div id="deal-label">YOUR HAND</div>
  <div id="deal-cards-row"></div>
</div>
<div id="phase-overlay">
  <div id="phase-card">
    <div id="phase-name">FLOP</div>
    <div id="phase-cards-row"></div>
  </div>
</div>
<div id="mover">
  <div class="mcard">
    <div class="mtitle" id="mtitle"></div>
    <div id="mcomm" style="display:none;flex-wrap:wrap;gap:3px;justify-content:center;margin:6px 0;"></div>
    <div class="mcards" id="mcards"></div>
    <div class="mbody" id="mbody"></div>
    <button class="mnext" id="mnext">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰</button>
  </div>
</div>

<script>
(function(){

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase REST API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var DB = 'https://poker-cc448-default-rtdb.asia-southeast1.firebasedatabase.app';
var _polls = {};
var offlineMode = false; // æ—©æœŸå®£è¨€ï¼šfbGetç­‰ã®ã‚¬ãƒ¼ãƒ‰ç”¨

function fbUrl(path){ return DB + '/' + path + '.json'; }

function fbGet(path, cb){
  if(offlineMode){ setTimeout(function(){cb(null);},0); return; }
  try {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', fbUrl(path), true);
    xhr.timeout = 5000;
    xhr.onload = function(){
      try { cb(JSON.parse(xhr.responseText)); } catch(e){ cb(null); }
    };
    xhr.onerror = function(){ cb(null); };
    xhr.ontimeout = function(){ cb(null); };
    xhr.send();
  } catch(e){ setTimeout(function(){cb(null);},0); }
}
function fbSet(path, val, cb){
  if(offlineMode){ if(cb) setTimeout(cb,0); return; }
  try {
    var xhr = new XMLHttpRequest();
    xhr.open('PUT', fbUrl(path), true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.timeout = 5000;
    xhr.onload = function(){ if(cb) cb(); };
    xhr.onerror = function(){ if(cb) cb(); };
    xhr.ontimeout = function(){ if(cb) cb(); };
    xhr.send(JSON.stringify(val));
  } catch(e){ if(cb) setTimeout(cb,0); }
}
function fbPatch(path, val, cb){
  if(offlineMode){ if(cb) setTimeout(cb,0); return; }
  try {
    var xhr = new XMLHttpRequest();
    xhr.open('PATCH', fbUrl(path), true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.timeout = 5000;
    xhr.onload = function(){ if(cb) cb(); };
    xhr.onerror = function(){ if(cb) cb(); };
    xhr.ontimeout = function(){ if(cb) cb(); };
    xhr.send(JSON.stringify(val));
  } catch(e){ if(cb) setTimeout(cb,0); }
}
function fbListen(path, cb, skipInitial){
  if(offlineMode){ return; }
  if(!_polls[path]) _polls[path] = {last:null, cbs:[], timer:null};
  _polls[path].cbs.push(cb);
  if(!skipInitial){
    fbGet(path, function(d){
      if(!_polls[path]) return;
      _polls[path].last = JSON.stringify(d);
      cb(d);
    });
  }
  if(!_polls[path].timer){
    _polls[path].timer = setInterval(function(){
      if(!_polls[path]) return;
      fbGet(path, function(d){
        if(!_polls[path]) return;
        var j = JSON.stringify(d);
        if(j !== _polls[path].last){
          // nullã¸ã®å¤‰åŒ–ã¯è¨˜éŒ²ã™ã‚‹ãŒã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å‘¼ã¶ï¼ˆonStateå´ã§ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
          _polls[path].last = j;
          _polls[path].cbs.forEach(function(fn){ fn(d); });
        }
      });
    }, 800);
  }
}
function fbOff(path){
  if(_polls[path]){ clearInterval(_polls[path].timer); delete _polls[path]; }
}

// æ¥ç¶šç¢ºèªã¯ä¸‹éƒ¨ã®setModeå®šç¾©å¾Œã«å®Ÿè¡Œ


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒãƒƒãƒ—è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CHIP_DENOMS = [500,100,25,10,5];

function snap5(n){ return Math.round(n/5)*5; } // 5å˜ä½ã«ä¸¸ã‚

// â”€â”€ ãƒãƒƒãƒ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼UI â”€â”€
var _chipMinR=0, _chipMaxR=0, _chipInited=false;

function setupChipSelector(minR, maxR){
  _chipMinR=minR; _chipMaxR=maxR;
  document.getElementById('rinp').value=minR;
  // ã‚¤ãƒ™ãƒ³ãƒˆã¯æœ€åˆã®1å›ã ã‘ç™»éŒ²
  if(!_chipInited){
    _chipInited=true;
    document.querySelectorAll('.chip-sel-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        var v=this.dataset.v;
        if(v==='clear'){
          document.getElementById('rinp').value=_chipMinR;
        } else {
          var cur=snap5(+document.getElementById('rinp').value||0);
          var add=snap5(+v);
          var next=Math.min(cur+add, _chipMaxR);
          if(next<_chipMinR) next=_chipMinR;
          document.getElementById('rinp').value=next;
        }
        updateBetDisplay();
      });
    });
  }
  updateBetDisplay();
}

function setChipBet(v, minR, maxR){
  document.getElementById('rinp').value=Math.min(Math.max(snap5(v),minR),maxR);
  updateBetDisplay();
}

function updateBetDisplay(){
  var v=snap5(+document.getElementById('rinp').value||0);
  document.getElementById('rinp').value=v;
  document.getElementById('bet-display').textContent=v;
  document.getElementById('bet-sub').textContent=
    v>=_chipMinR&&v>0 ? 'ãƒ¬ã‚¤ã‚ºé¡ï¼ˆæœ€å° '+_chipMinR+'ï¼‰' : 'BET / RAISE';
  // ãƒãƒƒãƒ—ãƒœã‚¿ãƒ³ï¼šè¿½åŠ ã™ã‚‹ã¨maxRã‚’è¶…ãˆã‚‹ãªã‚‰ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
  document.querySelectorAll('.chip-sel-btn').forEach(function(btn){
    if(btn.dataset.v==='clear'){ btn.style.opacity='1'; return; }
    var add=snap5(+btn.dataset.v);
    btn.style.opacity=(v+add>_chipMaxR) ? '0.3' : '1';
    btn.style.cursor=(v+add>_chipMaxR) ? 'not-allowed' : 'pointer';
  });
}

function chipsHTML(amount){
  if(!amount || amount<=0) return '<span style="color:rgba(255,255,255,.3);font-size:10px;">-</span>';
  var remain = Math.abs(Math.round(amount));
  var stacks = [];
  CHIP_DENOMS.forEach(function(d){
    var cnt = Math.floor(remain/d);
    if(cnt>0){ stacks.push({d:d,cnt:cnt}); remain-=d*cnt; }
  });
  if(remain>0) stacks.push({d:1,cnt:remain});
  var html = '<div class="chips-stack">';
  stacks.forEach(function(s){
    var cls = 'chip chip-'+s.d;
    var label = s.d===500?'500':s.d===100?'100':(s.d+'');
    html += '<div class="'+cls+'">'+label+(s.cnt>1?'<span class="chip-count">Ã—'+s.cnt+'</span>':'')+'</div>';
  });
  html += '</div><div class="chips-total">'+amount+'</div>';
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚«ãƒ¼ãƒ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var SUITS=['â™ ','â™¥','â™¦','â™£'], RANKS=['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
var RV={}; RANKS.forEach(function(r,i){RV[r]=i+2;});
var HN=['ãƒã‚¤ã‚«ãƒ¼ãƒ‰','ãƒ¯ãƒ³ãƒšã‚¢','ãƒ„ãƒ¼ãƒšã‚¢','ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰','ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ','ãƒ•ãƒ©ãƒƒã‚·ãƒ¥','ãƒ•ãƒ«ãƒã‚¦ã‚¹','ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰','ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥'];
var RN_MAP={2:'2',3:'3',4:'4',5:'5',6:'6',7:'7',8:'8',9:'9',10:'10',11:'J',12:'Q',13:'K',14:'A'};
function handDetail(score){
  var h=score.hi; var r=score.rank;
  if(r===8) return RN_MAP[h[0]]+'ãƒã‚¤ ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥';
  if(r===7) return RN_MAP[h[0]]+'ã®ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰ (ã‚­ãƒƒã‚«ãƒ¼:'+RN_MAP[h[1]]+')';
  if(r===6) return RN_MAP[h[0]]+' FULL of '+RN_MAP[h[1]];
  if(r===5) return RN_MAP[h[0]]+'ãƒã‚¤ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥';
  if(r===4) return RN_MAP[h[0]]+'ãƒã‚¤ ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ';
  if(r===3) return RN_MAP[h[0]]+'ã®ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ (ã‚­ãƒƒã‚«ãƒ¼:'+RN_MAP[h[1]]+','+RN_MAP[h[2]]+')';
  if(r===2) return RN_MAP[h[0]]+'ã¨'+RN_MAP[h[1]]+'ã®ãƒ„ãƒ¼ãƒšã‚¢ (ã‚­ãƒƒã‚«ãƒ¼:'+RN_MAP[h[2]]+')';
  if(r===1) return RN_MAP[h[0]]+'ã®ãƒ¯ãƒ³ãƒšã‚¢ (ã‚­ãƒƒã‚«ãƒ¼:'+RN_MAP[h[1]]+'>'+RN_MAP[h[2]]+'>'+RN_MAP[h[3]]+')';
  if(r===0) return RN_MAP[h[0]]+'>'+RN_MAP[h[1]]+'>'+RN_MAP[h[2]]+'>'+RN_MAP[h[3]]+'>'+RN_MAP[h[4]];
  return '';
}
// 2ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã§ãªãœå‹ã£ãŸã‹ã®ç†ç”±ã‚’è¿”ã™
function winReason(winner, loser){
  if(!winner||!loser||!winner.best||!loser.best) return '';
  var ws=winner.best.score, ls=loser.best.score;
  if(ws.rank!==ls.rank) return ''; // å½¹ãŒé•ã†å ´åˆã¯å½¹åã§æ˜ç¢º
  var h1=ws.hi, h2=ls.hi, r=ws.rank;
  // åŒã˜å½¹å†…ã§ã©ã®hiè¦ç´ ã§å‹ã£ãŸã‹
  for(var i=0;i<h1.length;i++){
    if((h1[i]||0)!==(h2[i]||0)){
      if(r===1 && i===0) return RN_MAP[h1[0]]+'ãƒšã‚¢ã§å‹åˆ©';
      if(r===1 && i>0)   return 'ã‚­ãƒƒã‚«ãƒ¼ '+RN_MAP[h1[i]]+' > '+RN_MAP[h2[i]]+' ã§å‹åˆ©';
      if(r===2 && i===0) return 'ä¸Šãƒšã‚¢ '+RN_MAP[h1[0]]+' > '+RN_MAP[h2[0]]+' ã§å‹åˆ©';
      if(r===2 && i===1) return 'ä¸‹ãƒšã‚¢ '+RN_MAP[h1[1]]+' > '+RN_MAP[h2[1]]+' ã§å‹åˆ©';
      if(r===2 && i===2) return 'ã‚­ãƒƒã‚«ãƒ¼ '+RN_MAP[h1[2]]+' > '+RN_MAP[h2[2]]+' ã§å‹åˆ©';
      if(r===0)          return 'ãƒã‚¤ã‚«ãƒ¼ãƒ‰ '+RN_MAP[h1[i]]+' > '+RN_MAP[h2[i]]+' ã§å‹åˆ©';
      if(r===3 && i===0) return RN_MAP[h1[0]]+'ã®ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã§å‹åˆ©';
      if(r===3 && i>0)   return 'ã‚­ãƒƒã‚«ãƒ¼ '+RN_MAP[h1[i]]+' > '+RN_MAP[h2[i]]+' ã§å‹åˆ©';
      if(r===5)          return 'ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ '+RN_MAP[h1[i]]+' > '+RN_MAP[h2[i]]+' ã§å‹åˆ©';
      return RN_MAP[h1[i]]+' > '+RN_MAP[h2[i]]+' ã§å‹åˆ©';
    }
  }
  return 'å¼•ãåˆ†ã‘';
}
function makeDeck(){var d=[];SUITS.forEach(function(s){RANKS.forEach(function(r){d.push({r:r,s:s});});});return d;}
function shuffle(a){for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=a[i];a[i]=a[j];a[j]=t;}return a;}
function isRed(s){return s==='â™¥'||s==='â™¦';}
function cH(c,sm,lg){
  var sz=lg?'lg':sm?'sm':'';
  var wrap='<span class="card-wrap'+(sz?' '+sz:'')+'">',wend='</span>';

  // è£é¢
  if(!c){
    var bid="bp"+(Math.random().toString(36).substr(2,6));return wrap+'<svg viewBox="0 0 44 64" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="64" rx="4" fill="#1a3a8a"/><rect x="3" y="3" width="38" height="58" rx="3" fill="none" stroke="#c9a84c" stroke-width="1.2"/><pattern id="'+bid+'" patternUnits="userSpaceOnUse" width="8" height="8"><rect width="8" height="8" fill="#1a3a8a"/><rect x="0" y="0" width="4" height="4" fill="#1e42a0" opacity="0.5"/><rect x="4" y="4" width="4" height="4" fill="#1e42a0" opacity="0.5"/></pattern><rect x="4" y="4" width="36" height="56" rx="2" fill="url(#'+bid+')"/></svg>'+wend;
  }

  var red=isRed(c.s);
  var col=red?'#d0021b':'#1a1a1a';
  var S=c.s, R=c.r;

  // ã‚¹ãƒ¼ãƒˆã®SVGãƒ‘ã‚¹ï¼ˆå°ãƒ»ä¸­ãƒ»å¤§ï¼‰
  function suitPath(x,y,size,col){
    var h=size/2;
    if(S==='â™ '){
      return '<g transform="translate('+x+','+y+')">'
        +'<path d="M0,-'+h+' C0,-'+h+' -'+(h*.9)+',0 -'+(h*.9)+','+(h*.4)+' C-'+(h*.9)+','+(h*.9)+' -'+(h*.3)+','+(h*.8)+' 0,'+(h*.5)+' C'+(h*.3)+','+(h*.8)+' '+(h*.9)+','+(h*.9)+' '+(h*.9)+','+(h*.4)+' C'+(h*.9)+',0 0,-'+h+' 0,-'+h+'" fill="'+col+'"/>'
        +'<rect x="-'+(h*.15)+'" y="'+(h*.5)+'" width="'+(h*.3)+'" height="'+(h*.5)+'" fill="'+col+'"/>'
        +'<ellipse cx="0" cy="'+(h*1.1)+'" rx="'+(h*.45)+'" ry="'+(h*.15)+'" fill="'+col+'"/>'
        +'</g>';
    } else if(S==='â™¥'){
      // æ­£ç¢ºãªãƒãƒ¼ãƒˆå½¢ï¼š2ã¤ã®å††å¼§ï¼‹ä¸‹å‘ãä¸‰è§’
      return '<g transform="translate('+x+','+y+')">'
        +'<path d="M0,'+(h*.9)+' '
          +'L-'+(h*.95)+','+(h*0.1)+' '
          +'A'+(h*.5)+','+(h*.5)+' 0 0,1 0,-'+(h*.4)+' '
          +'A'+(h*.5)+','+(h*.5)+' 0 0,1 '+(h*.95)+','+(h*0.1)+' '
          +'Z" fill="'+col+'"/>'
        +'</g>';
    } else if(S==='â™¦'){
      return '<g transform="translate('+x+','+y+')">'
        +'<path d="M0,-'+h+' L'+h+',0 L0,'+h+' L-'+h+',0 Z" fill="'+col+'"/>'
        +'</g>';
    } else { // â™£
      return '<g transform="translate('+x+','+y+')">'
        +'<circle cx="0" cy="-'+(h*.2)+'" r="'+(h*.45)+'" fill="'+col+'"/>'
        +'<circle cx="-'+(h*.4)+'" cy="'+(h*.25)+'" r="'+(h*.4)+'" fill="'+col+'"/>'
        +'<circle cx="'+(h*.4)+'" cy="'+(h*.25)+'" r="'+(h*.4)+'" fill="'+col+'"/>'
        +'<rect x="-'+(h*.13)+'" y="'+(h*.4)+'" width="'+(h*.26)+'" height="'+(h*.55)+'" fill="'+col+'"/>'
        +'<ellipse cx="0" cy="'+(h*1.0)+'" rx="'+(h*.38)+'" ry="'+(h*.15)+'" fill="'+col+'"/>'
        +'</g>';
    }
  }

  // ãƒ©ãƒ³ã‚¯æ–‡å­—
  function rankText(x,y,fs,col,rot){
    var t='<text x="'+x+'" y="'+y+'" font-size="'+fs+'" font-weight="bold" font-family="Georgia,serif" fill="'+col+'" text-anchor="middle" dominant-baseline="middle"';
    if(rot) t+=' transform="rotate(180 '+x+' '+y+')"';
    t+='>'+R+'</text>';
    return t;
  }

  // ãƒãƒ¼ã‚¯é…ç½®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ¨™æº–ãƒˆãƒ©ãƒ³ãƒ—æº–æ‹ ï¼‰
  // [x, y, rotate180] rotate=trueã§ä¸‹å‘ã
  var pips={
    'A': [[22,32,false]],
    '2': [[22,15,false],[22,49,true]],
    '3': [[22,14,false],[22,32,false],[22,50,true]],
    '4': [[12,16,false],[32,16,false],[12,48,true],[32,48,true]],
    '5': [[12,16,false],[32,16,false],[22,32,false],[12,48,true],[32,48,true]],
    '6': [[12,15,false],[32,15,false],[12,32,false],[32,32,false],[12,49,true],[32,49,true]],
    '7': [[12,15,false],[32,15,false],[22,24,false],[12,32,true],[32,32,true],[12,49,true],[32,49,true]],
    '8': [[12,14,false],[32,14,false],[22,23,false],[12,32,true],[32,32,true],[22,41,true],[12,50,true],[32,50,true]],
    '9': [[12,13,false],[32,13,false],[12,24,false],[32,24,false],[22,32,false],[12,40,true],[32,40,true],[12,51,true],[32,51,true]],
    '10':[[12,13,false],[32,13,false],[12,23,false],[32,23,false],[22,30,false],[22,34,true],[12,41,true],[32,41,true],[12,51,true],[32,51,true]]
  };

  var svgParts='<svg viewBox="0 0 44 64" xmlns="http://www.w3.org/2000/svg">';
  // ã‚«ãƒ¼ãƒ‰èƒŒæ™¯
  svgParts+='<rect width="44" height="64" rx="4" fill="#fff"/>';
  svgParts+='<rect x="0.5" y="0.5" width="43" height="63" rx="3.5" fill="none" stroke="#ddd" stroke-width="0.8"/>';

  var faceCards=['J','Q','K'];
  if(faceCards.indexOf(R)>=0){
    // çµµæœ­
    svgParts+=rankText(6,10,8,col,false);
    svgParts+=suitPath(6,18,7,col);
    svgParts+=rankText(38,54,8,col,true);
    svgParts+=suitPath(38,46,7,col);

    // çµµæŸ„ã‚¨ãƒªã‚¢ï¼ˆæ ï¼‰
    svgParts+='<rect x="7" y="24" width="30" height="20" rx="2" fill="'+(red?'#fff0f0':'#f0f4ff')+'" stroke="'+col+'" stroke-width="0.8"/>';

    if(R==='J'){
      // ã‚¸ãƒ£ãƒƒã‚¯ï¼šè‹¥ã„é¨å£«
      svgParts+='<text x="22" y="36" font-size="14" text-anchor="middle" dominant-baseline="middle">'+
        (red?'ğŸ¥·':'âš”ï¸')+'</text>';
    } else if(R==='Q'){
      // ã‚¯ã‚¤ãƒ¼ãƒ³ï¼šå¥³ç‹
      svgParts+='<text x="22" y="36" font-size="14" text-anchor="middle" dominant-baseline="middle">'+
        (red?'ğŸ‘¸':'ğŸ«…')+'</text>';
    } else {
      // ã‚­ãƒ³ã‚°ï¼šç‹æ§˜
      svgParts+='<text x="22" y="36" font-size="14" text-anchor="middle" dominant-baseline="middle">'+
        (red?'ğŸ¤´':'ğŸ‘‘')+'</text>';
    }

  } else if(R==='A'){
    // ã‚¨ãƒ¼ã‚¹ï¼šå¤§ããªã‚¹ãƒ¼ãƒˆ
    svgParts+=rankText(6,10,9,col,false);
    svgParts+=suitPath(6,19,7,col);
    svgParts+=rankText(38,54,9,col,true);
    svgParts+=suitPath(38,45,7,col);
    svgParts+=suitPath(22,32,16,col); // å¤§ãã„ä¸­å¤®ãƒãƒ¼ã‚¯

  } else {
    // æ•°å­—ã‚«ãƒ¼ãƒ‰ï¼šã‚³ãƒ¼ãƒŠãƒ¼ã«ãƒ©ãƒ³ã‚¯ã®ã¿ï¼ˆã‚¹ãƒ¼ãƒˆãƒãƒ¼ã‚¯ãªã—ï¼‰
    var fs=R==='10'?7.5:8;
    svgParts+=rankText(5.5,9,fs,col,false);
    svgParts+=rankText(38.5,55,fs,col,true);

    // ãƒ”ãƒƒãƒ—é…ç½®
    var pts=pips[R]||[];
    var pip_size = pts.length<=4?9:pts.length<=6?8:7;

    pts.forEach(function(p){
      var rot = p[2];
      svgParts+='<g transform="translate('+p[0]+','+p[1]+')'+(rot?' rotate(180)':'')+'">'
        + suitPath(0,0,pip_size,col)
        +'</g>';
    });
  }

  svgParts+='</svg>';
  return wrap+svgParts+wend;
}
function combs(a,k){if(!k)return[[]];if(!a.length)return[];return combs(a.slice(1),k-1).map(function(c){return[a[0]].concat(c);}).concat(combs(a.slice(1),k));}
function sc5(cards){
  var v=cards.map(function(c){return RV[c.r];}).sort(function(a,b){return b-a;});
  var s=cards.map(function(c){return c.s;});
  var fl=s.every(function(x){return x===s[0];});
  var st=false,sh=0;
  if(v[0]-v[4]===4&&(new Set(v)).size===5){st=true;sh=v[0];}
  if(JSON.stringify(v)==='[14,5,4,3,2]'){st=true;sh=5;v=[5,4,3,2,1];}
  var cnt={};v.forEach(function(x){cnt[x]=(cnt[x]||0)+1;});
  var g=Object.keys(cnt).map(function(x){return{v:+x,c:cnt[x]};}).sort(function(a,b){return b.c-a.c||b.v-a.v;});
  var rank,hi;
  if(fl&&st){rank=8;hi=[sh];}
  else if(g[0].c===4){rank=7;hi=[g[0].v,g[1].v];}
  else if(g[0].c===3&&g[1].c===2){rank=6;hi=[g[0].v,g[1].v];}
  else if(fl){rank=5;hi=v;}
  else if(st){rank=4;hi=[sh];}
  else if(g[0].c===3){rank=3;hi=[g[0].v,g[1].v,g[2].v];}
  else if(g[0].c===2&&g[1].c===2){rank=2;hi=[g[0].v,g[1].v,g[2].v];}
  else if(g[0].c===2){rank=1;hi=[g[0].v,g[1].v,g[2].v,g[3].v];}
  else{rank=0;hi=v;}
  return{rank:rank,hi:hi};
}
function cmpSc(a,b){if(a.rank!==b.rank)return a.rank-b.rank;for(var i=0;i<Math.max(a.hi.length,b.hi.length);i++){var d=(a.hi[i]||0)-(b.hi[i]||0);if(d)return d;}return 0;}
function evalHand(cards){var best=null;combs(cards,5).forEach(function(c){var sc=sc5(c);if(!best||cmpSc(sc,best.score)>0)best={score:sc,cards:c};});return best;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ­ãƒ“ãƒ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ¢ãƒ¼ãƒ‰ãƒ»CPUè¨­å®š
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CPU_NAMES=['ã‚¢ãƒ¬ãƒƒã‚¯ã‚¹','ã‚½ãƒ•ã‚£ã‚¢','ãƒªã‚ªãƒ³','ã‚¨ãƒ','ãƒ«ãƒ¼ã‚«ã‚¹','ãƒŸã‚¢'];
var cpuDifficulty='normal', cpuCount=1;

function setMode(mode){
  var onBtn=document.getElementById('btn-mode-online');
  var offBtn=document.getElementById('btn-mode-offline');
  var onPanel=document.getElementById('panel-online');
  var offPanel=document.getElementById('panel-offline');
  if(mode==='online'){
    onBtn.style.background='rgba(201,168,76,.15)';onBtn.style.borderColor='var(--gold)';onBtn.style.color='var(--gold-light)';
    offBtn.style.background='rgba(0,0,0,.3)';offBtn.style.borderColor='rgba(255,255,255,.2)';offBtn.style.color='rgba(255,255,255,.6)';
    onPanel.style.display='block'; offPanel.style.display='none';
  } else {
    offBtn.style.background='rgba(201,168,76,.15)';offBtn.style.borderColor='var(--gold)';offBtn.style.color='var(--gold-light)';
    onBtn.style.background='rgba(0,0,0,.3)';onBtn.style.borderColor='rgba(255,255,255,.2)';onBtn.style.color='rgba(255,255,255,.6)';
    offPanel.style.display='block'; onPanel.style.display='none';
  }
}

// ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³è¨­å®š
document.getElementById('btn-mode-offline').onclick = function(){ setMode('offline'); };

// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³CPUè¨­å®šï¼ˆHOST SETTINGSãƒ‘ãƒãƒ«ã§ç®¡ç†ï¼‰
var onlineCpuCount=0, onlineCpuDifficulty='normal';
// ãƒ­ãƒ“ãƒ¼ãƒœã‚¿ãƒ³ã®onclickã¯HTMLå´ã§å®šç¾©æ¸ˆã¿

// æº–å‚™å®Œäº†ãƒœã‚¿ãƒ³
document.getElementById('btn-ready').addEventListener('click', function(){
  if(!roomPath) return;
  var patch={}; patch[myId]=true;
  fbPatch(roomPath+'/ready', patch, function(){
    document.getElementById('btn-ready').textContent='âœ“ æº–å‚™å®Œäº†';
    document.getElementById('btn-ready').style.background='rgba(201,168,76,.6)';document.getElementById('btn-ready').style.borderColor='rgba(201,168,76,.9)';
    document.getElementById('btn-ready').disabled=true;
  });
});

// ãƒ›ã‚¹ãƒˆè¨­å®šãƒ‘ãƒãƒ«åˆæœŸåŒ–
function initHostSettings(){
  // CPUäººæ•°ãƒœã‚¿ãƒ³
  document.querySelectorAll('.hcpu-btn').forEach(function(b){
    b.addEventListener('click', function(){
      onlineCpuCount=+this.dataset.n;
      document.querySelectorAll('.hcpu-btn').forEach(function(x){
        x.style.background='rgba(0,0,0,.4)';x.style.borderColor='rgba(255,255,255,.2)';x.style.color='rgba(255,255,255,.5)';
      });
      this.style.background='rgba(201,168,76,.15)';this.style.borderColor='var(--gold)';this.style.color='var(--gold-light)';
      fbPatch(roomPath, {cpuCount:onlineCpuCount}, function(){});
    });
  });
  // é›£æ˜“åº¦ãƒœã‚¿ãƒ³
  document.querySelectorAll('.hdiff-btn').forEach(function(b){
    b.addEventListener('click', function(){
      onlineCpuDifficulty=this.dataset.d;
      document.querySelectorAll('.hdiff-btn').forEach(function(x){
        x.style.background='rgba(0,0,0,.4)';x.style.borderColor='rgba(255,255,255,.2)';x.style.color='rgba(255,255,255,.5)';
      });
      this.style.background='rgba(201,168,76,.15)';this.style.borderColor='var(--gold)';this.style.color='var(--gold-light)';
      fbPatch(roomPath, {cpuDifficulty:onlineCpuDifficulty}, function(){});
    });
  });
  // ãƒãƒƒãƒ—ãƒ»SBãƒ»BB é©ç”¨ãƒœã‚¿ãƒ³
  document.getElementById('btn-apply-chips').addEventListener('click', function(){
    var newChips=+document.getElementById('host-chips').value||500;
    var newSB=+document.getElementById('room-sb').value||5;
    var newBB=+document.getElementById('room-bb').value||10;
    SB=newSB; BB=newBB; myChips=newChips;
    // SB/BB ã‚’Firebaseã«æ›´æ–°
    fbPatch(roomPath, {SB:newSB, BB:newBB}, function(){});
    // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒƒãƒ—ã‚’æ›´æ–°
    fbGet(roomPath+'/players', function(ps){
      if(!ps) return;
      var patch={};
      Object.keys(ps).forEach(function(id){ patch[id+'/chips']=newChips; });
      fbPatch(roomPath+'/players', patch, function(){
        var btn=document.getElementById('btn-apply-chips');
        btn.textContent='âœ“ é©ç”¨æ¸ˆã¿'; setTimeout(function(){btn.textContent='é©ç”¨';},1200);
      });
    });
  });
}
document.getElementById('btn-mode-online').onclick = function(){
  var el = document.getElementById('conn-badge');
  // ã™ã§ã«ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç¢ºèªæ¸ˆã¿ãªã‚‰ãã®ã¾ã¾åˆ‡æ›¿
  if(el.className.indexOf('b-ok') >= 0){ setMode('online'); return; }
  // æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹
  el.textContent = 'æ¥ç¶šç¢ºèªä¸­...'; el.className = 'badge b-info';
  var done = false;
  function fail(){
    if(done) return; done = true;
    el.textContent = 'âš  æ¥ç¶šç¢ºèªä¸­...'; el.className = 'badge b-warn';
    // ã‚¢ãƒ©ãƒ¼ãƒˆã¯å‡ºã•ãšã€å®Ÿéš›ã®æ¥ç¶šè©¦è¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹
  }
  function ok(){
    if(done) return; done = true;
    el.textContent = 'âœ“ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¥ç¶šä¸­'; el.className = 'badge b-ok';
    setMode('online');
  }
  var t = setTimeout(fail, 8000);
  try {
    var xhr = new XMLHttpRequest();
    xhr.open('PUT', fbUrl('ping'), true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.timeout = 8000;
    xhr.onload = function(){ clearTimeout(t); if(xhr.status>=200&&xhr.status<300) ok(); else fail(); };
    xhr.onerror = function(){ clearTimeout(t); fail(); };
    xhr.ontimeout = function(){ clearTimeout(t); fail(); };
    xhr.send('"ok"');
  } catch(e){ clearTimeout(t); fail(); }
};

// æ¥ç¶šç¢ºèªã¯ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®ã¿å®Ÿè¡Œ

// CPUäººæ•°ãƒœã‚¿ãƒ³
document.querySelectorAll('.cpu-cnt-btn').forEach(function(b){
  b.addEventListener('click',function(){
    cpuCount=+this.dataset.n;
    document.querySelectorAll('.cpu-cnt-btn').forEach(function(x){
      x.style.background='rgba(0,0,0,.4)';x.style.borderColor='rgba(255,255,255,.2)';x.style.color='rgba(255,255,255,.5)';
    });
    this.style.background='rgba(201,168,76,.15)';this.style.borderColor='var(--gold)';this.style.color='var(--gold-light)';
  });
});

// é›£æ˜“åº¦ãƒœã‚¿ãƒ³
document.querySelectorAll('.diff-btn').forEach(function(b){
  b.addEventListener('click',function(){
    cpuDifficulty=this.dataset.d;
    document.querySelectorAll('.diff-btn').forEach(function(x){
      x.style.background='rgba(0,0,0,.4)';x.style.borderColor='rgba(255,255,255,.2)';x.style.color='rgba(255,255,255,.5)';
    });
    this.style.background='rgba(201,168,76,.15)';this.style.borderColor='var(--gold)';this.style.color='var(--gold-light)';
  });
});

// ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ é–‹å§‹
document.getElementById('btn-start-offline').addEventListener('click',function(){
  var name=document.getElementById('off-name').value.trim()||'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
  var chips=+document.getElementById('off-chips').value||500;
  SB=+document.getElementById('off-sb').value||5;
  BB=+document.getElementById('off-bb').value||10;
  offlineMode=true;
  var ps=[{name:name,chips:chips,pid:'human',isMe:true,idx:0,isCpu:false,
           hole:[],bet:0,totalBet:0,folded:false,allIn:false,active:true}];
  for(var i=0;i<cpuCount;i++){
    ps.push({name:CPU_NAMES[i],chips:chips,pid:'cpu'+i,isMe:false,idx:i+1,isCpu:true,
             hole:[],bet:0,totalBet:0,folded:false,allIn:false,active:true});
  }
  launchOffline(ps);
});

function launchOffline(ps){
  players=ps;
  ps.forEach(function(p,i){if(p.isMe)myIdx=i;});
  gamePath=''; holePfx='';
  document.getElementById('back-btn-wrap').style.display='block';
  showScreen('screen-game');
  startRoundOffline();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CPU AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function preflopStrength(hole){
  var RV2={'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};
  var r1=RV2[hole[0].r],r2=RV2[hole[1].r];
  var suited=hole[0].s===hole[1].s,hi=Math.max(r1,r2),lo=Math.min(r1,r2);
  var s=hi/14*0.6;
  if(r1===r2)s+=0.3;if(suited)s+=0.05;if(hi-lo<=3)s+=0.05;if(lo>=10)s+=0.1;
  return Math.min(s,1);
}
function handStrengthCpu(hole,community){
  if(!community.length) return preflopStrength(hole);
  var r=evalHand(hole.concat(community));
  return Math.min(r.score.rank/8+(r.score.hi[0]||0)/14*0.05,1);
}
function cpuDecide(p,state){
  if(!p.hole||p.hole.length<2){ return{action:'fold',label:'FOLD'}; }
  var diff=state.difficulty,str=handStrengthCpu(p.hole,state.community);
  var potVal=state.pot,toCall=state.curBet-p.bet,canCheck=toCall<=0;
  var potOdds=potVal>0?toCall/(potVal+toCall):0;
  var noise=diff==='easy'?(Math.random()-.5)*.35:diff==='normal'?(Math.random()-.5)*.18:(Math.random()-.5)*.08;
  var eff=Math.min(1,Math.max(0,str+noise+(state.phase>=2?.05:0)));
  var bluff=Math.random()<(diff==='easy'?.04:diff==='normal'?.10:.18)&&p.chips>toCall*2;
  var BB2=state.BB;
  if(bluff&&!canCheck){var ra=Math.min(p.chips+p.bet,state.curBet+Math.max(BB2,Math.floor(potVal*.5)));return{action:'raise',amount:ra,label:'RAISE'};}
  if(canCheck){
    if(eff>.72){var bet=Math.min(p.chips+p.bet,state.curBet+Math.floor(potVal*(.5+eff*.5)));return{action:'raise',amount:bet,label:'BET'};}
    return{action:'check',label:'CHECK'};
  }
  if(eff>.82){var ra2=Math.min(p.chips+p.bet,state.curBet+Math.floor(potVal*(.6+eff*.4)));if(ra2<=state.curBet)return{action:'call',label:'CALL'};return{action:'raise',amount:ra2,label:'RAISE'};}
  if(eff>potOdds+.1) return{action:'call',label:'CALL'};
  if(diff==='easy'&&eff>.2) return{action:'call',label:'CALL'};
  return{action:'fold',label:'FOLD'};
}

function showCpuThinking(p,cb){
  var bar=document.getElementById('cpu-bar');bar.style.display='block';
  document.getElementById('cpu-bar-text').textContent=p.name+' ãŒè€ƒãˆã¦ã„ã¾ã™...';
  var prog=document.getElementById('cpu-prog');
  prog.style.animation='none';prog.offsetHeight;prog.style.animation='cpuprog 1s linear forwards';
  setTimeout(cb,600+Math.random()*900);
}
function hideCpuBar(){document.getElementById('cpu-bar').style.display='none';}

// â”€â”€ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ— â”€â”€
function startRoundOffline(){
  _allInRevealed=false;
  _commAnimating=false;
  // åˆå›ã®ã¿ initialChips ã‚’è¨­å®š
  if(!_initialChips) _initialChips = +document.getElementById('off-chips').value||500;
  deck=shuffle(makeDeck());comm=[];pot=0;phase=0;curBet=0;lastRaise=BB;acts=[];
  players.forEach(function(p){
    // eliminatedãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
    // (ãƒªãƒã‚¤æ¸ˆã¿ã¯eliminated=falseãªã®ã§ãã®ã¾ã¾ç¶šè¡Œ)
    if(p.eliminated) p.active=false;
    p.hole=[];p.bet=0;p.totalBet=0;p.folded=false;p.allIn=false;
  });
  var active=players.filter(function(p){return p.active;});
  if(active.length<2){
    var w=active[0]||players[0];
    showMsg('ã‚²ãƒ¼ãƒ çµ‚äº†','<span class="wn">'+w.name+'</span>ã®å„ªå‹ï¼','ã‚‚ã†ä¸€åº¦',function(){document.getElementById('back-btn-wrap').style.display='none';showScreen('screen-lobby');offlineMode=false;});
    return;
  }
  dealerIdx=(dealerIdx+1)%players.length;
  while(!players[dealerIdx].active)dealerIdx=(dealerIdx+1)%players.length;
  var myPlayer=null;
  active.forEach(function(p){p.hole=[deck.pop(),deck.pop()];if(p.isMe){myHole=p.hole;myPlayer=p;}});
  // ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹æ™‚ã®ãƒãƒƒãƒ—ã‚’ä¿å­˜
  players.forEach(function(p){ p.chipsBefore=p.chips; });
  var sb=nxt(dealerIdx),bb=nxt(sb);
  blind(players[sb],SB);blind(players[bb],BB);
  curBet=BB;lastRaise=BB;curIdx=nxt(bb);acts=[players[bb].idx];
  renderAll();
  // è‡ªåˆ†ã®æ‰‹æœ­ã‚’ãƒ‡ã‚£ãƒ¼ãƒ«æ¼”å‡ºã§è¡¨ç¤ºã—ã¦ã‹ã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹
  if(myPlayer && myHole.length===2){
    showDealOverlay(myHole, function(){ scheduleOfflineAction(); });
  } else {
    scheduleOfflineAction();
  }
}

function scheduleOfflineAction(){
  var p=players[curIdx];
  if(!p||!p.active||p.folded||p.allIn){advanceOffline();return;}
  if(p.isCpu){
    hideCpuBar();
    showCpuThinking(p,function(){
      var dec=cpuDecide(p,{difficulty:cpuDifficulty,community:comm,pot:pot,curBet:curBet,phase:phase,BB:BB});
      applyCpuAction(p,dec);
      renderAll();
      showActionBubble(curIdx, dec.action, dec.amount||0);
      setTimeout(function(){ advanceOffline(); }, 600);
    });
  } else {
    hideCpuBar();
    hideInfo();
    document.getElementById('ap').style.display='block';
    renderActionOffline();
  }
}

function applyCpuAction(p,dec){
  if(dec.action==='fold'){p.folded=true;}
  else if(dec.action==='check'){}
  else if(dec.action==='call'){
    var tc=snap5(Math.min(curBet-p.bet,p.chips));
    if(tc<5){p.folded=true;} // 5æœªæº€ã‚³ãƒ¼ãƒ«ä¸å¯â†’ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰
    else{p.chips-=tc;p.bet+=tc;p.totalBet+=tc;pot+=tc;if(p.chips<5)p.allIn=true;}
  }
  else if(dec.action==='raise'){
    var nb=snap5(Math.min(Math.max(dec.amount,curBet+5),p.chips+p.bet));
    if(nb-p.bet<5){p.folded=true;}
    else{lastRaise=Math.max(nb-curBet,lastRaise);curBet=nb;var cost=nb-p.bet;p.chips-=cost;p.bet=nb;p.totalBet+=cost;pot+=cost;if(p.chips<=0){p.chips=0;p.allIn=true;}acts=[curIdx];}
  }
  if(acts.indexOf(curIdx)<0)acts.push(curIdx);
}

function advanceOffline(){
  var nf=players.filter(function(p){return p.active&&!p.folded;});
  if(nf.length===1){nf[0].chips+=pot;renderAll();showMsg('ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†','<span class="wn">'+nf[0].name+'</span>ã®å‹åˆ©ï¼ï¼ˆå…¨å“¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ï¼‰','æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){checkEliminated(function(){startRoundOffline();});});return;}
  var ca=players.filter(function(p){return p.active&&!p.folded&&!p.allIn;});
  var allActed2=ca.every(function(p){return acts.indexOf(p.idx)>=0;});
  var allBetsEqual2=ca.every(function(p){return p.bet>=curBet;});
  if(ca.length===0||(allActed2&&allBetsEqual2)){nextPhaseOffline();return;}
  curIdx=nxt(curIdx);renderAll();scheduleOfflineAction();
}

function nextPhaseOffline(){
  players.forEach(function(p){p.bet=0;});curBet=0;lastRaise=BB;acts=[];phase++;
  var newCards=[];
  if(phase===1){var c1=deck.pop(),c2=deck.pop(),c3=deck.pop();comm.push(c1,c2,c3);newCards=[c1,c2,c3];}
  else if(phase===2){var c=deck.pop();comm.push(c);newCards=[c];}
  else if(phase===3){var c=deck.pop();comm.push(c);newCards=[c];}
  else if(phase>=4){doShowdownOffline();return;}
  curIdx=nxt(dealerIdx);
  renderAll();
  showPhaseOverlay(PNAMES[phase]||'', newCards, function(){scheduleOfflineAction();});
}

function doShowdownOffline(){
  var cont=players.filter(function(p){return p.active&&!p.folded;});
  cont.forEach(function(p){p.best=evalHand(p.hole.concat(comm));});
  cont.sort(function(a,b){return cmpSc(b.best.score,a.best.score);});
  // calcSidePotsã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§åˆ†é…ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã¨çµ±ä¸€ï¼‰
  var pots2=calcSidePots(cont);
  var actualWins=[];
  pots2.forEach(function(sidePot){
    if(!sidePot.eligible||sidePot.eligible.length===0) return;
    var ranked2=sidePot.eligible.slice().sort(function(a,b){return cmpSc(b.best.score,a.best.score);});
    var topSc2=ranked2[0].best.score;
    var sideWins2=ranked2.filter(function(p){return cmpSc(p.best.score,topSc2)===0;});
    var share2=Math.floor(sidePot.amount/sideWins2.length);
    var rem2=sidePot.amount-(share2*sideWins2.length);
    sideWins2.forEach(function(w){w.chips+=share2;if(actualWins.indexOf(w)<0)actualWins.push(w);});
    if(rem2>0) sideWins2[0].chips+=rem2;
  });
  if(actualWins.length===0 && cont.length>0){
    var topSc0=cont[0].best.score;
    var fb=cont.filter(function(p){return cmpSc(p.best.score,topSc0)===0;});
    var fs=Math.floor(pot/fb.length);var fr=pot-(fs*fb.length);
    fb.forEach(function(w){w.chips+=fs;actualWins.push(w);});
    if(fr>0) fb[0].chips+=fr;
  }
  var wins=actualWins.length?actualWins:cont.slice(0,1);
  // ãƒãƒƒãƒ—å¢—æ¸›ã‚’è¨ˆç®—ï¼ˆã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³å‰ã®chipsBeforeã¨ç¾åœ¨ã®chipsã®å·®ï¼‰
  var allActive=players.filter(function(p){return p.active;});
  var ch='<div style="width:100%;">';
  allActive.forEach(function(p){
    var inCont=cont.indexOf(p)>=0;
    var isW=wins.indexOf(p)>=0;
    var gained=p.chips-p.chipsBefore; // chipsBefore ã¯ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³å‰ã«ä¿å­˜
    var gainStr=gained>=0?'<span style="color:#7f7;">+'+gained+'</span>':'<span style="color:#f77;">'+gained+'</span>';
    var isElim2=!isW&&(p.eliminated||(p.chips<BB&&p.chips>=0));
    var bg=isW?'rgba(201,168,76,.18)':inCont?'rgba(0,0,0,.35)':'rgba(80,0,0,.25)';
    var border=isW?'rgba(201,168,76,.6)':inCont?'rgba(255,255,255,.12)':'rgba(200,0,0,.3)';
    ch+='<div style="margin-bottom:6px;padding:5px 8px;border-radius:8px;background:'+bg+';border:1px solid '+border+';display:flex;align-items:center;gap:6px;">';
    ch+='<div style="flex:1;min-width:0;">';
    var detailTxt2=inCont?handDetail(p.best.score):'';
    var statusTxt2=isElim2?'ğŸ’€ ELIMINATED':inCont?HN[p.best.score.rank]:'FOLD';
    var prefix2=isW?'ğŸ† ':isElim2?'':inCont?'':'âŒ ';
    ch+='<div style="font-family:Cinzel,serif;font-size:11px;color:'+(isW?'var(--gold-light)':inCont?'rgba(255,255,255,.8)':'rgba(255,100,100,.7)')+';">'+prefix2+p.name+'</div>';
    ch+='<div style="font-size:9px;color:'+(isW?'#afc':'rgba(255,255,255,.45)')+';">'+statusTxt2+(detailTxt2?' ï¼ '+detailTxt2:'')+'</div>';
    ch+='<div style="font-size:9px;color:rgba(255,255,255,.4);">'+gainStr+' (æ®‹'+p.chips+')</div>';
    ch+='</div>';
    if(inCont&&p.hole&&p.hole.length){
      ch+='<div style="display:flex;gap:2px;flex-shrink:0;">';
      p.hole.forEach(function(c){ch+=cH(c,true);});
      ch+='</div>';
    }
    ch+='</div>';
  });
  ch+='</div>';
  var bestLoser2=cont.find(function(p){return wins.indexOf(p)<0;});
  var reasonStr2=wins.length===1&&bestLoser2?winReason(wins[0],bestLoser2):'';
  var winDetail2=handDetail(wins[0].best.score);
  var bodyLines2=['<span class="wn">'+wins.map(function(w){return w.name;}).join(' & ')+'</span>ã®å‹åˆ©ï¼'];
  bodyLines2.push('<span class="hn">'+HN[wins[0].best.score.rank]+'</span>');
  bodyLines2.push('<span style="font-size:10px;color:rgba(255,220,100,.9);">'+winDetail2+'</span>');
  if(reasonStr2) bodyLines2.push('<span style="font-size:10px;color:rgba(180,255,180,.85);">â–¶ '+reasonStr2+'</span>');
  var body=bodyLines2.join('<br>');
  renderAll();showMsg('ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³',body,'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){checkEliminated(function(){startRoundOffline();});},ch,comm);
}

function renderActionOffline(){
  var p=players[myIdx];if(!p)return;
  document.getElementById('ap-who').textContent=p.name+' ã®ã‚¿ãƒ¼ãƒ³ï¼ˆã‚ãªãŸï¼‰';
  var toC=curBet-p.bet;
  document.getElementById('ap-info').innerHTML='<span style="opacity:.6">æ‰‹æŒã¡</span> '+p.chips+' &nbsp;<span style="opacity:.6">ã‚³ãƒ¼ãƒ«</span> '+Math.min(toC,p.chips);
  var h=myHole.length?myHole:p.hole;
  document.getElementById('hdisp').innerHTML=cH(h[0])+cH(h[1]);
  var minR=snap5(Math.min(curBet+lastRaise,p.chips+p.bet)),maxR=p.chips+p.bet;
  setupChipSelector(minR, maxR);
  var pr=document.getElementById('prow');pr.innerHTML='';
  [['1/3P',snap5(Math.round(pot/3))],['1/2P',snap5(Math.round(pot/2))],['POT',snap5(pot)],['2Ã—BB',snap5(BB*2)]].forEach(function(x){
    var b=document.createElement('button');b.className='pbtn';
    var v=Math.min(Math.max(x[1],minR),maxR);
    b.textContent=x[0]+'('+v+')';b.onclick=function(){setChipBet(v,minR,maxR);};
    pr.appendChild(b);
  });
  var br=document.getElementById('brow');br.innerHTML='';
  function ab(lbl,cls,fn){var b=document.createElement('button');b.className='ab '+cls;b.textContent=lbl;b.onclick=fn;br.appendChild(b);}
  ab('ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','ab-fold',function(){sendOffline('fold',0);});
  var minRaise2=curBet+lastRaise;
  var canRaise2=(p.chips+p.bet)>minRaise2 && p.chips>toC;
  if(toC<=0){
    ab('ãƒã‚§ãƒƒã‚¯','ab-check',function(){sendOffline('check',0);});
    if(canRaise2) ab('ãƒ¬ã‚¤ã‚º','ab-raise',function(){sendOffline('raise',snap5(+document.getElementById('rinp').value||0));});
    if(p.chips>0) ab('ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ ('+p.chips+')','ab-allin',function(){sendOffline('allin',0);});
  } else if(toC>=p.chips){
    ab('ã‚³ãƒ¼ãƒ«/ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³('+p.chips+')','ab-call',function(){sendOffline('allin',0);});
  } else {
    ab('ã‚³ãƒ¼ãƒ«('+toC+')','ab-call',function(){sendOffline('call',0);});
    if(canRaise2) ab('ãƒ¬ã‚¤ã‚º','ab-raise',function(){sendOffline('raise',snap5(+document.getElementById('rinp').value||0));});
    ab('ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ ('+p.chips+')','ab-allin',function(){sendOffline('allin',0);});
  }
}

function sendOffline(action,amount){
  document.getElementById('ap').style.display='none';
  var p=players[myIdx];
  if(action==='fold'){p.folded=true;}
  else if(action==='check'){}
  else if(action==='call'){var tc=Math.min(curBet-p.bet,p.chips);p.chips-=tc;p.bet+=tc;p.totalBet+=tc;pot+=tc;if(!p.chips)p.allIn=true;}
  else if(action==='raise'){var nb=Math.min(Math.max(amount,curBet+1),p.chips+p.bet);lastRaise=Math.max(nb-curBet,lastRaise);curBet=nb;var cost=nb-p.bet;p.chips-=cost;p.bet=nb;p.totalBet+=cost;pot+=cost;if(!p.chips)p.allIn=true;acts=[myIdx];}
  else if(action==='allin'){
    var allAmt3=p.chips; var nb3=p.bet+allAmt3; var raiseAmt3=nb3-curBet;
    if(nb3>curBet){
      var isFullRaise3=(raiseAmt3>=lastRaise);
      lastRaise=Math.max(raiseAmt3,lastRaise); curBet=nb3;
      if(isFullRaise3) acts=[myIdx];
    }
    pot+=allAmt3;p.bet=nb3;p.totalBet+=allAmt3;p.chips=0;p.allIn=true;
  }
  if(acts.indexOf(myIdx)<0)acts.push(myIdx);
  renderAll();
  showActionBubble(myIdx, action, amount);
  advanceOffline();
}

// myIdã‚’sessionStorageã§ç®¡ç†ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚åŒã˜ã‚¿ãƒ–å†…ã§ã¯åŒã˜IDï¼‰
var myId = sessionStorage.getItem('poker_myId');
if(!myId){ myId = Math.random().toString(36).substr(2,10); sessionStorage.setItem('poker_myId', myId); }
var myName='', myChips=1000, SB=10, BB=20;
var roomPath='', isHost=false, myIdx=-1;

function genCode(){var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789',s='';for(var i=0;i<6;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}

document.getElementById('btn-create').addEventListener('click', function(){
  if(document.getElementById('conn-badge').className.includes('b-err')){
    // æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—ã§ã‚‚è©¦ã¿ã‚‹ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    // alert('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');return;
  }
  myName = document.getElementById('my-name').value.trim()||'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
  myChips = +document.getElementById('my-chips').value||1000;
  SB = +document.getElementById('room-sb').value||10;
  BB = +document.getElementById('room-bb').value||20;
  var code = genCode();
  roomPath = 'rooms/'+code;
  isHost = true;
  var data = {code:code,SB:SB,BB:BB,status:'waiting',hostId:myId,createdAt:Date.now(),cpuCount:onlineCpuCount,cpuDifficulty:onlineCpuDifficulty,players:{}};
  data.players[myId] = {id:myId,name:myName,chips:myChips,seat:0};
  fbSet(roomPath, data, function(){
    document.getElementById('room-created').style.display='block';
    document.getElementById('code-disp').textContent = code;
    // æ‹›å¾…URLç”Ÿæˆ
    var baseUrl = window.location.href.split('?')[0].split('#')[0];
    var inviteUrl = baseUrl + '?join=' + code;
    var urlDisp = document.getElementById('invite-url-disp');
    urlDisp.textContent = inviteUrl;
    document.getElementById('invite-url-wrap').style.display='block';
    // ãƒ›ã‚¹ãƒˆè¨­å®šãƒ‘ãƒãƒ«è¡¨ç¤º
    document.getElementById('host-settings').style.display='block';
    document.getElementById('btn-start').style.display='block';
    document.getElementById('btn-ready').style.display='none';
    watchLobby();
    initHostSettings();
  });
});

document.getElementById('code-disp').addEventListener('click', function(){
  try{navigator.clipboard.writeText(this.textContent);}catch(e){}
  var el=this; el.style.color='#0f0'; setTimeout(function(){el.style.color='';},800);
});
document.getElementById('invite-url-disp').addEventListener('click', function(){
  var url=this.textContent;
  var hint=document.getElementById('invite-copy-hint');
  if(navigator.share){
    navigator.share({title:'ãƒãƒ¼ã‚«ãƒ¼ã«æ‹›å¾…',text:'ä¸€ç·’ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’ã—ã‚ˆã†ï¼',url:url}).catch(function(){});
  } else {
    try{navigator.clipboard.writeText(url);}catch(e){
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      var ta=document.createElement('textarea');
      ta.value=url; ta.style.position='fixed'; ta.style.opacity='0';
      document.body.appendChild(ta); ta.select();
      try{document.execCommand('copy');}catch(e2){}
      document.body.removeChild(ta);
    }
    var el=this;
    el.style.borderColor='rgba(100,255,100,.6)';
    el.style.color='#7f7';
    hint.textContent='âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
    hint.style.color='rgba(100,255,100,.8)';
    setTimeout(function(){
      el.style.borderColor='';el.style.color='';
      hint.textContent='ã‚¿ãƒƒãƒ—ã§URLã‚’ã‚³ãƒ”ãƒ¼';hint.style.color='';
    },1500);
  }
});

function watchLobby(){
  fbListen(roomPath, function(room){
    if(!room) return;
    var ps = room.players||{};
    // CPUè¨­å®šã‚’roomè¨­å®šã¨åŒæœŸï¼ˆãƒ›ã‚¹ãƒˆãŒå¤‰æ›´ã—ãŸå ´åˆï¼‰
    if(room.cpuCount!==undefined) onlineCpuCount=room.cpuCount;
    if(room.cpuDifficulty) onlineCpuDifficulty=room.cpuDifficulty;
    renderPlistWithCpu(ps, room.cpuCount||0, room.cpuDifficulty||'normal', room.ready||{});
    var n = Object.keys(ps).length + (room.cpuCount||0);
    var names = Object.values(ps).map(function(p){return p.name.trim().toLowerCase();});
    var hasDup = names.some(function(name,i){return names.indexOf(name)!==i;});
    var rmsg = document.getElementById('room-msg');
    if(isHost){
      var btn = document.getElementById('btn-start');
      // å…¨ã¦ã®äººé–“å‚åŠ è€…ãŒæº–å‚™å®Œäº†ã‹ãƒã‚§ãƒƒã‚¯
      var humanIds = Object.keys(ps).filter(function(id){return id!==myId;});
      var allReady = humanIds.every(function(id){return room.ready&&room.ready[id];});
      if(hasDup){
        btn.disabled=true; btn.textContent='åå‰ãŒé‡è¤‡ã—ã¦ã„ã¾ã™';
        rmsg.textContent='âš  é‡è¤‡ã™ã‚‹åå‰ãŒã‚ã‚Šã¾ã™'; rmsg.style.color='#f88';
      } else if(n<2){
        btn.disabled=true; btn.textContent='å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...'; rmsg.style.color='';
        rmsg.textContent=Object.keys(ps).length+'äººå‚åŠ ä¸­';
      } else if(!allReady && humanIds.length>0){
        btn.disabled=true;
        btn.textContent='æº–å‚™å¾…ã¡ ('+(humanIds.filter(function(id){return room.ready&&room.ready[id];}).length)+'/'+humanIds.length+')';
        rmsg.textContent='å…¨å“¡ã®æº–å‚™å®Œäº†ã‚’å¾…ã£ã¦ã„ã¾ã™...'; rmsg.style.color='rgba(255,200,0,1)';
      } else {
        btn.disabled=false;
        btn.textContent='ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆ'+n+'äººï¼‰'; rmsg.style.color='';
        rmsg.textContent=Object.keys(ps).length+'äººå‚åŠ ä¸­'+(room.cpuCount>0?' + CPUÃ—'+room.cpuCount:'');
      }
    } else {
      // éãƒ›ã‚¹ãƒˆ: æº–å‚™å®Œäº†ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
      var readyBtn=document.getElementById('btn-ready');
      var myReady=room.ready&&room.ready[myId];
      if(myReady){
        readyBtn.textContent='âœ“ æº–å‚™å®Œäº†';
        readyBtn.style.background='rgba(201,168,76,.6)';readyBtn.style.borderColor='rgba(201,168,76,.9)';
        readyBtn.disabled=true;
      } else {
        readyBtn.textContent='æº–å‚™å®Œäº†';
        readyBtn.style.background='rgba(201,168,76,.25)';readyBtn.style.borderColor='rgba(201,168,76,.5)';
        readyBtn.disabled=false;
      }
      rmsg.textContent=Object.keys(ps).length+'äººå‚åŠ ä¸­'+(room.cpuCount>0?' + CPUÃ—'+room.cpuCount:'');
      rmsg.style.color='';
    }
    if(room.status==='started' && !isHost) launchGame(room);
  });
}

function renderPlistWithCpu(ps, cpuCnt, cpuDiff, readyMap){
  var el=document.getElementById('plist'); el.innerHTML='';
  var arr=Object.values(ps).sort(function(a,b){return a.seat-b.seat;});
  var names=arr.map(function(p){return p.name.trim().toLowerCase();});
  // äººé–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
  arr.forEach(function(p){
    var isDup=names.filter(function(n){return n===p.name.trim().toLowerCase();}).length>1;
    var isMe=p.id===myId;
    var isReady=readyMap&&readyMap[p.id];
    var isH=p.seat===0;
    var readyBadge=isH?'<div class="htag">HOST</div>':(isReady?'<div class="htag" style="background:rgba(0,150,0,.5);border-color:rgba(0,255,0,.3);color:#8f8;">READY</div>':'<div class="htag" style="background:rgba(80,80,0,.4);border-color:rgba(255,200,0,.3);color:#fa8;">WAIT</div>');
    var dupWarn=isDup?'<span style="color:#f88;font-size:9px;margin-left:4px;">âš é‡è¤‡</span>':'';
    el.innerHTML+='<div class="pitem"><div class="dot" style="background:'+(isDup?'#f88':isReady?'#8f8':'')+'"></div>'
      +'<span style="color:'+(isDup?'#f88':'')+'">'+p.name+(isMe?' (ã‚ãªãŸ)':'')+'</span>'+dupWarn+readyBadge+'</div>';
  });
  // CPUãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º
  var safeCpuCnt=Math.min(parseInt(cpuCnt)||0, CPU_NAMES.length);
  for(var ci=0;ci<safeCpuCnt;ci++){
    el.innerHTML+='<div class="pitem"><div class="dot" style="background:rgba(100,150,255,.7)"></div>'
      +'<span style="color:rgba(150,180,255,.8)">'+CPU_NAMES[ci]+'</span>'
      +'<div class="htag" style="background:rgba(30,30,120,.5);border-color:rgba(100,150,255,.3);color:#8af;">CPUÂ·'+(cpuDiff||'normal').toUpperCase()+'</div></div>';
  }
}
// å¾Œæ–¹äº’æ›
function renderPlist(ps){ renderPlistWithCpu(ps, onlineCpuCount, onlineCpuDifficulty, {}); }

document.getElementById('btn-start').addEventListener('click', function(){
  if(!isHost) return;
  fbGet(roomPath+'/players', function(ps){
    var arr = Object.values(ps||{}).sort(function(a,b){return a.seat-b.seat;});
    // é‡è¤‡åãƒã‚§ãƒƒã‚¯ï¼ˆCPUã‚’é™¤ãï¼‰
    var names = arr.map(function(p){return p.name.trim().toLowerCase();});
    var hasDup = names.some(function(n,i){return names.indexOf(n)!==i;});
    if(hasDup){
      var rmsg=document.getElementById('room-msg');
      rmsg.textContent='âš  é‡è¤‡ã™ã‚‹åå‰ãŒã‚ã‚Šã¾ã™ã€‚è§£æ¶ˆã—ã¦ã‹ã‚‰ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚';
      rmsg.style.color='#f88';
      return;
    }
    var seats={};arr.forEach(function(p,i){seats[p.id]=i;});
    fbPatch(roomPath, {status:'started', seats:seats}, function(){ launchGame(null); });
  });
});

document.getElementById('btn-join').addEventListener('click', doJoin);
document.getElementById('join-code').addEventListener('keydown', function(e){if(e.key==='Enter')doJoin();});

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ?join=XXXXXX ã®è‡ªå‹•å‡¦ç†
(function(){
  var params=new URLSearchParams(window.location.search);
  var autoCode=params.get('join');
  if(autoCode){
    autoCode=autoCode.toUpperCase();
    // ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ
    document.getElementById('join-code').value=autoCode;
    // URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ï¼ˆå±¥æ­´ã‚’æ±šã•ãªã„ï¼‰
    if(window.history&&window.history.replaceState){
      window.history.replaceState({},'',window.location.pathname);
    }
    // btn-mode-online ã® onclick ã‚’å®Ÿè¡Œï¼ˆæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å«ã‚€æ­£è¦ãƒ•ãƒ­ãƒ¼ï¼‰
    // DOMContentLoadedå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ãŒå¿µã®ãŸã‚setTimeoutã§é…å»¶
    setTimeout(function(){
      document.getElementById('btn-mode-online').click();
    }, 100);
  }
})();
function setJM(msg,type){var el=document.getElementById('join-msg');el.textContent=msg;el.className='smsg s-'+type;}

function doJoin(){
  var code = document.getElementById('join-code').value.trim().toUpperCase();
  if(code.length<4){setJM('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
  myName = document.getElementById('my-name').value.trim()||'ã‚²ã‚¹ãƒˆ';
  myChips = +document.getElementById('my-chips').value||1000;
  setJM('æ¥ç¶šä¸­...','info');
  fbGet('rooms/'+code, function(room){
    if(!room){setJM('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰','err');return;}
    if(room.status==='started'){setJM('ã‚²ãƒ¼ãƒ ã¯ã™ã§ã«é–‹å§‹ã—ã¦ã„ã¾ã™','err');return;}
    // åå‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
    var existingNames = Object.values(room.players||{}).map(function(p){return p.name.trim().toLowerCase();});
    if(existingNames.indexOf(myName.trim().toLowerCase())>=0){
      setJM('ã€Œ'+myName+'ã€ã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚','err');return;
    }
    isHost=false; roomPath='rooms/'+code; SB=room.SB; BB=room.BB;
    var seat = Object.keys(room.players||{}).length;
    var patch={}; patch[myId]={id:myId,name:myName,chips:myChips,seat:seat};
    fbPatch(roomPath+'/players', patch, function(){
      setJM('âœ“ å‚åŠ ã—ã¾ã—ãŸï¼ãƒ›ã‚¹ãƒˆã®é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™','ok');
      // éãƒ›ã‚¹ãƒˆ: room-created ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
      document.getElementById('room-created').style.display='block';
      document.getElementById('host-settings').style.display='none';
      document.getElementById('btn-start').style.display='none';
      document.getElementById('btn-ready').style.display='block';
      document.getElementById('btn-ready').textContent='æº–å‚™å®Œäº†';
      document.getElementById('btn-ready').style.background='rgba(0,100,0,.4)';
      watchLobby();
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚²ãƒ¼ãƒ 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var players=[], deck=[], comm=[], pot=0, phase=0;
var curBet=0, lastRaise=20, acts=[];
var dealerIdx=0, curIdx=0, myHole=[], lastActTs=0;
var gamePath='', holePfx='';
var PNAMES=['PRE-FLOP','FLOP','TURN','RIVER','SHOWDOWN'];
var _allInRevealed=false; // ALL INæ™‚ã®ãƒ›ãƒ¼ãƒ«å…¬é–‹ãƒ•ãƒ©ã‚°
var _dealOverlayShown=false; // ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã®dealOverlayè¡¨ç¤ºæ¸ˆã¿ãƒ•ãƒ©ã‚°
var _roundId=''; // ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯IDï¼ˆactionã®å¤ã•åˆ¤å®šç”¨ï¼‰
var _lastWaitFor=null; // æœ€å¾Œã«å—ã‘å–ã£ãŸwaitForå€¤ï¼ˆdealOverlayå¾Œã®å†ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
var _commAnimating=false; // ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ãƒ•ãƒ©ã‚°ï¼ˆãƒ›ã‚¹ãƒˆãƒ»éãƒ›ã‚¹ãƒˆå…±é€šï¼‰
var _cpuQueue=[]; // CPUã‚¿ãƒ¼ãƒ³ã‚­ãƒ¥ãƒ¼
var _cpuBusy=false; // CPUå‡¦ç†ä¸­ãƒ•ãƒ©ã‚°

function launchGame(room){
  fbOff(roomPath);
  if(isHost){
    fbGet(roomPath, function(r){ _launch(r); });
  } else {
    _launch(room);
  }
}

function _launch(room){
  _dbg('_launch isHost='+isHost+' myId='+myId.substring(0,6));
  if(!room) return;
  SB=room.SB; BB=room.BB;
  var seats=room.seats||{};
  var arr=Object.values(room.players||{}).sort(function(a,b){return(seats[a.id]||0)-(seats[b.id]||0);});
  players=arr.map(function(p,i){
    if(p.id===myId) myIdx=i;
    return{name:p.name,chips:p.chips,pid:p.id,isMe:p.id===myId,idx:i,isCpu:false,
           hole:[],bet:0,totalBet:0,folded:false,allIn:false,active:true,rebuyCount:0};
  });
  // CPUãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ï¼ˆãƒ›ã‚¹ãƒˆã®è¨­å®šã«å¾“ã†ï¼‰
  var cpuCnt=room.cpuCount||0;
  cpuDifficulty=room.cpuDifficulty||'normal';
  for(var ci=0;ci<cpuCnt;ci++){
    var idx=players.length;
    players.push({name:CPU_NAMES[ci],chips:arr[0]?arr[0].chips:500,pid:'cpu'+ci,isMe:false,idx:idx,isCpu:true,
                  hole:[],bet:0,totalBet:0,folded:false,allIn:false,active:true,rebuyCount:0});
  }
  _dbg('myIdx='+myIdx+' pl='+players.length+' myId='+myId.substring(0,6));
  gamePath = roomPath+'/game';
  holePfx  = roomPath+'/holes/';
  if(!_initialChips) _initialChips = arr[0]?arr[0].chips:500;
  showScreen('screen-game');
  document.getElementById('back-btn-wrap').style.display='none'; // ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ«æ™‚ã®ã¿è¡¨ç¤º
  // ãƒ›ã‚¹ãƒˆã¯stateã‚’è‡ªåˆ†ã§ç®¡ç†ã™ã‚‹ã®ã§Listenã—ãªã„
  // éãƒ›ã‚¹ãƒˆã®ã¿stateã‚’Listenã—ã¦ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’åŒæœŸã™ã‚‹
  if(!isHost){
    var _lpath=gamePath+'/state';
    _dbg('LISTEN: '+_lpath);
    fbListen(_lpath, onState);
  }
  fbListen(holePfx+myId, function(h){
    if(!h||h.length!==2) return;
    var isNew=(JSON.stringify(h)!==JSON.stringify(myHole));
    myHole=h;
    if(players[myIdx]) players[myIdx].hole=h;
    renderAll();
    _dbg('hole new='+isNew+' sh='+_dealOverlayShown);
    // æ–°ã—ã„ãƒ›ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ ã‹ã¤ éãƒ›ã‚¹ãƒˆ ã‹ã¤ ã¾ã ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã§overlayæœªè¡¨ç¤º
    if(isNew && !isHost && !_dealOverlayShown){
      _dealOverlayShown=true;
      showInfo('ã‚²ãƒ¼ãƒ é–‹å§‹ä¸­...');
      showDealOverlay(myHole, function(){
        hideInfo();
        // dealOverlayçµ‚äº†å¾Œ: è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ãªã‚‰å¿…ãšrenderActionï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°å•ã‚ãšï¼‰
        if(_lastWaitFor===myId){
          _dbg('dealOverlay cb: renderAction');
          renderAction();
        } else {
          _dbg('dealOverlay cb: wf='+_lastWaitFor+' not my turn');
        }
      });
    }
  });
  if(isHost){ startRound(); }
  else {
    showInfo('ãƒ›ã‚¹ãƒˆã®ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    // éãƒ›ã‚¹ãƒˆ: ãƒ›ã‚¹ãƒˆé›¢è„šç›£è¦–
    _watchHostPresence();
  }
}

var _hostWatchActive = false;
function _watchHostPresence(){
  if(_hostWatchActive) return;
  _hostWatchActive = true;
  _hostLeftDetected = false;
  // roomPath ã® status å¤‰åŒ–ã§ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦æ¤œå‡º
  fbListen(roomPath, function(room){
    if(!room) return;
    // ã‚²ãƒ¼ãƒ é–‹å§‹å¾Œã«status=lobbyã«å¤‰åŒ–ã—ãŸå ´åˆã®ã¿ãƒ›ã‚¹ãƒˆé›¢è„±
    if(room.status === 'lobby' && _stateEverReceived){
      _hostWatchActive = false;
      if(!_hostLeftDetected && gamePath){
        _hostLeftDetected = true;
        _showHostLeft();
      }
    }
  });
}

function _showHostLeft(){
  _dbg('HOST LEFT DETECTED');
  // æ—¢ã«ãƒ­ãƒ“ãƒ¼ã«ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if(!gamePath && !roomPath) return;
  // ibarã‚„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¯ãƒªã‚¢
  hideInfo();
  document.getElementById('ap').style.display='none';
  document.getElementById('mover').classList.remove('show');
  // ãƒ›ã‚¹ãƒˆé›¢è„±ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  var mover=document.getElementById('mover');
  var mtitle=document.getElementById('mtitle');
  var mbody=document.getElementById('mbody');
  var mcards=document.getElementById('mcards');
  var mcomm=document.getElementById('mcomm');
  var mnext=document.getElementById('mnext');
  mover.classList.add('show');
  mtitle.textContent='ğŸšª ãƒ›ã‚¹ãƒˆãŒé€€å‡ºã—ã¾ã—ãŸ';
  mbody.innerHTML='ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚<br>ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚';
  mcards.innerHTML='';
  mcomm.style.display='none';
  mnext.style.display='';
  mnext.textContent='ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚‹';
  mnext.onclick=function(){
    mover.classList.remove('show');
    window._pokerGoLobby();
  };
  // 3ç§’å¾Œã«è‡ªå‹•ã§ãƒ­ãƒ“ãƒ¼ã¸
  setTimeout(function(){
    if(mover.classList.contains('show')){
      mover.classList.remove('show');
      window._pokerGoLobby();
    }
  }, 3000);
}

var _lastPhase=-1, _lastCommLen=0;
var _hostLeftDetected = false;
var _stateEverReceived = false; // æœ‰åŠ¹ãªstateã‚’ä¸€åº¦ã§ã‚‚å—ã‘å–ã£ãŸã‹
var _nullStateCount = 0;        // é€£ç¶šnullå›æ•°
function _dbg(msg){
  var d=document.getElementById('_dbgbox');
  if(!d){d=document.createElement('div');d.id='_dbgbox';
    d.style.cssText='position:fixed;top:50px;right:4px;z-index:9999;background:rgba(0,0,0,.85);color:#0f0;font-size:7px;font-family:monospace;padding:4px 6px;border-radius:4px;max-width:220px;word-break:break-all;line-height:1.4;';
    document.body.appendChild(d);}
  // æœ€æ–°5è¡Œã‚’ä¿æŒ
  var lines=(d.textContent||'').split('\n').filter(Boolean);
  lines.push(msg);
  if(lines.length>12) lines=lines.slice(-12);
  d.textContent=lines.join('\n');
}
function onState(st){
  if(isHost) return;
  _dbg((st?'GOT wf='+st.waitFor+' pot='+st.pot:'NULL'));
  if(!st){
    // NULLã¯Firebaseæ›¸ãè¾¼ã¿ä¸­ã®pollingç«¶åˆã§ç™ºç”Ÿã™ã‚‹å ´åˆãŒã‚ã‚‹
    // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯nullã‚’ç„¡è¦–
    if(!_stateEverReceived) return;
    // ã‚²ãƒ¼ãƒ ä¸­ã®NULLã¯ä¸€æ™‚çš„ãªç«¶åˆãªã®ã§ç„¡è¦–ï¼ˆæœ€å¾Œã®æœ‰åŠ¹ãªstateã‚’ç¶­æŒï¼‰
    _nullStateCount++;
    _dbg('- NULL '+_nullStateCount);
    // é•·æ™‚é–“NULLãŒç¶šãå ´åˆã®ã¿ãƒ›ã‚¹ãƒˆé›¢è„±ã¨åˆ¤æ–­ï¼ˆ30å›â‰’45ç§’ï¼‰
    if(!_hostLeftDetected && gamePath && _nullStateCount >= 30){
      _hostLeftDetected = true;
      _showHostLeft();
    }
    return;
  }
  // æœ‰åŠ¹ãªstateã‚’å—ã‘å–ã£ãŸã®ã§ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆã€nullã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
  _stateEverReceived = true;
  _nullStateCount = 0;
  // éãƒ›ã‚¹ãƒˆ: ãƒ›ã‚¹ãƒˆã®roundIdã‚’åŒæœŸï¼ˆsend()ã§actionã«ridã‚’ä»˜ã‘ã‚‹ãŸã‚ï¼‰
  if(!isHost && st.rid && st.rid!==_roundId){
    _roundId=st.rid;
    _dbg('rid='+_roundId.substring(0,4));
  }

  var prevPhase=_lastPhase, prevCommLen=_lastCommLen;
  comm=st.comm||[]; pot=st.pot||0; phase=st.phase||0;
  curIdx=st.curIdx||0; curBet=st.curBet||0;
  dealerIdx=st.dealerIdx||0; lastRaise=st.lastRaise||BB;
  acts=st.acts||[];
  _lastPhase=phase; _lastCommLen=comm.length;
  if(st.players) st.players.forEach(function(sp,i){
    if(!players[i])return;
    players[i].chips=sp.chips;players[i].bet=sp.bet;players[i].totalBet=sp.totalBet;
    players[i].folded=sp.folded;players[i].allIn=sp.allIn;players[i].active=sp.active;
    if(sp.rebuyCount!==undefined) players[i].rebuyCount=sp.rebuyCount;
  });
  if(myHole.length===2&&players[myIdx]) players[myIdx].hole=myHole;
  if(st.reveal){
    Object.keys(st.reveal).forEach(function(i){if(players[i])players[i].hole=st.reveal[i];});
    // ALL INãƒ•ã‚§ãƒ¼ã‚ºã®revealãªã‚‰ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
    var hasAllIn=players.some(function(p){return p.active&&!p.folded&&p.allIn;});
    if(hasAllIn) _allInRevealed=true;
  }
  // waitFor ãŒè‡ªåˆ†ã®å ´åˆã¯renderAll()å‰ã«apã‚’è¡¨ç¤ºçŠ¶æ…‹ã«ã™ã‚‹
  // â†’ renderAll()ã®apVisibleåˆ¤å®šã§ã€Œã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã€ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
  var apEl = document.getElementById('ap');
  if(st.waitFor===myId){
    apEl.style.display='block';
  } else {
    apEl.style.display='none';
  }
  _dbg('GOT wf='+(st.waitFor||'null')+' pot='+st.pot);
  try{ renderAll(); } catch(e){ _dbg('ERR:'+String(e.message||e).substring(0,35)); }
  // éãƒ›ã‚¹ãƒˆ: ãƒ•ã‚§ãƒ¼ã‚ºå¤‰åŒ–æ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
  if(phase>prevPhase && prevPhase>=0 && phase<=3){
    var newCards=comm.slice(prevCommLen);
    showPhaseOverlay(PNAMES[phase]||'', newCards, function(){});
  }

  if(st.showdown){handleSD(st.showdown);return;}
  if(st.result){
    hideInfo();
    apEl.style.display='none';
    handleResult(st.result);
    return;
  }
  // éãƒ›ã‚¹ãƒˆå´: CPUã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµæœã‚’ãƒãƒ–ãƒ«è¡¨ç¤º
  if(!isHost && st.lastAction){
    var la=st.lastAction;
    showActionBubble(la.playerIdx, la.action, la.amount);
  }
  _lastWaitFor=st.waitFor;
  _dbg('match='+(st.waitFor===myId)+' wf='+st.waitFor+' me='+myId);
  if(st.waitFor===myId){
    hideInfo();
    renderAction();
  } else if(st.waitFor){
    var curP=players[curIdx];
    if(curP&&curP.isCpu){
      showInfo(curP.name+' ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    } else {
      showInfo((curP?curP.name:'?')+'ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    }
  } else {
    if(_stateEverReceived){ hideInfo(); }
  }
}

function watchAction(){
  // actionãƒ‘ã‚¹ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢ã—ã¦ã‹ã‚‰å†ç™»éŒ²ï¼ˆå¤ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼‰
  _dbg('wA'+_roundId.substring(0,4));
  fbOff(gamePath+'/action');
  // skipInitial=true: åˆå›ã®å³æ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç„¡è¦–
  fbListen(gamePath+'/action', function(d){
    if(!d||!d.ts) return;
    // ridãŒç©ºï¼ˆ_roundIdæœªè¨­å®šï¼‰ã¾ãŸã¯ridãŒç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¨ä¸ä¸€è‡´ã¯ã‚¹ã‚­ãƒƒãƒ—
    if(!_roundId || !d.rid || d.rid!==_roundId){
      _dbg('SKIP rid='+(d.rid||'none')+' cur='+((_roundId||'').substring(0,4)||'?'));
      return;
    }
    if(d.ts<=lastActTs){
      _dbg('SKIP old ts');
      return;
    }
    _dbg('ACTION ok rid='+d.rid.substring(0,4));
    lastActTs=d.ts; curIdx=d.playerIdx;
    applyAction(d); renderAll(); advance();
  }, true);
}

function pushState(extra){
  var st={
    players:players.map(function(p){return{chips:p.chips,bet:p.bet,totalBet:p.totalBet,folded:p.folded,allIn:p.allIn,active:p.active,rebuyCount:p.rebuyCount||0};}),
    comm:comm,pot:pot,phase:phase,curIdx:curIdx,curBet:curBet,
    dealerIdx:dealerIdx,lastRaise:lastRaise,acts:acts,
    showdown:null,result:null,reveal:null,waitFor:null,
    rid:_roundId
  };
  if(extra) Object.keys(extra).forEach(function(k){st[k]=extra[k];});
  var _wf=st.waitFor===null?'NULL':(st.waitFor||'undef');
  var _path=gamePath+'/state';
  window._pushCount=(window._pushCount||0)+1;
  // å‘¼ã³å‡ºã—å…ƒã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã®2è¡Œç›®ã‚’å–å¾—
  var _caller='?';
  try{var _e=new Error();var _lines=_e.stack.split('\n');_caller=(_lines[2]||'').trim().replace(/.*at /,'').substring(0,20);}catch(e){}
  _dbg('PUSH#'+window._pushCount+' wf='+_wf.substring(0,8)+' from:'+_caller);
  fbSet(_path, st, function(){
    _dbg('OK wf='+_wf);
  });
  // ãƒ›ã‚¹ãƒˆã¯è‡ªåˆ†ã§onStateã‚’å‘¼ã°ãªã„ãŒã€showdown/resultã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å‡¦ç†
  if(isHost){
    if(st.showdown) handleSD(st.showdown);
    else if(st.result) handleResult(st.result);
    else if(st.waitFor===myId){
      hideInfo();
      document.getElementById('ap').style.display='block';
      renderAction();
    }
  }
}

function startRound(){
  _dbg('startRound called');
  _cpuQueue=[];_cpuBusy=false;
  _allInRevealed=false;
  _dealOverlayShown=false; // æ–°ãƒ©ã‚¦ãƒ³ãƒ‰ã§dealOverlayã‚’å†åº¦è¡¨ç¤ºå¯èƒ½ã«
  _lastWaitFor=null; // æ–°ãƒ©ã‚¦ãƒ³ãƒ‰ã§waitForã‚’ãƒªã‚»ãƒƒãƒˆ
  _commAnimating=false;
  // ãƒ©ã‚¦ãƒ³ãƒ‰IDã‚’ç”Ÿæˆï¼ˆå¤ã„actionã‚’ç¢ºå®Ÿã«åŒºåˆ¥ã™ã‚‹ï¼‰
  _roundId = Math.random().toString(36).slice(2);
  lastActTs=Date.now();
  _dbg('roundId='+_roundId);
  // actionãƒ‘ã‚¹ã‚’nullã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰watchActionã‚’ç™»éŒ²
  fbOff(gamePath+'/action');
  fbSet(gamePath+'/action', null, function(){
    watchAction();
  });
  deck=shuffle(makeDeck());comm=[];pot=0;phase=0;curBet=0;lastRaise=BB;acts=[];
  // eliminatedãƒ•ãƒ©ã‚°æ¸ˆã¿ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
  // (checkEliminated â†’ startRound ã®é †ã§å‘¼ã°ã‚Œã‚‹ã®ã§
  //  ãƒªãƒã‚¤æ¸ˆã¿ã¯ eliminated=false ã§ active=true ã®ã¾ã¾)
  players.forEach(function(p){
    if(p.eliminated) p.active=false;
    p.hole=[];p.bet=0;p.totalBet=0;p.folded=false;p.allIn=false;
  });
  var active=players.filter(function(p){return p.active;});
  // CPUã®ã¿æ®‹ã£ãŸå ´åˆã¯ã‚²ãƒ¼ãƒ çµ‚äº†
  var humanActive=active.filter(function(p){return !p.isCpu;});
  if(humanActive.length===0){
    var cpuWinner=active[0];
    var elimBody='<span class="wn">'+(cpuWinner?cpuWinner.name:'?')+'</span>ã®å„ªå‹ï¼<br><small style="color:rgba(255,255,255,.5)">å…¨äººé–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè„±è½ã—ã¾ã—ãŸ</small>';
    pushState({result:{title:'ã‚²ãƒ¼ãƒ çµ‚äº†',body:elimBody,ch:'',gameOver:true}});
    return;
  }
  // CPUãŒè„±è½ã—ã¦ã„ã‚‹ï¼ˆãƒãƒƒãƒ—ä¸è¶³ï¼‰å ´åˆã¯æ—¢ã«active=falseã«ãªã£ã¦ã„ã‚‹ã®ã§OK
  // äººé–“ãŒè„±è½ã—ã¦CPUã®ã¿æ®‹ã‚‹å ´åˆã®è¿½åŠ ãƒã‚§ãƒƒã‚¯
  if(active.length<2){
    var w=active[0];
    var isWinnerHuman=w&&!w.isCpu;
    var winBody='<span class="wn">'+(w?w.name:'?')+'</span>ã®å„ªå‹ï¼<br><small style="color:rgba(255,255,255,.5)">ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå…¨å“¡è„±è½ã—ã¾ã—ãŸ</small>';
    pushState({result:{title:'ã‚²ãƒ¼ãƒ çµ‚äº†',body:winBody,ch:'',gameOver:true}});
    return;
  }
  dealerIdx=(dealerIdx+1)%players.length;
  while(!players[dealerIdx].active) dealerIdx=(dealerIdx+1)%players.length;
  active.forEach(function(p){
    var h=[deck.pop(),deck.pop()]; p.hole=h;
    if(!p.isCpu) fbSet(holePfx+p.pid, h);
    if(p.isMe) myHole=h;
  });
  // ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹æ™‚ã®ãƒãƒƒãƒ—ã‚’ä¿å­˜ï¼ˆã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³ã®å¢—æ¸›è¡¨ç¤ºç”¨ï¼‰
  players.forEach(function(p){ p.chipsBefore=p.chips; });
  var sb=nxt(dealerIdx), bb=nxt(sb);
  blind(players[sb],SB); blind(players[bb],BB);
  curBet=BB; lastRaise=BB; curIdx=nxt(bb); acts=[players[bb].idx];
  var firstWaitFor=players[curIdx]?players[curIdx].pid:null;
  var firstP=players[curIdx];

  // ã¾ãšpushStateã§éãƒ›ã‚¹ãƒˆã«çŠ¶æ…‹ã‚’ä¼é”ï¼ˆdealOverlayå‰ã«å®Ÿè¡Œï¼‰
  if(isHost && firstP && firstP.isCpu && !firstP.folded && !firstP.allIn){
    curIdx=firstP.idx;
    pushState({waitFor:firstWaitFor});
    // ãƒ›ã‚¹ãƒˆã®dealæ¼”å‡ºå¾Œã«CPUã‚¿ãƒ¼ãƒ³é–‹å§‹
    if(myHole.length===2){
      showDealOverlay(myHole, function(){ runCpuTurn(firstP.idx); });
    } else {
      runCpuTurn(firstP.idx);
    }
  } else {
    pushState({waitFor:firstWaitFor});
    // ãƒ›ã‚¹ãƒˆã®dealæ¼”å‡ºï¼ˆpushStateå¾Œãªã®ã§éãƒ›ã‚¹ãƒˆã¯æ—¢ã«stateå—ä¿¡å¯èƒ½ï¼‰
    if(myHole.length===2){
      showDealOverlay(myHole, function(){});
    }
  }
}

function blind(p,a){var x=Math.min(a,p.chips);p.chips-=x;p.bet+=x;p.totalBet+=x;pot+=x;if(!p.chips)p.allIn=true;}
function nxt(from){var i=(from+1)%players.length,t=0;while((!players[i].active||players[i].folded||players[i].allIn)&&t<players.length){i=(i+1)%players.length;t++;}return i;}

function applyAction(d){
  var p=players[d.playerIdx];if(!p)return;
  if(d.action==='fold'){
    p.folded=true;
  }
  else if(d.action==='check'){
    // ãƒã‚§ãƒƒã‚¯ï¼šä½•ã‚‚ã—ãªã„
  }
  else if(d.action==='call'){
    var tc=Math.min(curBet-p.bet, p.chips);
    p.chips-=tc; p.bet+=tc; p.totalBet+=tc; pot+=tc;
    if(p.chips<=0){ p.chips=0; p.allIn=true; }
  }
  else if(d.action==='raise'){
    var nb=Math.min(Math.max(d.amount, curBet+lastRaise), p.chips+p.bet);
    var raiseBy=nb-curBet;
    lastRaise=Math.max(raiseBy, BB);
    curBet=nb;
    var cost=nb-p.bet;
    p.chips-=cost; p.bet=nb; p.totalBet+=cost; pot+=cost;
    if(p.chips<=0){ p.chips=0; p.allIn=true; }
    acts=[d.playerIdx]; // ãƒ¬ã‚¤ã‚ºã¯å…¨å“¡å†ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  }
  else if(d.action==='allin'){
    var allInAmt=p.chips;
    var newBet=p.bet+allInAmt;
    var raiseAmt=newBet-curBet;
    if(newBet>curBet){
      // ãƒ•ãƒ«ãƒ¬ã‚¤ã‚ºï¼ˆlastRaiseä»¥ä¸Šã®å¢—é¡ï¼‰ã‹ã©ã†ã‹åˆ¤å®š
      var isFullRaise=(raiseAmt>=lastRaise);
      lastRaise=Math.max(raiseAmt, lastRaise);
      curBet=newBet;
      if(isFullRaise){
        acts=[d.playerIdx]; // ãƒ•ãƒ«ãƒ¬ã‚¤ã‚º â†’ å…¨å“¡å†ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      }
      // ãƒ•ãƒ«ãƒ¬ã‚¤ã‚ºæœªæº€ã®ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ã¯æ—¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¸ˆã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å†ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸è¦
      // acts ã¯ãã®ã¾ã¾ï¼ˆã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã®ã¿ï¼‰
    }
    pot+=allInAmt; p.bet=newBet; p.totalBet+=allInAmt; p.chips=0; p.allIn=true;
  }
  if(acts.indexOf(d.playerIdx)<0) acts.push(d.playerIdx);
  renderAll();
  showActionBubble(d.playerIdx, d.action, d.amount||0);
}

// CPUã‚¿ãƒ¼ãƒ³ã‚­ãƒ¥ãƒ¼: [{idx}] ã‚’é †æ¬¡å‡¦ç†
var _cpuQueue=[];
var _cpuBusy=false;

function enqueueCpu(idx){
  // åŒã˜idxãŒæ—¢ã«ã‚­ãƒ¥ãƒ¼ã«ã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼ˆäºŒé‡ç™»éŒ²é˜²æ­¢ï¼‰
  if(_cpuBusy && _cpuQueue.indexOf(idx)>=0) return;
  _cpuQueue.push(idx);
  if(!_cpuBusy) processCpuQueue();
}

function processCpuQueue(){
  if(_cpuQueue.length===0){ _cpuBusy=false; return; }
  _cpuBusy=true;
  var cpuIdx=_cpuQueue.shift();
  curIdx=cpuIdx;
  var p=players[cpuIdx];
  if(!p||!p.isCpu||p.folded||p.allIn){
    _cpuBusy=false;
    advance();
    return;
  }
  showInfo(p.name+' ãŒè€ƒãˆã¦ã„ã¾ã™...');
  renderAll();
  setTimeout(function(){
    var p2=players[cpuIdx];
    if(!p2||p2.folded||p2.allIn){
      hideInfo();
      _cpuBusy=false;
      setTimeout(function(){advance();},0);
      return;
    }
    var dec;
    try{
      dec=cpuDecide(p2,{difficulty:cpuDifficulty,community:comm,pot:pot,curBet:curBet,phase:phase,BB:BB});
    }catch(e){ dec={action:'fold'}; }
    if(dec.action==='fold'){ p2.folded=true; }
    else if(dec.action==='check'){}
    else if(dec.action==='call'){
      var tc=Math.min(curBet-p2.bet,p2.chips);
      p2.chips-=tc;p2.bet+=tc;p2.totalBet+=tc;pot+=tc;
      if(p2.chips<=0){p2.chips=0;p2.allIn=true;}
    }
    else if(dec.action==='raise'){
      var nb=snap5(Math.min(Math.max(dec.amount,curBet+BB),p2.chips+p2.bet));
      var cost=nb-p2.bet;
      if(cost<1){p2.folded=true;}
      else{lastRaise=Math.max(nb-curBet,lastRaise);curBet=nb;p2.chips-=cost;p2.bet=nb;p2.totalBet+=cost;pot+=cost;if(p2.chips<=0){p2.chips=0;p2.allIn=true;}acts=[cpuIdx];}
    }
    else if(dec.action==='allin'){
      var allAmt=p2.chips;var nb2=p2.bet+allAmt;var raiseAmt2=nb2-curBet;
      if(nb2>curBet){
        var isFullRaise2=(raiseAmt2>=lastRaise);
        lastRaise=Math.max(raiseAmt2,lastRaise);curBet=nb2;
        if(isFullRaise2) acts=[cpuIdx];
      }
      pot+=allAmt;p2.bet=nb2;p2.totalBet+=allAmt;p2.chips=0;p2.allIn=true;
    }
    if(acts.indexOf(cpuIdx)<0) acts.push(cpuIdx);
    showActionBubble(cpuIdx,dec.action,dec.amount||0);
    renderAll();
    _cpuBusy=false;
    pushState({lastAction:{playerIdx:cpuIdx,action:dec.action,amount:dec.amount||0}});
    setTimeout(function(){advance();},50);
  }, 800+Math.floor(Math.random()*400));
}

function runCpuTurn(targetIdx){
  var cpuIdx=(targetIdx!==undefined)?targetIdx:curIdx;
  curIdx=cpuIdx;
  enqueueCpu(cpuIdx);
}

function advance(){
  var nf=players.filter(function(p){return p.active&&!p.folded;});
  if(nf.length===1){nf[0].chips+=pot;pushState({result:{title:'ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†',body:'<span class="wn">'+nf[0].name+'</span>ã®å‹åˆ©ï¼ï¼ˆå…¨å“¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ï¼‰',ch:''},waitFor:null});return;}
  var ca=players.filter(function(p){return p.active&&!p.folded&&!p.allIn;});
  var allActed=ca.every(function(p){return acts.indexOf(p.idx)>=0;});
  var allBetsEqual=ca.every(function(p){return p.bet>=curBet;});
  if(ca.length===0 || (allActed && allBetsEqual)){
    hideInfo();
    if(ca.length===0){
      rundownAllIn();
    } else {
      nextPhase();
    }
    return;
  }
  curIdx=nxt(curIdx);
  var curP=players[curIdx];
  // nxt()ãŒallInãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿”ã—ã¦ã—ã¾ã†å ´åˆã®å®‰å…¨ç­–
  if(!curP || curP.allIn || curP.folded){
    hideInfo();
    nextPhase(); return;
  }
  if(isHost && curP.isCpu){
    pushState({waitFor:curP.pid});
    runCpuTurn(curP.idx);
  } else {
    pushState({waitFor:curP.pid});
    if(curP.isMe){
      hideInfo();
    } else {
      // ãƒ›ã‚¹ãƒˆå´: éãƒ›ã‚¹ãƒˆäººé–“ã®ã‚¿ãƒ¼ãƒ³ â†’ å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      showInfo(curP.name + ' ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    }
  }
}


// â”€â”€ ALL IN æ‰‹æœ­å…¬é–‹æ¼”å‡º â”€â”€
function _showAllInReveal(revealMap, cb){
  var participants = players.filter(function(p){
    return p.active && !p.folded && revealMap[p.idx];
  });
  if(participants.length === 0){ cb(); return; }

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤DOMç”Ÿæˆ
  var ov = document.getElementById('allin-reveal-overlay');
  if(!ov){
    ov = document.createElement('div');
    ov.id = 'allin-reveal-overlay';
    ov.style.cssText = [
      'position:fixed;inset:0;z-index:1200',
      'background:rgba(0,0,0,.82)',
      'display:flex;flex-direction:column',
      'align-items:center;justify-content:center',
      'gap:18px;padding:24px 16px',
      'opacity:0;transition:opacity .3s'
    ].join(';');
    document.body.appendChild(ov);
  }

  // ã‚¿ã‚¤ãƒˆãƒ«
  ov.innerHTML = '<div style="font-family:Cinzel,serif;font-size:15px;letter-spacing:3px;color:var(--gold-light);text-shadow:0 0 12px rgba(201,168,76,.6);">ğŸƒ ALL IN â€” HOLE CARDS</div>';

  // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚«ãƒ¼ãƒ‰è¡Œï¼ˆæœ€åˆã¯è£å‘ãï¼‰
  var rows = [];
  participants.forEach(function(p){
    var row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:12px;width:100%;max-width:320px;background:rgba(255,255,255,.05);border:1px solid rgba(201,168,76,.2);border-radius:12px;padding:10px 14px;';
    // åå‰
    var nameEl = document.createElement('div');
    nameEl.style.cssText = 'font-family:Cinzel,serif;font-size:12px;color:rgba(255,255,255,.85);min-width:80px;flex:1;';
    nameEl.textContent = p.name + (p.isMe ? ' â­' : '');
    row.appendChild(nameEl);
    // ã‚«ãƒ¼ãƒ‰2æšï¼ˆè£å‘ãã§åˆæœŸåŒ–ï¼‰
    var cardEls = [];
    var hole = revealMap[p.idx];
    for(var ci=0; ci<2; ci++){
      var wrap = document.createElement('div');
      wrap.style.cssText = 'perspective:600px;';
      var inner = document.createElement('div');
      inner.style.cssText = [
        'width:44px;height:64px',
        'position:relative;transform-style:preserve-3d',
        'transition:transform .7s ease',
        'transform:rotateY(0deg)'
      ].join(';');
      // è£é¢
      var back = document.createElement('div');
      back.style.cssText = 'position:absolute;inset:0;backface-visibility:hidden;';
      back.innerHTML = cH(null, true);
      // è¡¨é¢
      var front = document.createElement('div');
      front.style.cssText = 'position:absolute;inset:0;backface-visibility:hidden;transform:rotateY(180deg);';
      front.innerHTML = cH(hole[ci], true);
      inner.appendChild(back);
      inner.appendChild(front);
      wrap.appendChild(inner);
      row.appendChild(wrap);
      cardEls.push(inner);
    }
    ov.appendChild(row);
    rows.push({p:p, cardEls:cardEls});
  });

  // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
  ov.style.opacity='0';
  ov.style.display='flex';
  setTimeout(function(){ ov.style.opacity='1'; }, 30);

  // ã‚«ãƒ¼ãƒ‰ã‚’é †ç•ªã«ãƒ•ãƒªãƒƒãƒ—ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«150msé–“éš”ã€ã‚«ãƒ¼ãƒ‰é–“200msï¼‰
  var totalDelay = 400; // åˆæœŸå¾…æ©Ÿ
  rows.forEach(function(r){
    r.cardEls.forEach(function(el, ci){
      (function(flipEl, delay){
        setTimeout(function(){ flipEl.style.transform='rotateY(180deg)'; }, delay);
      })(el, totalDelay + ci*320);
    });
    totalDelay += 320*2 + 300; // 2æšãƒ•ãƒªãƒƒãƒ—å¾Œ 300ms å¾…æ©Ÿ
  });

  // å…¨ãƒ•ãƒªãƒƒãƒ—å®Œäº†å¾Œã« 3.5ç§’ è¦‹ã›ã¦ã‹ã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
  var showDuration = totalDelay + 3500;
  setTimeout(function(){
    ov.style.opacity='0';
    setTimeout(function(){
      ov.style.display='none';
      ov.innerHTML='';
      cb();
    }, 350);
  }, showDuration);
}

// å…¨å“¡ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³æ™‚: ãƒ•ãƒ­ãƒƒãƒ—â†’ã‚¿ãƒ¼ãƒ³â†’ãƒªãƒãƒ¼ã‚’é †ç•ªã«æ¼”å‡ºä»˜ãã§å…¬é–‹ã—ã¦ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³
function rundownAllIn(){
  _dbg('rundownAllIn called');
  hideInfo();
  // ALL INå‚åŠ è€…ã®ãƒ›ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’å…¨å“¡ã«å…¬é–‹
  var revealMap={};
  players.forEach(function(p){
    if(p.active && !p.folded && p.hole && p.hole.length===2){
      revealMap[p.idx]=p.hole;
    }
  });
  if(gamePath){
    pushState({reveal:revealMap, waitFor:null});
  }
  _allInRevealed=true;
  Object.keys(revealMap).forEach(function(i){
    if(players[i]) players[i].hole=revealMap[i];
  });
  renderAll();

  // â”€â”€ æ‰‹æœ­å…¬é–‹æ¼”å‡º â”€â”€
  _showAllInReveal(revealMap, function(){
    // æ¼”å‡ºçµ‚äº†å¾Œã«ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã
    startRevealSteps();
  });

  function startRevealSteps(){
    revealStep(function(){
      renderAll();
      doShowdown();
    });
  }

  function revealStep(cb){
    if(comm.length>=5){ cb(); return; }
    // æ¬¡ã«å…¬é–‹ã™ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã‚’æ±ºå®š
    var stepPhase, stepCards=[];
    if(comm.length===0){
      // FLOP: 3æš
      stepPhase='FLOP';
      stepCards=[deck.pop(),deck.pop(),deck.pop()];
      comm.push(stepCards[0],stepCards[1],stepCards[2]);
      phase=1;
    } else if(comm.length===3){
      // TURN: 1æš
      stepPhase='TURN';
      stepCards=[deck.pop()];
      comm.push(stepCards[0]);
      phase=2;
    } else if(comm.length===4){
      // RIVER: 1æš
      stepPhase='RIVER';
      stepCards=[deck.pop()];
      comm.push(stepCards[0]);
      phase=3;
    } else {
      cb(); return;
    }
    renderAll();
    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®å ´åˆã¯éãƒ›ã‚¹ãƒˆã«ã‚‚åŒæœŸ
    if(gamePath) pushState({waitFor:null});
    showPhaseOverlay(stepPhase, stepCards, function(){
      // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸ï¼ˆå°‘ã—é–“ã‚’ç½®ãï¼‰
      setTimeout(function(){ revealStep(cb); }, 1500);
    });
  }
}

function nextPhase(){
  hideInfo(); // ãƒ•ã‚§ãƒ¼ã‚ºç§»è¡Œæ™‚ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
  players.forEach(function(p){p.bet=0;}); curBet=0; lastRaise=BB; acts=[]; phase++;
  var newCards=[];
  if(phase===1){var c1=deck.pop(),c2=deck.pop(),c3=deck.pop();comm.push(c1,c2,c3);newCards=[c1,c2,c3];}
  else if(phase===2){var c=deck.pop();comm.push(c);newCards=[c];}
  else if(phase===3){var c=deck.pop();comm.push(c);newCards=[c];}
  else if(phase>=4){ doShowdown(); return; }
  // ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã‚‹ã‹ç¢ºèª
  var ca=players.filter(function(p){return p.active&&!p.folded&&!p.allIn;});
  if(ca.length===0){
    // å…¨å“¡ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ â†’ æ®‹ã‚Šã‚’ä¸€æ°—ã«å…¬é–‹
    renderAll();
    showPhaseOverlay(PNAMES[phase]||'', newCards, function(){
      rundownAllIn();
    });
    return;
  }
  curIdx=nxt(dealerIdx);
  renderAll();
  showPhaseOverlay(PNAMES[phase]||'', newCards, function(){
    var firstP=players[curIdx];
    if(!firstP || firstP.allIn || firstP.folded){
      // å®‰å…¨ç­–: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¢ã™
      var nextAct=players.find(function(p){return p.active&&!p.folded&&!p.allIn;});
      if(!nextAct){rundownAllIn();return;}
      curIdx=nextAct.idx;
      firstP=nextAct;
    }
    if(isHost && firstP.isCpu){
      curIdx=firstP.idx;
      pushState({waitFor:firstP.pid});
      runCpuTurn(firstP.idx);
    } else {
      pushState({waitFor:firstP.pid});
    }
  });
}

function doShowdown(){
  var cont=players.filter(function(p){return p.active&&!p.folded;});
  var holes={};
  // CPUã¯ç›´æ¥holeã‚’ä½¿ç”¨ã€äººé–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯Firebaseã‹ã‚‰å–å¾—
  var humanCont=cont.filter(function(p){return !p.isCpu;});
  cont.forEach(function(p){if(p.isCpu&&p.hole)holes[p.idx]=p.hole;});
  if(humanCont.length===0){finishSD(cont,holes);return;}
  var pending=humanCont.length;
  humanCont.forEach(function(p){
    fbGet(holePfx+p.pid, function(h){
      if(h) holes[p.idx]=h;
      if(--pending===0) finishSD(cont,holes);
    });
  });
}
function calcSidePots(contPlayers){
  // contPlayers: ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã—ã¦ã„ãªã„ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³å‚åŠ è€…ï¼ˆbestè¨­å®šæ¸ˆã¿ï¼‰
  // allContrib: å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰å«ã‚€ã€totalBet>0ï¼‰
  var allContrib=players.filter(function(p){return p.totalBet>0;});
  var nonFolded=contPlayers||players.filter(function(p){return p.active&&!p.folded;});
  // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªtotalBetå€¤ã‚’æ˜‡é †ã§å–å¾—ï¼ˆå…¨æ‹ å‡ºè€…ã‹ã‚‰ï¼‰
  var caps=[];
  allContrib.forEach(function(p){if(caps.indexOf(p.totalBet)<0)caps.push(p.totalBet);});
  caps.sort(function(a,b){return a-b;});
  var pots=[];
  var prevCap=0;
  caps.forEach(function(cap){
    var potAmt=0;
    allContrib.forEach(function(p){
      potAmt+=Math.min(p.totalBet,cap)-Math.min(p.totalBet,prevCap);
    });
    // eligibleã¯contPlayersã®ä¸­ã§ã“ã®ãƒ¬ãƒ™ãƒ«ä»¥ä¸Šè³­ã‘ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    var eligible=nonFolded.filter(function(p){return p.totalBet>=cap;});
    if(potAmt>0 && eligible.length>0) pots.push({amount:potAmt, eligible:eligible});
    prevCap=cap;
  });
  // åˆè¨ˆè£œæ­£
  var potsTotal=pots.reduce(function(s,p){return s+p.amount;},0);
  if(potsTotal<pot && pots.length>0){
    pots[pots.length-1].amount+=pot-potsTotal;
  }
  return pots;
}

function finishSD(cont,holes){
  cont.forEach(function(p){if(holes[p.idx])p.hole=holes[p.idx];p.best=evalHand(p.hole.concat(comm));});
  cont.sort(function(a,b){return cmpSc(b.best.score,a.best.score);});
  // ã‚µã‚¤ãƒ‰ãƒãƒƒãƒˆè¨ˆç®—
  // cont ã‚’æ¸¡ã™ã“ã¨ã§ eligible ãŒç¢ºå®Ÿã« best è¨­å®šæ¸ˆã¿ã®åŒä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã™ã‚‹
  var pots=calcSidePots(cont);
  var allWinners=[];
  // åˆ†é…å‰ã«å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®chipsã‚’ç¢ºèªï¼ˆäºŒé‡åŠ ç®—é˜²æ­¢ï¼‰
  var chipsAdded={};
  players.forEach(function(p){chipsAdded[p.idx]=0;});
  pots.forEach(function(sidePot){
    if(!sidePot.eligible||sidePot.eligible.length===0) return;
    // eligible ã®ä¸­ã§bestã‚’æŒã¤ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç‰¹å®š
    var ranked=sidePot.eligible.slice().sort(function(a,b){return cmpSc(b.best.score,a.best.score);});
    var topSc=ranked[0].best.score;
    var winners=ranked.filter(function(p){return cmpSc(p.best.score,topSc)===0;});
    // ã“ã®ãƒãƒƒãƒˆã‚’ winners ã§å±±åˆ†ã‘
    var share=Math.floor(sidePot.amount/winners.length);
    var remainder=sidePot.amount-(share*winners.length);
    winners.forEach(function(w){
      w.chips+=share;
      chipsAdded[w.idx]+=share;
      if(allWinners.indexOf(w)<0) allWinners.push(w);
    });
    if(remainder>0){
      winners[0].chips+=remainder;
      chipsAdded[winners[0].idx]+=remainder;
    }
  });
  if(allWinners.length===0 && cont.length>0){
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: potsãŒç©ºã®å ´åˆã¯potå…¨é¡ã‚’æœ€å¼·ãƒãƒ³ãƒ‰ã¸
    var topSc2=cont[0].best.score;
    var fallbackWinners=cont.filter(function(p){return cmpSc(p.best.score,topSc2)===0;});
    var fShare=Math.floor(pot/fallbackWinners.length);
    var fRem=pot-(fShare*fallbackWinners.length);
    fallbackWinners.forEach(function(w){w.chips+=fShare;allWinners.push(w);});
    if(fRem>0) fallbackWinners[0].chips+=fRem;
  }
  var wins=allWinners;
  // åŒå½¹ã®å ´åˆã®å‹å› ã‚’ç‰¹å®šï¼ˆå‹è€… vs æœ€å¼·ã®æ•—è€…ï¼‰
  var bestLoser=cont.find(function(p){return wins.indexOf(p)<0;});
  var reasonStr=wins.length===1&&bestLoser?winReason(wins[0],bestLoser):'';
  // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰å«ã‚€ï¼‰è¡¨ç¤º
  var allActiveOnline=players.filter(function(p){return p.active;});
  var ch='<div style="width:100%;">';
  allActiveOnline.forEach(function(p){
    var inCont=cont.indexOf(p)>=0;
    var isW=wins.indexOf(p)>=0;
    var gained=p.chips-p.chipsBefore;
    var gainStr=gained>=0?'<span style="color:#7f7;">+'+gained+'</span>':'<span style="color:#f77;">'+gained+'</span>';
    var bg=isW?'rgba(201,168,76,.18)':inCont?'rgba(0,0,0,.35)':'rgba(80,0,0,.25)';
    var border=isW?'rgba(201,168,76,.6)':inCont?'rgba(255,255,255,.12)':'rgba(200,0,0,.3)';
    ch+='<div style="margin-bottom:6px;padding:5px 8px;border-radius:8px;background:'+bg+';border:1px solid '+border+';display:flex;align-items:center;gap:6px;">';
    ch+='<div style="flex:1;min-width:0;">';
    var isElim=!isW&&(p.eliminated||(!p.active&&!inCont)||(p.chips<BB&&p.chips>=0&&!p.eliminated));
    var detailTxt=inCont?handDetail(p.best.score):'';
    var statusTxt=isElim?'ğŸ’€ ELIMINATED':inCont?HN[p.best.score.rank]:'FOLD';
    var prefix=isW?'ğŸ† ':isElim?'':inCont?'':'âŒ ';
    ch+='<div style="font-family:Cinzel,serif;font-size:11px;color:'+(isW?'var(--gold-light)':inCont?'rgba(255,255,255,.8)':'rgba(255,100,100,.7)')+';">'+prefix+p.name+'</div>';
    ch+='<div style="font-size:9px;color:'+(isW?'#afc':'rgba(255,255,255,.45)')+';">'+statusTxt+(detailTxt?' ï¼ '+detailTxt:'')+'</div>';
    ch+='<div style="font-size:9px;color:rgba(255,255,255,.4);">'+gainStr+' (æ®‹'+p.chips+')</div>';
    ch+='</div>';
    if(inCont&&p.hole&&p.hole.length){
      ch+='<div style="display:flex;gap:2px;flex-shrink:0;">';
      p.hole.forEach(function(c){ch+=cH(c,true);});
      ch+='</div>';
    }
    ch+='</div>';
  });
  ch+='</div>';
  var winDetail=handDetail(wins[0].best.score);
  var bodyLines=['<span class="wn">'+wins.map(function(w){return w.name;}).join(' & ')+'</span>ã®å‹åˆ©ï¼'];
  bodyLines.push('<span class="hn">'+HN[wins[0].best.score.rank]+'</span>');
  bodyLines.push('<span style="font-size:10px;color:rgba(255,220,100,.9);">'+winDetail+'</span>');
  if(reasonStr) bodyLines.push('<span style="font-size:10px;color:rgba(180,255,180,.85);">â–¶ '+reasonStr+'</span>');
  var body=bodyLines.join('<br>');
  pushState({showdown:{body:body,ch:ch,comm:comm},reveal:holes,waitFor:null});
}

function handleSD(sd){
  if(!sd)return;
  renderAll();
  showMsg('ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³',sd.body,'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){
    if(isHost){
      // checkEliminated ã‚’çµŒç”±ã—ã¦ãƒªãƒã‚¤å‡¦ç†ã—ã¦ã‹ã‚‰æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã¸
      checkEliminated(function(){ startRound(); });
    } else {
      _lastPhase=-1; _lastCommLen=0;
      showInfo('æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾…ã£ã¦ã„ã¾ã™...');
    }
  },sd.ch||'',sd.comm||comm);
}
function handleResult(rr){
  _dbg('handleResult gt='+rr.gameOver);
  if(!rr||!rr.title)return;
  renderAll();
  if(rr.gameOver){
    showMsg(rr.title,rr.body,'ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚‹',function(){
      hideInfo();
      document.getElementById('ap').style.display='none';
      window._pokerGoLobby();
    },rr.ch||'');
  } else {
    showMsg(rr.title,rr.body,'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰',function(){
      if(isHost){
        checkEliminated(function(){ startRound(); });
      } else {
        _lastPhase=-1; _lastCommLen=0;
        showInfo('æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾…ã£ã¦ã„ã¾ã™...');
      }
    },rr.ch||'',comm.length?comm:null);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAction(){
  _dbg('renderAction myIdx='+myIdx);
  hideInfo(); // CPUæ€è€ƒä¸­è¡¨ç¤ºã‚’ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢
  var p=players[myIdx];if(!p)return;
  document.getElementById('ap-who').textContent=p.name+' ã®ã‚¿ãƒ¼ãƒ³ï¼ˆã‚ãªãŸï¼‰';
  var toC=curBet-p.bet;
  document.getElementById('ap-info').innerHTML='<span style="opacity:.6">æ‰‹æŒã¡</span> '+p.chips+' &nbsp;<span style="opacity:.6">ã‚³ãƒ¼ãƒ«</span> '+Math.min(toC,p.chips);
  var h=myHole.length?myHole:p.hole;
  document.getElementById('hdisp').innerHTML=cH(h[0])+cH(h[1]);
  var minR=snap5(Math.min(curBet+lastRaise,p.chips+p.bet)), maxR=p.chips+p.bet;
  setupChipSelector(minR, maxR);
  var pr=document.getElementById('prow');pr.innerHTML='';
  [['1/3P',snap5(Math.round(pot/3))],['1/2P',snap5(Math.round(pot/2))],['POT',snap5(pot)],['2Ã—BB',snap5(BB*2)]].forEach(function(x){
    var b=document.createElement('button');b.className='pbtn';
    var v=Math.min(Math.max(x[1],minR),maxR);
    b.textContent=x[0]+'('+v+')';b.onclick=function(){setChipBet(v,minR,maxR);};
    pr.appendChild(b);
  });
  var br=document.getElementById('brow');br.innerHTML='';
  function ab(lbl,cls,fn){var b=document.createElement('button');b.className='ab '+cls;b.textContent=lbl;b.onclick=fn;br.appendChild(b);}
  ab('ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰','ab-fold',function(){send('fold',0);});
  var minRaise=curBet+lastRaise; // æœ€ä½ãƒ¬ã‚¤ã‚ºå¾Œã®ãƒ™ãƒƒãƒˆç·é¡
  var canRaise=(p.chips+p.bet)>minRaise && p.chips>toC; // ãƒ¬ã‚¤ã‚ºã«å¿…è¦ãªãƒãƒƒãƒ—ãŒè¶³ã‚Šã‚‹
  if(toC<=0){
    // ãƒã‚§ãƒƒã‚¯å¯èƒ½ï¼ˆã‚³ãƒ¼ãƒ«ä¸è¦ï¼‰
    ab('ãƒã‚§ãƒƒã‚¯','ab-check',function(){send('check',0);});
    if(canRaise) ab('ãƒ¬ã‚¤ã‚º','ab-raise',function(){send('raise',snap5(+document.getElementById('rinp').value||0));});
    if(p.chips>0) ab('ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ ('+p.chips+')','ab-allin',function(){send('allin',0);});
  } else if(toC>=p.chips){
    // ã‚³ãƒ¼ãƒ«é¡ãŒãƒãƒƒãƒ—å…¨é¡ä»¥ä¸Š â†’ ã‚³ãƒ¼ãƒ«ã®ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã‹ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ã‚³ãƒ¼ãƒ«ï¼‰
    ab('ã‚³ãƒ¼ãƒ«/ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³('+p.chips+')','ab-call',function(){send('allin',0);});
    // ãƒãƒƒãƒ—ãŒè¶³ã‚Šãªã„ã®ã§ãƒ¬ã‚¤ã‚ºãƒ»é€šå¸¸ã‚³ãƒ¼ãƒ«ä¸å¯
  } else {
    // é€šå¸¸ã‚³ãƒ¼ãƒ«
    ab('ã‚³ãƒ¼ãƒ«('+toC+')','ab-call',function(){send('call',0);});
    if(canRaise) ab('ãƒ¬ã‚¤ã‚º','ab-raise',function(){send('raise',snap5(+document.getElementById('rinp').value||0));});
    ab('ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ ('+p.chips+')','ab-allin',function(){send('allin',0);});
  }
}

function send(action,amount){
  if(offlineMode){sendOffline(action,amount);return;}
  document.getElementById('ap').style.display='none';
  var d={playerIdx:myIdx,action:action,amount:amount,ts:Date.now(),rid:_roundId};
  if(isHost){
    // ãƒ›ã‚¹ãƒˆã¯ç›´æ¥å‡¦ç†ï¼ˆFirebaseé€ä¿¡ãªã—ï¼‰â†’ã€Œé€ä¿¡ä¸­...ã€ä¸è¦
    hideInfo();
    lastActTs=d.ts;applyAction(d);renderAll();advance();
  } else {
    showInfo('é€ä¿¡ä¸­...');
    fbSet(gamePath+'/action',d);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æç”»
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  var area=document.getElementById('seats');area.innerHTML='';
  // apVisible ã‚’ forEach ã®å¤–ã§1å›ã ã‘å–å¾—ï¼ˆã‚·ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ä»˜ä¸ã‚ˆã‚Šå‰ï¼‰
  var apVisible = document.getElementById('ap').style.display !== 'none';
  players.forEach(function(p,i){
    if(p.eliminated){
      // è„±è½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è–„ãè¡¨ç¤º
      var s=document.createElement('div');s.className='seat';s.style.opacity='0.3';s.style.filter='grayscale(1)';
      s.innerHTML='<div class="sname">'+p.name+'</div><div style="font-family:Cinzel,serif;font-size:9px;color:#f88;letter-spacing:2px;margin-top:8px;">ELIMINATED</div>';
      area.appendChild(s); return;
    }
    if(!p.active)return;
    var s=document.createElement('div');s.className='seat';
    // apVisibleæ™‚ã¯è‡ªåˆ†ã‚·ãƒ¼ãƒˆã‚’myturnã«ï¼ˆcurIdxä¸å•ï¼‰
    if(apVisible && p.isMe){ s.classList.add('myturn'); }
    else if(i===curIdx && !apVisible){ s.classList.add(p.isMe?'myturn':'waiting'); }
    if(p.folded) s.classList.add('folded');
    if(i===dealerIdx) s.classList.add('dealer');
    // ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯:
    // - è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰: å¸¸ã«è¡¨å‘ã
    // - ALL INä¸­(rundownAllInå®Ÿè¡Œä¸­): å…¨å‚åŠ è€…è¡¨å‘ã
    // - CPU/ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ã‚·ãƒ§ãƒ¼ãƒ€ã‚¦ãƒ³(phase>=4)ã‹ã¤revealã•ã‚ŒãŸå ´åˆã®ã¿è¡¨å‘ã
    var h;
    if(p.isMe){ h=myHole.length?myHole:p.hole; }
    else if((phase>=4||_allInRevealed)&&!p.folded&&p.hole&&p.hole.length===2){ h=p.hole; }
    else { h=null; }
    var show=h&&h.length===2;
    var ch=show?(cH(h[0],true)+cH(h[1],true)):(cH(null,true)+cH(null,true));
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹è¡¨ç¤º
    var stHtml='';
    if(p.folded){
      stHtml='<div class="sst">FOLD</div>';
    } else if(p.allIn){
      s.classList.add('allin');
      stHtml='<div class="sst-allin">ğŸ”´ ALL IN</div>';
    } else if(p.isMe && apVisible){
      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ«è¡¨ç¤ºä¸­ã¯è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ç¢ºå®š
      s.classList.remove('waiting');
      s.classList.add('myturn');
      stHtml='<div class="sst" style="color:var(--gold-light);font-weight:700;">â–¶ ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³</div>';
    } else if(i===curIdx && !apVisible){
      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ«éè¡¨ç¤ºæ™‚ã®ã¿curIdxã‚’å‚ç…§
      if(p.isMe) stHtml='<div class="sst" style="color:var(--gold-light);font-weight:700;">â–¶ ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³</div>';
      else if(p.isCpu) stHtml='<div class="sst">è€ƒãˆä¸­...</div>';
      else stHtml='<div class="sst">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸­...</div>';
    } else {
      stHtml='<div class="sst"></div>';
    }
    var rebuyBadge = (p.rebuyCount&&p.rebuyCount>0)
      ? '<span style="font-size:7px;background:rgba(255,140,0,.25);border:1px solid rgba(255,140,0,.5);border-radius:4px;padding:1px 4px;color:#fa0;margin-left:4px;vertical-align:middle;">Ã—'+(p.rebuyCount+1)+'</span>'
      : '';
    s.innerHTML='<div class="sname">'+p.name+(p.isMe?' â­':'')+rebuyBadge+'</div>'+
      '<div class="schips">'+chipsHTML(p.chips)+'</div>'+
      '<div class="sbet">'+(p.bet?'<span style="font-size:9px">BET </span>'+chipsHTML(p.bet):'')+'</div>'+
      '<div class="scards">'+ch+'</div>'+
      stHtml;
    area.appendChild(s);
  });
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã¯comm-cardsã‚’ä¸Šæ›¸ãã—ãªã„ï¼ˆæ–°ã‚«ãƒ¼ãƒ‰ãŒè¡¨å‘ãã«ãªã‚‹ã®ã‚’é˜²ãï¼‰
  if(!_commAnimating){
    var cc=document.getElementById('comm-cards');cc.innerHTML='';
    for(var i=0;i<5;i++) cc.innerHTML+=i<comm.length?cH(comm[i]):cH(null);
  }
  document.getElementById('pot').innerHTML='<span style="opacity:.6;font-size:10px">POT </span>'+chipsHTML(pot);
  document.getElementById('phase').textContent=PNAMES[Math.min(phase,4)]||'SHOWDOWN';
}
function showInfo(m){_dbg('showInfo:'+m.substring(0,25));document.getElementById('ibar').classList.add('show');document.getElementById('ibar-t').textContent=m;}
function hideInfo(){document.getElementById('ibar').classList.remove('show');}
function showMsg(title,body,lbl,fn,ch,commCards){
  document.getElementById('mover').classList.add('show');
  // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã®ã¿ãƒ­ãƒ“ãƒ¼ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
  if(gamePath) document.getElementById('back-btn-wrap').style.display='block';
  document.getElementById('mtitle').textContent=title;
  document.getElementById('mbody').innerHTML=body;
  document.getElementById('mcards').innerHTML=ch||'';
  // ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
  var mcomm=document.getElementById('mcomm');
  if(commCards&&commCards.length){
    mcomm.style.display='flex';
    mcomm.innerHTML='<div style="width:100%;text-align:center;font-family:Cinzel,serif;font-size:9px;color:rgba(255,255,255,.4);letter-spacing:2px;margin-bottom:4px;">COMMUNITY CARDS</div>'
      +commCards.map(function(c){return cH(c,false,false);}).join('');
  } else {
    mcomm.style.display='none';
    mcomm.innerHTML='';
  }
  var btn=document.getElementById('mnext');btn.textContent=lbl;
  btn.onclick=function(){
    document.getElementById('mover').classList.remove('show');
    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ãŸã‚‰ãƒ­ãƒ“ãƒ¼ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«æˆ»ã™
    if(gamePath) document.getElementById('back-btn-wrap').style.display='none';
    fn();
  };
}


// â”€â”€ ãƒ‡ã‚£ãƒ¼ãƒ«æ¼”å‡º â”€â”€
function showDealOverlay(hole, cb){
  var ov = document.getElementById('deal-overlay');
  var row = document.getElementById('deal-cards-row');
  row.innerHTML = '';
  hole.forEach(function(c){
    var d = document.createElement('div');
    d.className = 'deal-card-anim';
    d.innerHTML = cH(c, false, true); // lg size
    row.appendChild(d);
  });
  ov.classList.add('show');
  setTimeout(function(){
    ov.classList.remove('show');
    if(cb) cb();
  }, 1800);
}

// â”€â”€ ãƒªãƒã‚¤å‡¦ç† â”€â”€
// åˆå›ãƒãƒƒãƒ—é‡ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹æ™‚ã«è¨­å®šã•ã‚ŒãŸé‡ï¼‰ã‚’è¨˜éŒ²
var _initialChips = 0;

function doRebuy(p){
  p.rebuyCount = (p.rebuyCount||0) + 1;
  p.chips = _initialChips;
  p.active = true;
  p.eliminated = false;
}

// â”€â”€ Eliminated ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰å¾Œï¼‰ â”€â”€
function checkEliminated(afterRoundCb){
  var eliminated = players.filter(function(p){ return p.active && p.chips < BB; });
  if(eliminated.length === 0){ afterRoundCb(); return; }

  // CPUãƒ»äººé–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å…¨å“¡ã¾ã¨ã‚ã¦é †ç•ªã«å‡¦ç†
  var idx = 0;
  function processNext(){
    if(idx >= eliminated.length){ renderAll(); afterRoundCb(); return; }
    var p = eliminated[idx++];
    var rebuyNum = (p.rebuyCount||0) + 1;
    var label = rebuyNum === 1 ? 'åˆå›è³¼å…¥' : 'è¿½åŠ è³¼å…¥ ' + rebuyNum + 'å›ç›®';
    var activeHumans = players.filter(function(q){ return q.active && !q.isCpu && q.idx !== p.idx; });
    var canContinue = activeHumans.length > 0 || players.filter(function(q){ return q.active; }).length > 1;

    // ãƒªãƒã‚¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
    var mover = document.getElementById('mover');
    var mtitle = document.getElementById('mtitle');
    var mbody = document.getElementById('mbody');
    var mcards = document.getElementById('mcards');
    var mcomm = document.getElementById('mcomm');
    var mnext = document.getElementById('mnext');
    mover.classList.add('show');
    mtitle.textContent = 'ğŸ’€ ãƒãƒƒãƒ—ä¸è¶³';
    mcards.innerHTML = '';
    mcomm.style.display = 'none';
    // ãƒªãƒã‚¤ãƒœã‚¿ãƒ³ã‚’å«ã‚€HTML
    var purchaseHistory = '';
    if((p.rebuyCount||0) > 0){
      purchaseHistory = '<div style="font-size:10px;color:rgba(255,200,100,.7);margin-top:6px;">ã“ã‚Œã¾ã§ã®è³¼å…¥: åˆå› + ' + p.rebuyCount + 'å›</div>';
    }
    // rebuyAmt ã‚’å…ˆã«ç¢ºå®šã•ã›ã‚‹
    var rebuyAmt = _initialChips || (players[0]?players[0].chipsBefore:500)||500;
    var roleLabel = p.isCpu ? 'ï¼ˆCPUï¼‰' : '';
    mbody.innerHTML = '<b style="color:var(--gold-light);">' + p.name + roleLabel + '</b> ã®ãƒãƒƒãƒ—ãŒä¸è¶³ã—ã¾ã—ãŸã€‚<br>' +
      '<span style="font-size:11px;color:rgba(255,255,255,.6);">' + label + ' ã¨ã—ã¦ ' + rebuyAmt + ' ãƒãƒƒãƒ—ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ</span>' +
      purchaseHistory;
    // 2ãƒœã‚¿ãƒ³: ãƒªãƒã‚¤ or è„±è½
    mnext.style.display = 'none';
    var btnWrap = document.getElementById('rebuy-btn-wrap');
    if(!btnWrap){
      btnWrap = document.createElement('div');
      btnWrap.id = 'rebuy-btn-wrap';
      btnWrap.style.cssText = 'display:flex;gap:10px;justify-content:center;margin-top:8px;';
      mnext.parentNode.insertBefore(btnWrap, mnext);
    }
    btnWrap.innerHTML = '';
    // ãƒªãƒã‚¤ãƒœã‚¿ãƒ³
    var btnRebuy = document.createElement('button');
    btnRebuy.className = 'mnext';
    btnRebuy.style.background = 'linear-gradient(135deg,#1a6a1a,#2ea02e)';
    btnRebuy.textContent = 'âœ… ãƒãƒƒãƒ—è³¼å…¥ (' + rebuyAmt + ')';
    btnRebuy.onclick = function(){
      if(!_initialChips) _initialChips=rebuyAmt;
      doRebuy(p);
      btnWrap.innerHTML = '';
      mnext.style.display = '';
      mover.classList.remove('show');
      processNext();
    };
    // è„±è½ãƒœã‚¿ãƒ³
    var btnElim = document.createElement('button');
    btnElim.className = 'mnext';
    btnElim.style.background = 'linear-gradient(135deg,#6a1a1a,#a02e2e)';
    btnElim.textContent = 'âŒ è„±è½ã™ã‚‹';
    btnElim.onclick = function(){
      p.active = false; p.eliminated = true;
      btnWrap.innerHTML = '';
      mnext.style.display = '';
      mover.classList.remove('show');
      // ç¶šè¡Œå¯èƒ½ã‹ç¢ºèª
      var stillActive = players.filter(function(q){ return q.active; });
      if(stillActive.length < 2){
        var winner = stillActive[0];
        var winMsg = winner ? '<span class="wn">'+winner.name+'</span>ã®å„ªå‹ï¼' : 'ã‚²ãƒ¼ãƒ çµ‚äº†';
        showMsg('ã‚²ãƒ¼ãƒ çµ‚äº†', winMsg, 'ãƒ­ãƒ“ãƒ¼ã¸', function(){
          document.getElementById('back-btn-wrap').style.display='none';
          showScreen('screen-lobby'); offlineMode=false;
        }, '');
        return;
      }
      processNext();
    };
    btnWrap.appendChild(btnRebuy);
    btnWrap.appendChild(btnElim);
  }
  processNext();
}

// â”€â”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ–ãƒ«è¡¨ç¤º â”€â”€
var ACTION_LABELS={fold:'FOLD',check:'CHECK',call:'CALL',raise:'RAISE',allin:'ALL IN'};
var ACTION_CLS={fold:'ab-fold',check:'ab-check',call:'ab-call',raise:'ab-raise',allin:'ab-allin'};
function showActionBubble(playerIdx, action, amount){
  // åº§å¸­DOMã‚’å–å¾—
  var seats=document.querySelectorAll('.seat');
  var active=players.filter(function(p){return p.active;});
  var si=active.findIndex(function(p){return p.idx===playerIdx;});
  if(si<0||si>=seats.length) return;
  var seat=seats[si];
  // å¤ã„ãƒãƒ–ãƒ«ã‚’é™¤å»
  var old=seat.querySelector('.action-bubble'); if(old) old.remove();
  var lbl=ACTION_LABELS[action]||action.toUpperCase();
  if(action==='raise'&&amount) lbl='RAISE '+amount;
  if(action==='call'){var p=players[playerIdx];if(p)lbl='CALL '+Math.min(curBet-p.bet+amount,p.chips||0);}
  var b=document.createElement('div');
  b.className='action-bubble '+(ACTION_CLS[action]||'');
  b.textContent=lbl;
  seat.style.position='relative';
  seat.appendChild(b);
  setTimeout(function(){if(b.parentNode)b.remove();},2200);
}

// â”€â”€ ãƒ•ã‚§ãƒ¼ã‚ºç§»è¡Œã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â”€â”€
var PHASE_LABELS=['PRE-FLOP','FLOP','TURN','RIVER','SHOWDOWN'];
function showPhaseOverlay(phaseName, newCards, cb){
  var ov=document.getElementById('phase-overlay');
  var pn=document.getElementById('phase-name');
  var cr=document.getElementById('phase-cards-row');
  pn.textContent=phaseName;
  cr.innerHTML='';

  // ã‚«ãƒ¼ãƒ‰ã‚’è£å‘ãã§ä¸¦ã¹ã¦ã‹ã‚‰1æšãšã¤ãƒ•ãƒªãƒƒãƒ—
  var cardInners=[];
  if(newCards&&newCards.length){
    newCards.forEach(function(c){
      var wrap=document.createElement('div');
      wrap.className='comm-card-wrap';
      var inner=document.createElement('div');
      inner.className='comm-card-inner'; // åˆæœŸ: è£å‘ã
      // è¡¨é¢
      var face=document.createElement('div');
      face.className='comm-card-face';
      face.innerHTML=cH(c,false,false);
      // è£é¢
      var back=document.createElement('div');
      back.className='comm-card-back';
      back.innerHTML=cH(null,false,false);
      inner.appendChild(face);
      inner.appendChild(back);
      // innerã®ã‚µã‚¤ã‚ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¼ãƒ‰(44Ã—64)ã«åˆã‚ã›ã‚‹
      inner.style.cssText='position:relative;transform-style:preserve-3d;transition:transform .8s ease;transform:rotateY(-180deg);width:44px;height:64px;';
      face.style.cssText='position:absolute;top:0;left:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;';
      back.style.cssText='position:absolute;top:0;left:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;transform:rotateY(180deg);';
      wrap.style.cssText='perspective:800px;';
      wrap.appendChild(inner);
      cr.appendChild(wrap);
      cardInners.push(inner);
    });
  }

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹: å ´ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¸Šæ›¸ãã—ãªã„ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ON
  // ã¾ãšå ´ã®ã‚«ãƒ¼ãƒ‰ã‚’ã€Œæ–°ã‚«ãƒ¼ãƒ‰ã¯è£å‘ãã€æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã¯ãã®ã¾ã¾ã€ã§æç”»
  _commAnimating=true;
  _renderCommWithBackCards(newCards);

  ov.classList.add('show');

  // 150mså¾Œã‹ã‚‰1æšãšã¤180msãŠãã«ãƒ•ãƒªãƒƒãƒ—
  cardInners.forEach(function(inner, i){
    setTimeout(function(){ inner.style.transform='rotateY(0deg)'; }, 250 + i*320);
  });

  // å…¨ã‚«ãƒ¼ãƒ‰ãƒ•ãƒªãƒƒãƒ—å¾Œã«å°‘ã—è¦‹ã›ã¦ã‹ã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã¦cb
  var flipDone = 250 + cardInners.length*320 + 1200;
  var total = Math.max(flipDone, 1800);
  setTimeout(function(){
    ov.classList.remove('show');
    // ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®comm-cardsã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§æ›´æ–°
    _animateCommCards(newCards, function(){
      _commAnimating=false;
      if(cb) cb();
    });
  }, total);
}

// ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºä¸­: æ–°ã‚«ãƒ¼ãƒ‰ã ã‘è£å‘ãã§å ´ã«ç½®ã
function _renderCommWithBackCards(newCards){
  var cc=document.getElementById('comm-cards');
  cc.innerHTML='';
  var existingCount=comm.length-(newCards?newCards.length:0);
  // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã¯ãã®ã¾ã¾è¡¨å‘ãã§è¡¨ç¤º
  for(var i=0;i<existingCount;i++){
    if(comm[i]) cc.innerHTML+=cH(comm[i]);
  }
  // æ–°ã‚«ãƒ¼ãƒ‰ã¯è£å‘ãã§è¡¨ç¤ºï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ãƒ•ãƒªãƒƒãƒ—ãŒçµ‚ã‚ã‚‹ã¾ã§ï¼‰
  if(newCards&&newCards.length){
    newCards.forEach(function(){
      cc.innerHTML+=cH(null); // è£å‘ã
    });
  }
  // æ®‹ã‚Šã‚¹ãƒ­ãƒƒãƒˆ
  var shown=existingCount+(newCards?newCards.length:0);
  for(var j=shown;j<5;j++) cc.innerHTML+=cH(null);
}

// ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§å†æç”»
function _animateCommCards(newCards, cb){
  var cc=document.getElementById('comm-cards');
  var existingCount=comm.length-(newCards?newCards.length:0);
  cc.innerHTML='';
  // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼‰
  for(var i=0;i<existingCount;i++){
    if(comm[i]) cc.innerHTML+=cH(comm[i]);
  }
  // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³+ãƒ•ãƒªãƒƒãƒ—ï¼‰
  if(newCards&&newCards.length){
    newCards.forEach(function(c, ni){
      var span=document.createElement('span');
      span.style.cssText='display:inline-block;opacity:0;animation:commSlideIn .65s ease '+(ni*280)+'ms forwards;';
      span.innerHTML=cH(c);
      cc.appendChild(span);
    });
  }
  // æ®‹ã‚Šã®ç©ºã‚¹ãƒ­ãƒƒãƒˆ
  var shown=existingCount+(newCards?newCards.length:0);
  for(var j=shown;j<5;j++) cc.innerHTML+=cH(null);
  var delay=newCards?(newCards.length*280+650):0;
  setTimeout(function(){ if(cb) cb(); }, delay);
}

function showScreen(id){
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById(id).classList.add('active');
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒœã‚¿ãƒ³ã®onclickã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ï¼‰
window._pokerShowScreen = showScreen;
window._pokerGoLobby = function(){
  document.getElementById('back-btn-wrap').style.display='none';
  // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®Firebaseãƒªã‚¹ãƒŠãƒ¼ã‚’åœæ­¢
  if(gamePath){
    fbOff(gamePath+'/state');
    fbOff(gamePath+'/action');
    if(myId) fbOff(holePfx+myId);
  }
  // é›¢è„±ã‚’Firebaseã«è¨˜éŒ²ï¼ˆãƒ›ã‚¹ãƒˆãªã‚‰ room status ã‚’ resetï¼‰
  if(isHost && roomPath){
    fbPatch(roomPath, {status:'lobby'}, function(){});
  } else if(roomPath && myId){
    // éãƒ›ã‚¹ãƒˆ: è‡ªåˆ†ã®å‚åŠ æƒ…å ±ã‚’å‰Šé™¤
    fbSet(roomPath+'/players/'+myId, null, function(){});
  }
  // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
  _hostWatchActive=false;
  _hostLeftDetected=false;
  _stateEverReceived=false;
  _nullStateCount=0;
  gamePath=''; holePfx=''; roomPath=''; isHost=false;
  offlineMode=false;
  players=[]; myHole=[]; _initialChips=0;
  showScreen('screen-lobby');
};

})();
</script>

<div id="confirm-overlay">
  <div id="confirm-box">
    <div id="confirm-msg">ã‚²ãƒ¼ãƒ ã‚’ä¸­æ–­ã—ã¦<br>ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ<br><small style="color:rgba(255,150,150,.8);font-size:10px;">â€»é€”ä¸­é€€å‡ºã™ã‚‹ã¨ã‚²ãƒ¼ãƒ ãŒä¸­æ–­ã•ã‚Œã¾ã™</small></div>
    <div id="confirm-btns">
      <button id="confirm-yes" onclick="document.getElementById('confirm-overlay').classList.remove('show');window._pokerGoLobby();">æˆ»ã‚‹</button>
      <button id="confirm-no" onclick="document.getElementById('confirm-overlay').classList.remove('show');">ç¶šã‘ã‚‹</button>
    </div>
  </div>
</div>
</body>
</html>
